<!DOCTYPE html>
<html lang="en-IE">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer Dashboard - Account</title>
  
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>

  <meta http-equiv="Cache-Control" content="no-store" />

  <style>
    :root{
      --cream:#f6f1e7;
      --cream-2:#f3e9d8;
      --text:#2b2723;
      --muted:#7c6f63;
      --card:#ffffff;

      --gold:#D4AF37;
      --gold-soft: rgba(212,175,55,.55);

      --border:#e0d5c2;
      --shadow:0 18px 42px rgba(0,0,0,.32);
      --radius:22px;

      --btn-bg: rgba(255,255,255,.88);
      --btn-text: #3b2206;

      --bronze:#cd7f32;
      --silver:#c0c0c0;
      --gold2:#D4AF37;
    }

    *{ box-sizing:border-box; }
    html{ scroll-behavior:smooth; }
    body{
      margin:0;
      font-family: Poppins, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: linear-gradient(135deg,#fdf4e3,#f1dfc2,#e3c395);
      color: var(--text);
      min-height: 100dvh;
      padding: 22px 10px 40px;
    }

    /* Fundo reativo */
    #reactiveField{ position:fixed; inset:0; z-index:0; pointer-events:none; }

    .wrap{
      position:relative; z-index:1;
      max-width: 1100px;
      margin: 0 auto;
    }

    .glass{
      background: linear-gradient(135deg,rgba(253,244,227,0.10),rgba(241,223,194,0.08),rgba(227,195,149,0.14));
      backdrop-filter: saturate(120%) blur(6px);
      -webkit-backdrop-filter: saturate(120%) blur(6px);
      border:1px solid rgba(212,175,55,.55);
      border-radius: 28px;
      box-shadow: var(--shadow), 0 0 26px rgba(212,175,55,.22);
    }

    header{
      padding: 16px 18px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .top-left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 180px;
    }
    .top-left small{
      color: var(--muted);
      font-weight: 700;
      letter-spacing:.04em;
    }

    .btn{
      appearance:none;
      border:1px solid var(--gold-soft);
      background: var(--btn-bg);
      color: var(--btn-text);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,.10);
      transition: transform .15s ease, filter .15s ease, background .15s ease, border-color .15s ease;
      text-decoration:none;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      filter: brightness(1.03);
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.95), transparent 60%),
        linear-gradient(120deg, rgba(212,175,55,.22), rgba(240,180,59,.22));
      border-color: rgba(212,175,55,.75);
    }
    .btn:active{ transform: translateY(0); filter: brightness(.99); }
    .btn.small{ padding: 8px 12px; font-weight: 900; }
    .btn.primary{
      background: linear-gradient(120deg, rgba(212,175,55,.25), rgba(240,180,59,.25));
    }
    .btn.danger{
      border-color: rgba(179,59,46,.35);
      color: #7a1f16;
    }

    .divider{
      height:2px;
      background: linear-gradient(90deg, transparent, rgba(212,175,55,.95), transparent);
      border-radius: 999px;
      box-shadow: 0 10px 22px rgba(212,175,55,.20);
      margin: 0 18px;
    }

    /* "Landing" */
    .page{
      padding: 14px;
    }

    .hero{
      padding: 16px;
      border-radius: var(--radius);
    }

    .hero-center{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
      text-align:center;
      padding: 10px 10px 6px;
    }

    .hero-title{
      margin:0;
      font-family: Orbitron, Poppins, system-ui, sans-serif;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size: 20px;
    }

    .avatar-wrap{
      width: 160px; height: 160px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.92), rgba(255,255,255,.55));
      border: 2px solid rgba(212,175,55,.92);
      box-shadow: 0 18px 40px rgba(0,0,0,.18), 0 0 20px rgba(212,175,55,.18);
      display:flex; align-items:center; justify-content:center;
      position: relative;
      overflow:hidden;
    }
    .avatar-wrap img{
      width: 144px; height: 144px;
      border-radius: 999px;
      object-fit: cover;
      display:block;
      background: linear-gradient(135deg, rgba(212,175,55,.20), rgba(240,180,59,.15));
      border: 1px solid rgba(0,0,0,.05);
    }

    .name{
      margin: 0;
      font-weight: 900;
      font-size: 18px;
    }
    .sub{
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    /* Barra de n√≠vel (3 n√≠veis) */
    .level-wrap{
      width: min(520px, 94%);
      margin-top: 2px;
    }

    .level-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.76);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      font-weight: 900;
      letter-spacing:.06em;
      text-transform: uppercase;
      color: #3b2206;
    }

    .badge-dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--bronze);
      box-shadow: 0 0 0 4px rgba(205,127,50,.12);
    }

    .level-bar{
      height: 14px;
      border-radius: 999px;
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.06);
      overflow:hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.08);
      position:relative;
    }
    .level-fill{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(205,127,50,.95), rgba(205,127,50,.78));
      transition: width .35s ease, filter .35s ease;
    }
    .level-splits{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top: 8px;
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 11px;
      color: var(--muted);
    }
    .level-splits span{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .level-splits i{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.10);
      display:inline-block;
    }
    .level-splits .on{ color: var(--text); }
    .level-splits .on i{ background: var(--bronze); }
    .level-splits .on.silver i{ background: var(--silver); }
    .level-splits .on.gold i{ background: var(--gold2); }

    /* Navega√ß√£o (topo abaixo do hero) */
    .nav{
      margin: 14px auto 0;
      width: min(900px, 100%);
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:center;
    }
    .nav .btn{ font-weight: 900; }

    /* Cards */
    .grid{
      width: min(980px, 100%);
      margin: 14px auto 0;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
    }

    /* Form grid (used inside cards) */
    .form-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 640px){
      .form-grid{ grid-template-columns: 1fr; }
    }


    .card{
      border: 1px solid rgba(224,213,194,.9);
      background: rgba(255,255,255,.78);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .muted{ color: var(--muted); }

    .stat{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-height: 72px;
    }
    .stat .k{
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 900;
    }
    .stat .v{
      font-size: 22px;
      font-weight: 900;
      line-height: 1.1;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.02);
      border: 1px solid rgba(0,0,0,.06);
      color: var(--muted);
      font-weight: 800;
      font-size: 12px;
    }
    .pill strong{ color: var(--text); }

    /* Wheel (sempre vis√≠vel) */
.wheel-area{
  width: min(980px, 100%);
  margin: 12px auto 0;
}

.wheel-stack{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 12px;
  margin-top: 10px;
  text-align:center;
}

.wheel-box{
  position:relative;
  width: min(340px, 82vw);
  aspect-ratio: 1 / 1;
  margin: 0 auto;
}

.wheel-rotate{
  width:100%;
  height:100%;
  border-radius: 999px;
  overflow:hidden;
  box-shadow: 0 22px 60px rgba(0,0,0,.16), 0 0 20px rgba(212,175,55,.12);
  border: 2px solid rgba(212,175,55,.85);
  background: rgba(255,255,255,.35);
  transform: rotate(0deg);
}

.wheel-box::after{
  content:"";
  position:absolute;
  inset: 20%;
  border-radius: 999px;
  background: rgba(255,255,255,.70);
  border: 1px solid rgba(0,0,0,.06);
  box-shadow: inset 0 4px 18px rgba(0,0,0,.10);
  pointer-events:none;
  z-index: 2;
}

#wheelCanvas{
  width:100%;
  height:100%;
  display:block;
  position:relative;
  z-index: 1;
}

.pointer{
  position:absolute;
  top: -12px;
  left: 50%;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 14px solid transparent;
  border-right: 14px solid transparent;
  border-bottom: 22px solid rgba(255,122,26,.92);
  filter: drop-shadow(0 8px 14px rgba(0,0,0,.18));
  z-index: 3;
  pointer-events:none;
}

.wheel-instructions{
  max-width: 680px;
  line-height: 1.7;
}

    /* Se√ß√µes */
    section{
      width: min(980px, 100%);
      margin: 14px auto 0;
      scroll-margin-top: 90px;
    }
    .section-title{
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .04em;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin: 10px 0;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .field input, .field textarea, .field select{
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(212,175,55,.55);
      background: rgba(255,255,255,.92);
      outline:none;
      font-weight: 600;
      resize: vertical;
    }
    .field textarea{ border-radius: 18px; min-height: 88px; }

    /* Orders - barra de processo */
    .stepper{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      align-items:center;
    }
    .step{
      text-align:center;
      font-weight: 900;
      font-size: 11px;
      letter-spacing:.08em;
      text-transform: uppercase;
      color: var(--muted);
      position:relative;
      padding-top: 18px;
    }
    .step::before{
      content:"";
      position:absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(0,0,0,.08);
    }
    .step.done{ color: var(--text); }
    .step.done::before{
      background: linear-gradient(120deg, rgba(212,175,55,.95), rgba(240,180,59,.95));
      border-color: rgba(212,175,55,.8);
      box-shadow: 0 0 0 4px rgba(212,175,55,.14);
    }
    .stepper-line{
      height: 10px;
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 999px;
      overflow:hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.08);
    }
    .stepper-line span{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(212,175,55,.9), rgba(240,180,59,.9));
    }

    /* Lista simples */
    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    footer{
      margin-top: 16px;
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      padding-bottom: 6px;
    }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <canvas id="reactiveField" aria-hidden="true"></canvas>

  <div class="wrap">
    <div class="glass">
            <header>
        <div class="top-left">
          <small></small>
        </div>
      </header>


      <div class="divider"></div>

      <div class="page">
        <!-- HERO -->
        <div class="hero glass">
          <div class="hero-center">
            <h1 class="hero-title">Customer Dashboard</h1>


            <!-- Nav buttons -->
            <div class="nav" aria-label="Shortcuts">
              <a class="btn small" href="painel.html">üè† Dashboard</a>
              <a class="btn small" href="index.html">üõçÔ∏è Shop</a>
              <a class="btn small primary" href="conta.html">üë§ Account</a>
              <a class="btn small" href="carrinho.html">üõí My cart</a>
              <a class="btn small" href="pedidos.html">üì¶ Orders</a>
            </div>
            <div class="avatar-wrap" aria-label="Profile photo (circular)">
              <img id="avatar" alt="User photo" />
            </div>

            <p class="name" id="userName">Your Name</p>
            <p class="sub" id="userEmail">email@example.com</p>

            <!-- Barra de n√≠vel -->
            <div class="level-wrap" aria-label="Customer level">
              <div class="level-head">
                <div class="badge"><span class="badge-dot" id="levelDot"></span> <span id="levelLabel">Bronze</span></div>
                <span class="pill"><strong id="levelProgressText">‚Ç¨0</strong> this month</span>
              </div>

              <div class="level-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                <div class="level-fill" id="levelFill"></div>
              </div>

              <div class="level-splits" aria-label="Bronze, Silver and Gold">
                <span id="lvlBronze" class="on"><i></i> Bronze</span>
                <span id="lvlSilver"><i></i> Silver</span>
                <span id="lvlGold"><i></i> Gold</span>
              </div>
              <div class="muted" style="margin-top:8px; font-weight:700;" id="levelHint">Fill the bar to level up.</div>
            </div>


          </div>
        </div>

        <!-- CONTA -->
        <section id="conta">
          <h2 class="section-title">Account</h2>

          <div class="grid">
            <div class="card">
              <div class="row">
                <strong>Details</strong>
                <span class="pill">All your account details</span>
              </div>

              <div class="field">
                <label for="accName">Name</label>
                <input id="accName" placeholder="Your name" />
              </div>

              <div class="field">
                <label for="accEmail">Email</label>
                <input id="accEmail" placeholder="email@example.com" />
              </div>

              <div class="field">
                <label for="accPhone">Phone</label>
                <input id="accPhone" placeholder="+353 ..." />
              </div>

              <div class="row" style="margin-top:10px;">
                <button class="btn small" id="btnPickAvatar">üì∑ Add photo</button>
                <span class="pill" id="avatarFileName"><strong>‚Äî</strong></span>
              </div>

              <div class="row" style="margin-top:12px;">
                <button class="btn primary" id="btnSaveAccount">Save changes</button>
                <button class="btn danger" id="btnLogout">Log out</button>
              </div>
              <div class="muted" style="margin-top:10px; font-weight:700;" id="accountMsg">‚Äî</div>


            </div>

            <div class="card">
              <div class="row">
                <strong>Address</strong>
                <span class="pill">Country: Ireland</span>
              </div>

            <div class="form-grid" style="margin-top:10px;">
              <div class="field">
                <label>Eircode</label>
                <input id="addrEircode" placeholder="D02 X285" />
              </div>
              <div class="field">
                <label>County</label>
                <input id="addrCounty" placeholder="Dublin" />
              </div>
            </div>

            <div class="form-grid">
              <div class="field">
                <label>City</label>
                <input id="addrCity" placeholder="Dublin" />
              </div>
              <div class="field">
                <label>Street & number</label>
                <input id="addrStreet" placeholder="1 Example Street" />
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn primary" id="btnSaveAddress">Save address</button>
              <span class="pill"><strong>Country:</strong> Ireland</span>
            </div>

            <div class="muted" style="margin-top:10px; font-weight:700;" id="addrMsg">‚Äî</div>
          </div>
          </div>

        </section>

        <footer>¬© <span id="year"></span> Vintage Wear Ireland</footer>
      </div>
    </div>
  </div>

  <input id="avatarFileInput" type="file" accept="image/*" class="hidden" />
  <script src="vintage-auth.js"></script>
  <script src="auth-guard.js"></script>
  <script>
  const API_ROOT = "https://auth.vintage-clothes.ie";
const REWARDS_ROOT = "https://clientes.vintage-clothes.ie";


function requireTokenOrRedirect(){
  return (window.VintageAuth && typeof window.VintageAuth.requireTokenOrRedirect === "function")
    ? window.VintageAuth.requireTokenOrRedirect()
    : null;
}

function authHeaders(extra){
  return (window.VintageAuth && typeof window.VintageAuth.authHeaders === "function")
    ? window.VintageAuth.authHeaders(extra)
    : (extra || {});
}


    async function apiJson(path, opts = {}){
      let p = String(path || '');
      if (!p.startsWith('/')) p = '/' + p;

      const isRewards = (
        p.startsWith('/rewards/') ||
        p.startsWith('/checkout/')
      );

      const base = isRewards ? REWARDS_ROOT : API_ROOT;
      const url = base + p;

      const init = {
        method: opts.method || 'GET',
        credentials: 'include', // envia cookies HttpOnly (vw_token)
        headers: authHeaders({ 'Content-Type': 'application/json', ...(opts.headers||{}) }),
      };

      if (opts.body !== undefined){
        init.body = (typeof opts.body === 'string') ? opts.body : JSON.stringify(opts.body);
      }

      const res = await fetch(url, init);

      if (res.status === 401 || res.status === 403){
        if (!isRewards) requireTokenOrRedirect();
        throw new Error('unauthorized');
      }

      const text = await res.text();
      let data = null;
      try{ data = text ? JSON.parse(text) : null; } catch(_){ data = text; }
      if (!res.ok){
        const msg = (data && (data.error || data.message)) || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    }

    function syncPointsUI(points){
      const p = document.getElementById('pointsNow');
      if (p) p.textContent = String(points ?? 0);
      const cash = document.getElementById('cashValue');
      if (cash){
        const eur = (Number(points||0) * 0.5);
        cash.textContent = '= ‚Ç¨ ' + eur.toFixed(2);
      }

    function determineLevel(spentTotal){
      const v = Number(spentTotal) || 0;
      if (v >= 800){
        return {
          key:'GOLD',
          label:'Gold',
          dot:'var(--gold2)',
          fill:['rgba(212,175,55,.95)','rgba(240,180,59,.95)'],
          hint: v >= 1200
            ? 'Gold completed. +300 pts earned.'
            : `‚Ç¨${Math.max(0, 1200 - v).toFixed(0)} to complete Gold (target ‚Ç¨1200) and earn +300 pts.`,
        };
      }
      if (v >= 300){
        return {
          key:'SILVER',
          label:'Silver',
          dot:'var(--silver)',
          fill:['rgba(192,192,192,.95)','rgba(192,192,192,.75)'],
          hint: `‚Ç¨${Math.max(0, 800 - v).toFixed(0)} to reach Gold (target ‚Ç¨800).`,
        };
      }
      return {
        key:'BRONZE',
        label:'Bronze',
        dot:'var(--bronze)',
        fill:['rgba(205,127,50,.95)','rgba(205,127,50,.78)'],
        hint: `‚Ç¨${Math.max(0, 300 - v).toFixed(0)} to reach Silver (target ‚Ç¨300).`,
      };
    }

    function levelProgress(spentTotal){
      const v = Number(spentTotal) || 0;
      if (v >= 800){
        const pct = v >= 1200 ? 100 : ((v - 800) / (1200 - 800)) * 100;
        return { pct, text: `‚Ç¨${v.toFixed(0)} spent` };
      }
      if (v >= 300){
        return { pct: ((v - 300) / (800 - 300)) * 100, text: `‚Ç¨${v.toFixed(0)} spent` };
      }
      return { pct: (v / 300) * 100, text: `‚Ç¨${v.toFixed(0)} spent` };
    }

    function syncLevelUI(spentTotal){
      const lvl = determineLevel(spentTotal);
      const prog = levelProgress(spentTotal);

      const label = document.getElementById('levelLabel');
      if (label) label.textContent = lvl.label;

      const dot = document.getElementById('levelDot');
      if (dot){
        dot.style.background = lvl.dot;
        dot.style.boxShadow = `0 0 0 4px rgba(0,0,0,.08)`;
      }

      const fill = document.getElementById('levelFill');
      if (fill){
        fill.style.width = Math.max(0, Math.min(100, prog.pct)) + '%';
        fill.style.background = `linear-gradient(90deg, ${lvl.fill[0]}, ${lvl.fill[1]})`;
      }

      const progText = document.getElementById('levelProgressText');
      if (progText) progText.textContent = prog.text;

      const hint = document.getElementById('levelHint');
      if (hint) hint.textContent = lvl.hint;

      // highlight splits
      document.getElementById('lvlBronze')?.classList.add('on');
      document.getElementById('lvlSilver')?.classList.remove('on','silver');
      document.getElementById('lvlGold')?.classList.remove('on','gold');

      if (lvl.key === 'SILVER'){
        document.getElementById('lvlSilver')?.classList.add('on','silver');
      } else if (lvl.key === 'GOLD'){
        document.getElementById('lvlSilver')?.classList.add('on','silver');
        document.getElementById('lvlGold')?.classList.add('on','gold');
      }
    }
    

    }

    async function loadRewardsStatus(){
      try{
        const data = await apiJson('/rewards/status', { method:'GET' });
        const points = Number(data?.points ?? data?.user?.points ?? 0);
        syncPointsUI(points);
        
        const spentTotal = Number(data?.spentTotal ?? data?.spent_total ?? data?.user?.spentTotal ?? data?.user?.spent_total ?? 0) || 0;
        syncLevelUI(spentTotal);
return data;
      } catch(err){
        console.warn('Rewards status not loaded:', err?.message || err);
        return null;
      }
    }

    window.VW_API = window.VW_API || {};
    window.VW_API.root = API_ROOT;
    window.VW_API.apiJson = apiJson;
    window.VW_API.loadRewardsStatus = loadRewardsStatus;
    window.VW_API.applyPoints = (points) => apiJson('/rewards/apply-points', { method:'POST', body:{ points } });
    window.VW_API.applyDiscount = () => apiJson('/rewards/apply-discount', { method:'POST', body:{} });
    window.VW_API.grantDiscount = (percent) => apiJson('/rewards/grant-discount', { method:'POST', body:{ percent } });
    window.VW_API.creditPoints = (points, source='wheel') => apiJson('/rewards/credit-points', { method:'POST', body:{ points, source } });
    window.VW_API.checkoutCreate = (payload) => apiJson('/checkout/create', { method:'POST', body: payload || {} });


    function defaultAvatarDataUri() {
      const svg = encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="240" height="240" viewBox="0 0 240 240">
          <defs>
            <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
              <stop stop-color="#D4AF37" stop-opacity="0.35"/>
              <stop stop-color="#f0b43b" stop-opacity="0.18" offset="1"/>
            </linearGradient>
          </defs>
          <rect width="240" height="240" rx="120" fill="url(#g)"/>
          <circle cx="120" cy="92" r="44" fill="rgba(43,39,35,0.16)"/>
          <path d="M48 212c14-46 50-68 72-68s58 22 72 68" fill="rgba(43,39,35,0.14)"/>
        </svg>
      `);
      return `data:image/svg+xml;charset=utf-8,${svg}`;
    }

    let currentUser = null;
    let currentAddress = null;

    function $(id) { return document.getElementById(id); }


    const USER_CACHE_KEY = 'vw_user_cache';
    const ADDR_CACHE_KEY = 'vw_address_cache';

   function readCache(key){
  try{
    const store = (key === USER_CACHE_KEY) ? sessionStorage : localStorage;
    const raw = store.getItem(key);
    if (raw) return JSON.parse(raw);

    if (key === USER_CACHE_KEY){
      return (window.VintageAuth && typeof window.VintageAuth.getLoggedUser==='function')
        ? (window.VintageAuth.getLoggedUser()?.user || null)
        : null;
    }
    return null;
  }catch(_){ return null; }
}

function writeCache(key, value){
  try{
    const store = (key === USER_CACHE_KEY) ? sessionStorage : localStorage;
    store.setItem(key, JSON.stringify(value || {}));
  }catch(_){ }
}

function normalizeUser(raw){
      if (!raw) return {};
      return raw.user || raw.data || raw.profile || raw.account || raw;
    }

    function pickName(u){
      return u.name || u.fullName || u.fullname || u.username || u.userName || '';
    }

    function pickEmail(u){
      return u.email || u.mail || u.userEmail || '';
    }

    function pickPhone(u){
      return u.phone || u.telefone || u.mobile || u.cellphone || '';
    }

    function pickAvatar(u){
      return u.avatar_url || u.avatarUrl || u.avatar || u.photo_url || u.photo || '';
    }

   function fillProfileUI() {
  const u = normalizeUser(currentUser) || {};
  const name = pickName(u) || 'Your Name';
  const email = pickEmail(u) || 'email@example.com';
  const phone = pickPhone(u) || '';
  const avatarUrl = pickAvatar(u) || '';

  if (document.getElementById('userName'))
    document.getElementById('userName').textContent = name;

  if (document.getElementById('userEmail'))
    document.getElementById('userEmail').textContent = email;

  if (document.getElementById('accName'))
    document.getElementById('accName').value = name === 'Your Name' ? '' : name;

  if (document.getElementById('accEmail'))
    document.getElementById('accEmail').value = email === 'email@example.com' ? '' : email;

  if (document.getElementById('accPhone'))
    document.getElementById('accPhone').value = phone;

  const avatar = document.getElementById('avatar');
  if (avatar) {
    if (avatarUrl && avatarUrl.length > 0) {
      if (avatarUrl.startsWith('http')) {
        avatar.src = avatarUrl;
      } else {
        avatar.src = API_ROOT + avatarUrl;
      }
    } else {
      avatar.src = defaultAvatarDataUri();
    }
  }
}




  
    function fillAddressUI() {
      const a = currentAddress || {};
      if (document.getElementById("addrEircode")) document.getElementById("addrEircode").value = a.eircode || "";
      if (document.getElementById("addrCounty")) document.getElementById("addrCounty").value = a.county || "";
      if (document.getElementById("addrCity")) document.getElementById("addrCity").value = a.city || "";
      if (document.getElementById("addrStreet")) document.getElementById("addrStreet").value = a.street || "";
    }

    async function loadProfile() {
      try {
        const res = await fetch(API_ROOT + "/user/me", {
  credentials: "include",
  headers: authHeaders()
});
        if (!res.ok) {
          console.warn('Falha ao carregar /user/me:', res.status);
          const cached = readCache(USER_CACHE_KEY);
          if (cached) { currentUser = cached; fillProfileUI(); }
          return;
        }
        const data = await res.json();
        currentUser = data || {};
        writeCache(USER_CACHE_KEY, currentUser);
        fillProfileUI();
      } catch (err) {
        console.error('Erro carregando /user/me', err);
        const cached = readCache(USER_CACHE_KEY);
        if (cached) { currentUser = cached; fillProfileUI(); }
      }
    }

    async function loadSettings() {
      try {
       const res = await fetch(API_ROOT + "/user/settings", {
  credentials: "include",
  headers: authHeaders()
});
          if (!res.ok) {
          console.warn('Falha ao carregar /user/settings:', res.status);
          const cached = readCache(ADDR_CACHE_KEY);
          if (cached) { currentAddress = cached; fillAddressUI(); }
          return;
        }
        const data = await res.json();
        const addr = (data && data.address) || {};
        currentAddress = {
          eircode: addr.eircode || "",
          county: addr.county || "",
          city: addr.city || "",
          street: addr.street || "",
          country: addr.country || "Ireland"
        };
        writeCache(ADDR_CACHE_KEY, currentAddress);
        fillAddressUI();
      } catch (err) {
        console.error('Erro carregando /user/settings', err);
        const cached = readCache(ADDR_CACHE_KEY);
        if (cached) { currentAddress = cached; fillAddressUI(); }
      }
    }

   async function saveAccount() {
  const name = document.getElementById("accName")?.value.trim() || "";
  const email = document.getElementById("accEmail")?.value.trim() || "";
  const phone = document.getElementById("accPhone")?.value.trim() || "";
  const msgEl = document.getElementById("accountMsg");
  if (msgEl) msgEl.textContent = "Saving changes‚Ä¶";

  const data = { name, email, phone };

  try {
    const res = await fetch(API_ROOT + "/user/me/profile", {
      method: "POST",
      credentials: "include",
      headers: authHeaders({ "Content-Type": "application/json" }),
      body: JSON.stringify(data)
    });

    if (res.status === 401 || res.status === 403) {
      requireTokenOrRedirect();
      return;
    }

    if (!res.ok) {
      throw new Error("Erro ao salvar");
    }

    currentUser = currentUser || {};
    if (currentUser.user && typeof currentUser.user === "object") {
      currentUser.user = Object.assign({}, currentUser.user, data);
    } else {
      currentUser = Object.assign({}, currentUser, data);
    }

    writeCache(USER_CACHE_KEY, currentUser);
    fillProfileUI();
    if (msgEl) msgEl.textContent = "‚úÖ Changes saved.";
  } catch (err) {
    console.error(err);
    if (msgEl) msgEl.textContent = "‚ùå Error saving data.";
  }
}


    async function saveAddress() {
      const msgEl = document.getElementById("addrMsg");
      if (msgEl) msgEl.textContent = "Saving address‚Ä¶";

      const data = {
        eircode: document.getElementById("addrEircode")?.value.trim() || "",
        county: document.getElementById("addrCounty")?.value.trim() || "",
        city: document.getElementById("addrCity")?.value.trim() || "",
        street: document.getElementById("addrStreet")?.value.trim() || "",
        country: "Ireland"
      };

      try {
        const res = await fetch(API_ROOT + "/user/me/address", {
          method: "POST",
          headers: authHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify(data)
        });

        if (res.status === 401 || res.status === 403) {
          requireTokenOrRedirect();
          return;
        }

        if (!res.ok) {
          throw new Error("Erro ao salvar endere√ßo");
        }

        currentAddress = data;
        if (msgEl) msgEl.textContent = "‚úÖ Address saved.";
      } catch (err) {
        console.error(err);
        if (msgEl) msgEl.textContent = "‚ùå Error saving address.";
      }
    }

    // Em alguns celulares (especialmente iPhone), fotos da galeria podem vir MUITO grandes,
    // ou com mimetype vazio/HEIC, e isso costuma estourar limites do backend/Cloudinary.
    // Aqui a gente tenta reduzir e converter pra JPEG antes de enviar.
    async function prepareAvatarForUpload(file){
      const MAX_BYTES = 2.5 * 1024 * 1024; // ~2.5MB
      const MAX_DIM = 1600;
      const QUALITY = 0.82;

      if (!file) return { blob: null, name: 'avatar.jpg' };

      const type = (file.type || '').toLowerCase();
      const looksImage = type.startsWith('image/') || type === '';
      const isHeic = type === 'image/heic' || type === 'image/heif';

      // Se ja esta pequeno e com tipo "normal", manda como veio.
      if (looksImage && !isHeic && file.size <= MAX_BYTES && type) {
        return { blob: file, name: file.name || 'avatar.jpg' };
      }

      // Tenta desenhar num canvas e exportar JPEG (tambem resolve tipo vazio em iOS).
      try {
        const objectUrl = URL.createObjectURL(file);
        const img = await new Promise((resolve, reject) => {
          const im = new Image();
          im.decoding = 'async';
          im.onload = () => { try { URL.revokeObjectURL(objectUrl); } catch(_){}; resolve(im); };
          im.onerror = (e) => { try { URL.revokeObjectURL(objectUrl); } catch(_){}; reject(e); };
          im.src = objectUrl;
        });

        let w = img.naturalWidth || img.width;
        let h = img.naturalHeight || img.height;
        if (!w || !h) throw new Error('invalid image');
        const scale = Math.min(1, MAX_DIM / Math.max(w, h));
        w = Math.max(1, Math.round(w * scale));
        h = Math.max(1, Math.round(h * scale));

        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d', { alpha: false });
        ctx.drawImage(img, 0, 0, w, h);

        const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', QUALITY));
        if (!blob) throw new Error('jpeg conversion failed');

        const base = (file.name || 'avatar').replace(/\.[a-z0-9]+$/i, '');
        return { blob, name: base + '.jpg' };
      } catch (e) {
        // Se falhar a conversao, envia o arquivo original mesmo.
        return { blob: file, name: file.name || 'avatar.jpg' };
      }
    }

    async function uploadAvatar(file) {
      const msgEl = document.getElementById("accountMsg");
      const avatarImg = document.getElementById("avatar");
      if (!file) return;

      // preview imediato enquanto faz upload
      try {
        const previewUrl = URL.createObjectURL(file);
        if (avatarImg) avatarImg.src = previewUrl;
      } catch (_) {}

      if (msgEl) msgEl.textContent = "Uploading photo‚Ä¶";

      const prepared = await prepareAvatarForUpload(file);
      if (!prepared || !prepared.blob) return;

      const fd = new FormData();
      // Importante: usar o 3¬∫ parametro (filename) ajuda no iOS quando o tipo vem vazio.
      fd.append("avatar", prepared.blob, prepared.name || 'avatar.jpg');

      try {
        const res = await fetch(API_ROOT + "/user/me/avatar", {
  method: "POST",
  credentials: "include",
  headers: authHeaders(),
  body: fd
});


        if (res.status === 401 || res.status === 403) {
          requireTokenOrRedirect();
          return;
        }

        const raw = await res.text();
        let data = null;
        try { data = raw ? JSON.parse(raw) : null; } catch (_) { data = raw; }

        if (!res.ok) {
          const errMsg = (data && (data.error || data.message)) || (typeof data === 'string' ? data : '') || `HTTP ${res.status}`;
          throw new Error(errMsg);
        }

        // Resposta esperada: { avatar_url: "..." } ou { avatar: "..." }
        if (data && typeof data === 'object' && (data.avatar_url || data.avatar)) {
          let finalUrl = String(data.avatar_url || data.avatar);
          if (!/^https?:\/\//i.test(finalUrl)) {
            let path = finalUrl;
            if (!path.startsWith("/")) path = "/" + path;
            finalUrl = API_ROOT + path;
          }
          // cache-busting pra evitar avatar antigo em cache
          finalUrl += (finalUrl.includes("?") ? "&" : "?") + "v=" + Date.now();

          if (avatarImg) avatarImg.src = finalUrl;
          currentUser = currentUser || {};
          if (currentUser.user && typeof currentUser.user === 'object') {
            currentUser.user.avatar_url = finalUrl;
          } else {
            currentUser.avatar_url = finalUrl;
          }
          writeCache(USER_CACHE_KEY, currentUser);
        }

        if (msgEl) msgEl.textContent = "‚úÖ Photo uploaded.";
      } catch (err) {
        console.error(err);
        if (msgEl) msgEl.textContent = err?.message ? ("‚ùå " + err.message) : "‚ùå Error uploading photo.";
      }
    }

async function logout() {
  try {
    await fetch("https://auth.vintage-clothes.ie/user/logout", {
  method: "GET",
  credentials: "include"
});

  } catch (_) {}

  try { sessionStorage.clear(); } catch (_) {}
  try { localStorage.clear(); } catch (_) {}

  // limpa caches (se tiver service worker / cache storage)
  try {
    if (window.caches) {
      const keys = await caches.keys();
      await Promise.all(keys.map(k => caches.delete(k)));
    }
  } catch (_) {}

  window.location.href = "https://vintage-clothes.ie/";
}





    function attachEvents() {
      const pick = document.getElementById("btnPickAvatar");
      if (pick) pick.addEventListener("click", () => {
        const input = document.getElementById("avatarFileInput");
        if (input) input.click();
      });

      const input = document.getElementById("avatarFileInput");
      if (input) input.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (file) uploadAvatar(file);
      });

      const btnAcc = document.getElementById("btnSaveAccount");
      if (btnAcc) btnAcc.addEventListener("click", (e) => {
        e.preventDefault();
        saveAccount();
      });

      const btnAddr = document.getElementById("btnSaveAddress");
      if (btnAddr) btnAddr.addEventListener("click", (e) => {
        e.preventDefault();
        saveAddress();
      });

      const btnLogout = document.getElementById("btnLogout");
      if (btnLogout) btnLogout.addEventListener("click", (e) => {
        e.preventDefault();
        logout();
      });
    }

    async function initPage() {
      requireTokenOrRedirect();
      // paint cached data immediately (helps on GitHub Pages / slow networks)
      const cachedU = readCache(USER_CACHE_KEY);
      if (cachedU) { currentUser = cachedU; fillProfileUI(); }
      const cachedA = readCache(ADDR_CACHE_KEY);
      if (cachedA) { currentAddress = cachedA; fillAddressUI(); }
      if (document.getElementById('year')) document.getElementById('year').textContent = new Date().getFullYear();
      attachEvents();
      await loadProfile();
      await loadSettings();
     await loadRewardsStatus();
    }

    document.addEventListener("DOMContentLoaded", initPage);
  </script>
</body>
</html>
