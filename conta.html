<!DOCTYPE html>
<html lang="en-IE">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer Dashboard - Account</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>

  <meta http-equiv="Cache-Control" content="no-store" />

  <style>
    :root{
      --cream:#f6f1e7;
      --cream-2:#f3e9d8;
      --text:#2b2723;
      --muted:#7c6f63;
      --card:#ffffff;

      --gold:#D4AF37;
      --gold-soft: rgba(212,175,55,.55);

      --border:#e0d5c2;
      --shadow:0 18px 42px rgba(0,0,0,.32);
      --radius:22px;

      --btn-bg: rgba(255,255,255,.88);
      --btn-text: #3b2206;

      --bronze:#cd7f32;
      --silver:#c0c0c0;
      --gold2:#D4AF37;
    }

    *{ box-sizing:border-box; }
    html{ scroll-behavior:smooth; }
    body{
      margin:0;
      font-family: Poppins, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: linear-gradient(135deg,#fdf4e3,#f1dfc2,#e3c395);
      color: var(--text);
      min-height: 100dvh;
      padding: 22px 10px 40px;
    }

    /* Fundo reativo */
    #reactiveField{ position:fixed; inset:0; z-index:0; pointer-events:none; }

    .wrap{
      position:relative; z-index:1;
      max-width: 1100px;
      margin: 0 auto;
    }

    .glass{
      background: linear-gradient(135deg,rgba(253,244,227,0.10),rgba(241,223,194,0.08),rgba(227,195,149,0.14));
      backdrop-filter: saturate(120%) blur(6px);
      -webkit-backdrop-filter: saturate(120%) blur(6px);
      border:1px solid rgba(212,175,55,.55);
      border-radius: 28px;
      box-shadow: var(--shadow), 0 0 26px rgba(212,175,55,.22);
    }

    header{
      padding: 16px 18px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .top-left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 180px;
    }
    .top-left small{
      color: var(--muted);
      font-weight: 700;
      letter-spacing:.04em;
    }

    .btn{
      appearance:none;
      border:1px solid var(--gold-soft);
      background: var(--btn-bg);
      color: var(--btn-text);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,.10);
      transition: transform .15s ease, filter .15s ease, background .15s ease, border-color .15s ease;
      text-decoration:none;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      filter: brightness(1.03);
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.95), transparent 60%),
        linear-gradient(120deg, rgba(212,175,55,.22), rgba(240,180,59,.22));
      border-color: rgba(212,175,55,.75);
    }
    .btn:active{ transform: translateY(0); filter: brightness(.99); }
    .btn.small{ padding: 8px 12px; font-weight: 900; }
    .btn.primary{
      background: linear-gradient(120deg, rgba(212,175,55,.25), rgba(240,180,59,.25));
    }
    .btn.danger{
      border-color: rgba(179,59,46,.35);
      color: #7a1f16;
    }

    .divider{
      height:2px;
      background: linear-gradient(90deg, transparent, rgba(212,175,55,.95), transparent);
      border-radius: 999px;
      box-shadow: 0 10px 22px rgba(212,175,55,.20);
      margin: 0 18px;
    }

    /* "Landing" */
    .page{
      padding: 14px;
    }

    .hero{
      padding: 16px;
      border-radius: var(--radius);
    }

    .hero-center{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
      text-align:center;
      padding: 10px 10px 6px;
    }

    .hero-title{
      margin:0;
      font-family: Orbitron, Poppins, system-ui, sans-serif;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size: 20px;
    }

    .avatar-wrap{
      width: 160px; height: 160px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.92), rgba(255,255,255,.55));
      border: 2px solid rgba(212,175,55,.92);
      box-shadow: 0 18px 40px rgba(0,0,0,.18), 0 0 20px rgba(212,175,55,.18);
      display:flex; align-items:center; justify-content:center;
      position: relative;
      overflow:hidden;
    }
    .avatar-wrap img{
      width: 144px; height: 144px;
      border-radius: 999px;
      object-fit: cover;
      display:block;
      background: linear-gradient(135deg, rgba(212,175,55,.20), rgba(240,180,59,.15));
      border: 1px solid rgba(0,0,0,.05);
    }

    .name{
      margin: 0;
      font-weight: 900;
      font-size: 18px;
    }
    .sub{
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    /* Barra de n√≠vel (3 n√≠veis) */
    .level-wrap{
      width: min(520px, 94%);
      margin-top: 2px;
    }

    .level-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.76);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      font-weight: 900;
      letter-spacing:.06em;
      text-transform: uppercase;
      color: #3b2206;
    }

    .badge-dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--bronze);
      box-shadow: 0 0 0 4px rgba(205,127,50,.12);
    }

    .level-bar{
      height: 14px;
      border-radius: 999px;
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.06);
      overflow:hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.08);
      position:relative;
    }
    .level-fill{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(205,127,50,.95), rgba(205,127,50,.78));
      transition: width .35s ease, filter .35s ease;
    }
    .level-splits{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top: 8px;
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 11px;
      color: var(--muted);
    }
    .level-splits span{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .level-splits i{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.10);
      display:inline-block;
    }
    .level-splits .on{ color: var(--text); }
    .level-splits .on i{ background: var(--bronze); }
    .level-splits .on.silver i{ background: var(--silver); }
    .level-splits .on.gold i{ background: var(--gold2); }

    /* Navega√ß√£o (topo abaixo do hero) */
    .nav{
      margin: 14px auto 0;
      width: min(900px, 100%);
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:center;
    }
    .nav .btn{ font-weight: 900; }

    /* Cards */
    .grid{
      width: min(980px, 100%);
      margin: 14px auto 0;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid rgba(224,213,194,.9);
      background: rgba(255,255,255,.78);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .muted{ color: var(--muted); }

    .stat{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-height: 72px;
    }
    .stat .k{
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 900;
    }
    .stat .v{
      font-size: 22px;
      font-weight: 900;
      line-height: 1.1;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.02);
      border: 1px solid rgba(0,0,0,.06);
      color: var(--muted);
      font-weight: 800;
      font-size: 12px;
    }
    .pill strong{ color: var(--text); }

    /* Wheel (sempre vis√≠vel) */
.wheel-area{
  width: min(980px, 100%);
  margin: 12px auto 0;
}

.wheel-stack{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 12px;
  margin-top: 10px;
  text-align:center;
}

.wheel-box{
  position:relative;
  width: min(340px, 82vw);
  aspect-ratio: 1 / 1;
  margin: 0 auto;
}

.wheel-rotate{
  width:100%;
  height:100%;
  border-radius: 999px;
  overflow:hidden;
  box-shadow: 0 22px 60px rgba(0,0,0,.16), 0 0 20px rgba(212,175,55,.12);
  border: 2px solid rgba(212,175,55,.85);
  background: rgba(255,255,255,.35);
  transform: rotate(0deg);
}

.wheel-box::after{
  content:"";
  position:absolute;
  inset: 20%;
  border-radius: 999px;
  background: rgba(255,255,255,.70);
  border: 1px solid rgba(0,0,0,.06);
  box-shadow: inset 0 4px 18px rgba(0,0,0,.10);
  pointer-events:none;
  z-index: 2;
}

#wheelCanvas{
  width:100%;
  height:100%;
  display:block;
  position:relative;
  z-index: 1;
}

.pointer{
  position:absolute;
  top: -12px;
  left: 50%;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 14px solid transparent;
  border-right: 14px solid transparent;
  border-bottom: 22px solid rgba(255,122,26,.92);
  filter: drop-shadow(0 8px 14px rgba(0,0,0,.18));
  z-index: 3;
  pointer-events:none;
}

.wheel-instructions{
  max-width: 680px;
  line-height: 1.7;
}

    /* Se√ß√µes */
    section{
      width: min(980px, 100%);
      margin: 14px auto 0;
      scroll-margin-top: 90px;
    }
    .section-title{
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .04em;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin: 10px 0;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .field input, .field textarea, .field select{
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(212,175,55,.55);
      background: rgba(255,255,255,.92);
      outline:none;
      font-weight: 600;
      resize: vertical;
    }
    .field textarea{ border-radius: 18px; min-height: 88px; }

    /* Orders - barra de processo */
    .stepper{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 10px;
      align-items:center;
    }
    .step{
      text-align:center;
      font-weight: 900;
      font-size: 11px;
      letter-spacing:.08em;
      text-transform: uppercase;
      color: var(--muted);
      position:relative;
      padding-top: 18px;
    }
    .step::before{
      content:"";
      position:absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(0,0,0,.08);
    }
    .step.done{ color: var(--text); }
    .step.done::before{
      background: linear-gradient(120deg, rgba(212,175,55,.95), rgba(240,180,59,.95));
      border-color: rgba(212,175,55,.8);
      box-shadow: 0 0 0 4px rgba(212,175,55,.14);
    }
    .stepper-line{
      height: 10px;
      margin-top: 10px;
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 999px;
      overflow:hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.08);
    }
    .stepper-line span{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(212,175,55,.9), rgba(240,180,59,.9));
    }

    /* Lista simples */
    .list{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    footer{
      margin-top: 16px;
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      padding-bottom: 6px;
    }

    /* File input hidden (avoid display:none; keep it "present" for Android/MIUI pickers) */
    .file-input-hidden{
      position: fixed;
      left: 0;
      bottom: 0;
      width: 1px;
      height: 1px;
      opacity: 0;
      z-index: -1;
      pointer-events: none;
    }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <canvas id="reactiveField" aria-hidden="true"></canvas>

  <div class="wrap">
    <div class="glass">
      <header>
        <div class="top-left">
          <small>Vintage Wear Ireland</small>
</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <a class="btn small" href="painel.html" title="Back to dashboard home">üè† Dashboard Home</a>
          <a class="btn small" href="index.html" title="Back to store">üõçÔ∏è Store</a>
        </div>
      </header>

      <div class="divider"></div>

      <div class="page">
        <!-- HERO -->
        <div class="hero glass">
          <div class="hero-center">
            <h1 class="hero-title">Customer Dashboard</h1>

<!-- Nav buttons -->
            <div class="nav" aria-label="Shortcuts">
              <a class="btn small primary" href="conta.html">üë§ Account</a>
              <a class="btn small" href="carrinho.html">üõí My cart</a>
              <a class="btn small" href="pedidos.html">üì¶ Orders</a>
            </div>


            <div class="avatar-wrap" aria-label="Profile photo (circular)">
              <img id="avatar" alt="User photo" />
            </div>

            <p class="name" id="userName">Your Name</p>
            <p class="sub" id="userEmail">email@example.com</p>

            <!-- Barra de n√≠vel -->
            <div class="level-wrap" aria-label="Customer level">
              <div class="level-head">
                <div class="badge"><span class="badge-dot" id="levelDot"></span> <span id="levelLabel">Bronze</span></div>
                <span class="pill"><strong id="levelProgressText">‚Ç¨0</strong> this month</span>
              </div>

              <div class="level-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                <div class="level-fill" id="levelFill"></div>
              </div>

              <div class="level-splits" aria-label="Bronze, Silver and Gold">
                <span id="lvlBronze" class="on"><i></i> Bronze</span>
                <span id="lvlSilver"><i></i> Silver</span>
                <span id="lvlGold"><i></i> Gold</span>
              </div>
              <div class="muted" style="margin-top:8px; font-weight:700;" id="levelHint">Fill the bar to level up.</div>
            </div>


          </div>
        </div>

        <!-- CONTA -->
        <section id="conta">
          <h2 class="section-title">Account</h2>

          <div class="grid">
            <div class="card">
              <div class="row">
                <strong>Dados</strong>
                <span class="pill">Tudo da sua conta</span>
              </div>

              <div class="field">
                <label>Nome</label>
                <input id="accName" placeholder="Seu nome" />
              </div>

              <div class="field">
                <label>Email</label>
                <input id="accEmail" placeholder="email@example.com" />
              </div>

              <div class="field">
                <label>Telefone</label>
                <input id="accPhone" placeholder="+353 ..." />
              </div>

              <div class="row" style="margin-top:10px;">
                <button class="btn small" id="btnPickAvatar">üì∑ Adicionar foto</button>
                <span class="pill" id="avatarFileName"><strong>‚Äî</strong></span>
              </div>

              <div class="row" style="margin-top:12px;">
                <button class="btn primary" id="btnSaveAccount">Save changes</button>
                <button class="btn danger" id="btnLogout">Log out</button>
              </div>
              <div class="muted" style="margin-top:10px; font-weight:700;" id="accountMsg">‚Äî</div>
            </div>

            <div class="card">
              <div class="row">
                <strong>Change password</strong>
                <span class="pill">security</span>
              </div>

              <div class="field">
                <label>Current password</label>
                <input id="passCurrent" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
              </div>
              <div class="field">
                <label>New password</label>
                <input id="passNew" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
              </div>
              <div class="field">
                <label>Confirm new password</label>
                <input id="passConfirm" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
              </div>

              <div class="row" style="margin-top:12px;">
                <button class="btn primary" id="btnChangePass">Save new password</button>
                <span class="muted" id="passMsg" style="font-weight:700;">‚Äî</span>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top:12px;">
            <div class="row">
              <strong>Address</strong>
              <span class="pill">Ireland</span>
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:12px; margin-top:10px;">
              <div class="field">
                <label>Eircode</label>
                <input id="addrEircode" placeholder="D02 X285" />
              </div>
              <div class="field">
                <label>County</label>
                <input id="addrCounty" placeholder="Dublin" />
              </div>
            </div>

            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:12px;">
              <div class="field">
                <label>City</label>
                <input id="addrCity" placeholder="Dublin" />
              </div>
              <div class="field">
                <label>Street & number</label>
                <input id="addrStreet" placeholder="1 Example Street" />
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn primary" id="btnSaveAddress">Save address</button>
              <span class="pill"><strong>Country:</strong> Ireland</span>
            </div>

            <div class="muted" style="margin-top:10px; font-weight:700;" id="addrMsg">‚Äî</div>
          </div>
        </section>

        <footer>¬© <span id="year"></span> Vintage Wear Ireland</footer>
      </div>
    </div>
  </div>

  <input id="avatarFileInput" type="file" accept="image/*" class="file-input-hidden" />
  <script src="auth-guard.js"></script>
  <script>
    const API_ROOT = "https://clientes-0r5d.onrender.com";
    const TOKEN_KEY = "vw_token";

    function getToken() {
      try { return localStorage.getItem(TOKEN_KEY); } catch (_) { return null; }
    }

    function requireTokenOrRedirect() {
      const t = getToken();
      if (!t) {
        window.location.href = "cliente-login-2.html";
      }
      return t;
    }

    function authHeaders(extra) {
      const t = getToken();
      const base = t ? { "Authorization": "Bearer " + t } : {};
      return Object.assign(base, extra || {});
    }

    async function apiJson(path, opts = {}){
      const url = API_ROOT + path;
      const init = {
        method: opts.method || 'GET',
        headers: authHeaders({ 'Content-Type': 'application/json', ...(opts.headers||{}) }),
      };
      if (opts.body !== undefined) init.body = (typeof opts.body === 'string') ? opts.body : JSON.stringify(opts.body);

      const res = await fetch(url, init);
      if (res.status === 401 || res.status === 403){
        requireTokenOrRedirect();
        throw new Error('unauthorized');
      }

      const text = await res.text();
      let data = null;
      try{ data = text ? JSON.parse(text) : null; } catch(_){ data = text; }
      if (!res.ok){
        const msg = (data && (data.error || data.message)) || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    }

    // API helpers exposed (minimal)
    window.VW_API = window.VW_API || {};
    window.VW_API.root = API_ROOT;
    window.VW_API.apiJson = apiJson;


    function defaultAvatarDataUri() {
      const svg = encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="240" height="240" viewBox="0 0 240 240">
          <defs>
            <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
              <stop stop-color="#D4AF37" stop-opacity="0.35"/>
              <stop stop-color="#f0b43b" stop-opacity="0.18" offset="1"/>
            </linearGradient>
          </defs>
          <rect width="240" height="240" rx="120" fill="url(#g)"/>
          <circle cx="120" cy="92" r="44" fill="rgba(43,39,35,0.16)"/>
          <path d="M48 212c14-46 50-68 72-68s58 22 72 68" fill="rgba(43,39,35,0.14)"/>
        </svg>
      `);
      return `data:image/svg+xml;charset=utf-8,${svg}`;
    }

    let currentUser = null;
    let currentAddress = null;

    function $(id) { return document.getElementById(id); }

   function fillProfileUI() {
  const u = currentUser || {};

  if (document.getElementById("userName"))
    document.getElementById("userName").textContent = u.name || "Your Name";

  if (document.getElementById("userEmail"))
    document.getElementById("userEmail").textContent = u.email || "email@example.com";

  if (document.getElementById("accName"))
    document.getElementById("accName").value = u.name || "";

  if (document.getElementById("accEmail"))
    document.getElementById("accEmail").value = u.email || "";

  if (document.getElementById("accPhone"))
    document.getElementById("accPhone").value = u.phone || "";

  const avatar = document.getElementById("avatar");

  if (avatar) {
    if (u.avatar_url && u.avatar_url.length > 0) {
      if (u.avatar_url.startsWith("http")) {
        avatar.src = u.avatar_url;
      } else {
        avatar.src = API_ROOT + u.avatar_url;
      }
    } else {
      avatar.src = defaultAvatarDataUri();
    }
  }
}




  
    function fillAddressUI() {
      const a = currentAddress || {};
      if (document.getElementById("addrEircode")) document.getElementById("addrEircode").value = a.eircode || "";
      if (document.getElementById("addrCounty")) document.getElementById("addrCounty").value = a.county || "";
      if (document.getElementById("addrCity")) document.getElementById("addrCity").value = a.city || "";
      if (document.getElementById("addrStreet")) document.getElementById("addrStreet").value = a.street || "";
    }

    async function loadProfile() {
      try {
        const res = await fetch(API_ROOT + "/user/me", {
          headers: authHeaders()
        });
        if (!res.ok) {
          console.warn("Falha ao carregar /user/me:", res.status);
          return;
        }
        const data = await res.json();
        currentUser = data || {};
        fillProfileUI();
      } catch (err) {
        console.error("Erro carregando /user/me", err);
      }
    }

    async function loadSettings() {
      try {
        const res = await fetch(API_ROOT + "/user/settings", {
          headers: authHeaders()
        });
        if (!res.ok) {
          console.warn("Falha ao carregar /user/settings:", res.status);
          return;
        }
        const data = await res.json();
        const addr = (data && data.address) || {};
        currentAddress = {
          eircode: addr.eircode || "",
          county: addr.county || "",
          city: addr.city || "",
          street: addr.street || "",
          country: addr.country || "Ireland"
        };
        fillAddressUI();
      } catch (err) {
        console.error("Erro carregando /user/settings", err);
      }
    }

    async function saveAccount() {
      const name = document.getElementById("accName")?.value.trim() || "";
      const email = document.getElementById("accEmail")?.value.trim() || "";
      const phone = document.getElementById("accPhone")?.value.trim() || "";
      const msgEl = document.getElementById("accountMsg");
      if (msgEl) msgEl.textContent = "Saving changes‚Ä¶";

      try {
        const res = await fetch(API_ROOT + "/user/me/profile", {
          method: "POST",
          headers: authHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify({ name, email, phone })
        });

        if (res.status === 401 || res.status === 403) {
          requireTokenOrRedirect();
          return;
        }

        if (!res.ok) {
          throw new Error("Erro ao salvar");
        }

        currentUser = Object.assign({}, currentUser || {}, { name, email, phone });
        fillProfileUI();
        if (msgEl) msgEl.textContent = "‚úÖ Changes saved.";
      } catch (err) {
        console.error(err);
        if (msgEl) msgEl.textContent = "‚ùå Error saving data.";
      }
    }

    async function saveAddress() {
      const msgEl = document.getElementById("addrMsg");
      if (msgEl) msgEl.textContent = "Saving address‚Ä¶";

      const data = {
        eircode: document.getElementById("addrEircode")?.value.trim() || "",
        county: document.getElementById("addrCounty")?.value.trim() || "",
        city: document.getElementById("addrCity")?.value.trim() || "",
        street: document.getElementById("addrStreet")?.value.trim() || "",
        country: "Ireland"
      };

      try {
        const res = await fetch(API_ROOT + "/user/me/address", {
          method: "POST",
          headers: authHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify(data)
        });

        if (res.status === 401 || res.status === 403) {
          requireTokenOrRedirect();
          return;
        }

        if (!res.ok) {
          throw new Error("Erro ao salvar endere√ßo");
        }

        currentAddress = data;
        if (msgEl) msgEl.textContent = "‚úÖ Address saved.";
      } catch (err) {
        console.error(err);
        if (msgEl) msgEl.textContent = "‚ùå Error saving address.";
      }
    }


    // --- Avatar helpers (Android-friendly) ---
    function setAvatarFileName(name){
      const el = document.getElementById("avatarFileName");
      if (el) el.innerHTML = `<strong>${name || "‚Äî"}</strong>`;
    }

    function loadImageFromFile(file){
      return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
        img.src = url;
      });
    }

    async function prepareAvatarFile(file){
      if (!file) return null;

      // Some gallery providers can hand back a placeholder with 0 bytes until the file is downloaded.
      if ((file.size || 0) === 0) {
        throw new Error("Couldn't read this photo (0 bytes). Try picking another photo, or download it to the device first.");
      }

      // Android/MIUI/Google Photos sometimes returns images with empty type or formats like WEBP/HEIC.
      // We'll try to decode and normalize to JPEG, resizing + compressing to stay under a safe size.
      const MAX_SIDE = 1024;
      const TARGET_MAX_BYTES = 1_500_000; // ~1.5MB

      // Helper: decode image (prefer createImageBitmap, but it can hang on some Android/MIUI devices)
      async function decodeToDrawable(f){
        const timeout = (ms) => new Promise((_, reject) => setTimeout(() => reject(new Error('decode-timeout')), ms));
        if (window.createImageBitmap) {
          try {
            return await Promise.race([createImageBitmap(f), timeout(8000)]);
          } catch (_) {
            // fall through to <img> decode
          }
        }
        return await loadImageFromFile(f);
      }

      // Helper: canvas -> Blob (fallback for old WebViews)
      function canvasToBlob(canvas, type, quality){
        return new Promise((resolve) => {
          if (canvas.toBlob) {
            canvas.toBlob((b) => resolve(b), type, quality);
          } else {
            try {
              const dataUrl = canvas.toDataURL(type, quality);
              const parts = dataUrl.split(',');
              const mime = (parts[0].match(/data:(.*?);base64/)||[])[1] || type;
              const bin = atob(parts[1]);
              const arr = new Uint8Array(bin.length);
              for (let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
              resolve(new Blob([arr], { type: mime }));
            } catch (_) {
              resolve(null);
            }
          }
        });
      }

      // Decide if we *need* conversion (unknown type, non-jpeg/png, or big file)
      const okTypes = ["image/jpeg","image/png"];
      const tooBig = (file.size || 0) > TARGET_MAX_BYTES;
      const needsConvert = !okTypes.includes(file.type) || tooBig;

      if (!needsConvert) return file;

      let drawable;
      try {
        drawable = await decodeToDrawable(file);
      } catch (err) {
        // If we can't decode (often HEIC/HEIF on some Android browsers), give a clear message.
        throw new Error("This photo format isn't supported on this device/browser. Please pick a JPG/PNG (or take a new photo). HEIC/HEIF may fail on some Androids.");
      }

      // Get dimensions
      const width = drawable.width || drawable.naturalWidth || 1;
      const height = drawable.height || drawable.naturalHeight || 1;
      const scale = Math.min(1, MAX_SIDE / Math.max(width, height));
      const w = Math.max(1, Math.round(width * scale));
      const h = Math.max(1, Math.round(height * scale));

      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(drawable, 0, 0, w, h);

      // Try a few qualities until we get under target size
      let blob = null;
      for (const q of [0.9, 0.85, 0.8, 0.75, 0.7, 0.65]) {
        blob = await canvasToBlob(canvas, 'image/jpeg', q);
        if (blob && blob.size <= TARGET_MAX_BYTES) break;
      }

      if (!blob) {
        // last resort: send original
        return file;
      }

      const base = (file.name || 'avatar').replace(/\.[^.]+$/, '');
      return new File([blob], base + '.jpg', { type: 'image/jpeg' });
    }


    // Upload avatar with XHR (more reliable than fetch+FormData on some Android/MIUI/WebViews)
    function uploadAvatarXHR(file) {
      const msgEl = document.getElementById("accountMsg");
      const avatarImg = document.getElementById("avatar");
      if (!file) return Promise.resolve();

      return new Promise((resolve, reject) => {
        const fd = new FormData();
        // Explicit filename helps some servers/frameworks
        fd.append("avatar", file, file.name || "avatar.jpg");

        const xhr = new XMLHttpRequest();
        xhr.open("POST", API_ROOT + "/user/me/avatar", true);

        // Auth header only (do NOT set Content-Type for FormData)
        const t = getToken();
        if (t) xhr.setRequestHeader("Authorization", "Bearer " + t);

        // Reasonable timeout so it doesn't hang forever
        xhr.timeout = 30000;

        xhr.upload.onprogress = (ev) => {
          if (!msgEl) return;
          if (ev && ev.lengthComputable) {
            const pct = Math.round((ev.loaded / ev.total) * 100);
            msgEl.textContent = `Uploading photo‚Ä¶ ${pct}%`;
          } else {
            msgEl.textContent = "Uploading photo‚Ä¶";
          }
        };

        xhr.onload = () => {
          try {
            if (xhr.status === 401 || xhr.status === 403) {
              requireTokenOrRedirect();
              resolve();
              return;
            }
            if (xhr.status < 200 || xhr.status >= 300) {
              const errText = (xhr.responseText || "").trim();
              reject(new Error(errText || ("HTTP " + xhr.status)));
              return;
            }

            let data = null;
            try { data = xhr.responseText ? JSON.parse(xhr.responseText) : null; } catch (_) {}

            if (data && data.avatar_url) {
              if (avatarImg) {
                avatarImg.src = data.avatar_url.startsWith("http") ? data.avatar_url : (API_ROOT + data.avatar_url);
              }
              currentUser = currentUser || {};
              currentUser.avatar_url = data.avatar_url;
            } else if (avatarImg) {
              // Fallback preview
              try { avatarImg.src = URL.createObjectURL(file); } catch (_) {}
            }

            if (msgEl) msgEl.textContent = "‚úÖ Photo uploaded.";
            resolve();
          } catch (e) {
            reject(e);
          }
        };

        xhr.onerror = () => reject(new Error("Network error"));
        xhr.ontimeout = () => reject(new Error("Upload timed out. Check your connection and try again."));

        if (msgEl) msgEl.textContent = "Uploading photo‚Ä¶";
        xhr.send(fd);
      }).catch((err) => {
        console.error(err);
        if (msgEl) msgEl.textContent = "‚ùå Error uploading photo. " + (err && err.message ? err.message : "");
        throw err;
      });
    }

    // Upload avatar with fetch + AbortController (fast on modern browsers, sometimes flaky on Android)
    async function uploadAvatarFetch(file, timeoutMs = 20000) {
      const msgEl = document.getElementById("accountMsg");
      const avatarImg = document.getElementById("avatar");
      if (!file) return;

      const fd = new FormData();
      fd.append("avatar", file, file.name || "avatar.jpg");

      const ctrl = (window.AbortController ? new AbortController() : null);
      const to = setTimeout(() => { try { ctrl && ctrl.abort(); } catch (_) {} }, timeoutMs);
      if (msgEl) msgEl.textContent = "Uploading photo‚Ä¶";

      try {
        const res = await fetch(API_ROOT + "/user/me/avatar", {
          method: "POST",
          headers: authHeaders(), // Authorization only
          body: fd,
          signal: ctrl ? ctrl.signal : undefined,
          mode: "cors",
          cache: "no-store"
        });

        if (res.status === 401 || res.status === 403) {
          requireTokenOrRedirect();
          return;
        }

        if (!res.ok) {
          // Try to surface server error (helps debugging Android-only issues)
          let txt = "";
          try { txt = (await res.text()) || ""; } catch (_) {}
          txt = (txt || "").trim();
          throw Object.assign(new Error(txt || ("HTTP " + res.status)), { status: res.status });
        }

        let data = null;
        try { data = await res.json(); } catch (_) {}

        if (data && data.avatar_url) {
          if (avatarImg) {
            avatarImg.src = data.avatar_url.startsWith("http") ? data.avatar_url : (API_ROOT + data.avatar_url);
          }
          currentUser = currentUser || {};
          currentUser.avatar_url = data.avatar_url;
        } else if (avatarImg) {
          try { avatarImg.src = URL.createObjectURL(file); } catch (_) {}
        }

        if (msgEl) msgEl.textContent = "‚úÖ Photo uploaded.";
      } finally {
        clearTimeout(to);
      }
    }

    // Smart uploader:
    // 1) try original file via fetch (most compatible with your working iPhone/desktop behavior)
    // 2) if it fails (timeout/network), try XHR
    // 3) if server rejects format/size, convert to JPEG and retry
    async function uploadAvatarSmart(file) {
      const msgEl = document.getElementById("accountMsg");
      if (!file) return;

      const meta = `type=${file.type || "(unknown)"}, size=${Math.round((file.size||0)/1024)}KB`;
      if (msgEl) msgEl.textContent = "Selected photo: " + meta;

      // Helper to decide if error looks like "unsupported" / "too large"
      const looksLikeFormatOrSize = (err) => {
        const s = (err && err.message ? String(err.message) : "").toLowerCase();
        return (err && err.status && [400, 413, 415].includes(err.status)) ||
               s.includes("unsupported") || s.includes("format") || s.includes("type") || s.includes("heic") ||
               s.includes("too large") || s.includes("payload") || s.includes("413") || s.includes("415");
      };

      // 1) Try fetch with original file
      try {
        if (msgEl) msgEl.textContent = "Uploading original‚Ä¶";
        await uploadAvatarFetch(file, 20000);
        return;
      } catch (err1) {
        console.error("fetch upload failed", err1);

        // If server complains about format/size, convert to JPEG and retry immediately
        if (looksLikeFormatOrSize(err1)) {
          try {
            if (msgEl) msgEl.textContent = "Converting to JPG for compatibility‚Ä¶";
            const prepared = await prepareAvatarFile(file);
            if (msgEl) msgEl.textContent = "Uploading converted JPG‚Ä¶";
            await uploadAvatarFetch(prepared, 20000);
            return;
          } catch (err2) {
            console.error("fetch upload (converted) failed", err2);
            // fall through to XHR
          }
        }

        // 2) Try XHR with original
        try {
          if (msgEl) msgEl.textContent = "Retrying upload‚Ä¶";
          await uploadAvatarXHR(file);
          return;
        } catch (err3) {
          console.error("xhr upload failed", err3);

          // 3) Try XHR with converted file as last resort
          try {
            if (msgEl) msgEl.textContent = "Converting to JPG and retrying‚Ä¶";
            const prepared = await prepareAvatarFile(file);
            await uploadAvatarXHR(prepared);
            return;
          } catch (err4) {
            console.error("xhr upload (converted) failed", err4);
            if (msgEl) msgEl.textContent = "‚ùå Upload failed. " + (err4 && err4.message ? err4.message : "Try another photo (JPG/PNG)." );
            throw err4;
          }
        }
      }
    }

    function changePassword() {
      const p1 = document.getElementById("passNew")?.value || "";
      const p2 = document.getElementById("passConfirm")?.value || "";
      const msgEl = document.getElementById("passMsg");

      if (!p1 || p1.length < 6) {
        if (msgEl) msgEl.textContent = "Use at least 6 characters.";
        return;
      }
      if (p1 !== p2) {
        if (msgEl) msgEl.textContent = "Confirmation doesn't match.";
        return;
      }

      if (document.getElementById("passCurrent")) document.getElementById("passCurrent").value = "";
      if (document.getElementById("passNew")) document.getElementById("passNew").value = "";
      if (document.getElementById("passConfirm")) document.getElementById("passConfirm").value = "";
      if (msgEl) msgEl.textContent = "‚úÖ Password updated (local).";
    }

    function logout() {
      try { localStorage.removeItem(TOKEN_KEY); } catch (_) {}
      window.location.href = "cliente-login-2.html";
    }

    function attachEvents() {
      const pick = document.getElementById("btnPickAvatar");
      if (pick) pick.addEventListener("click", () => {
        const input = document.getElementById("avatarFileInput");
        if (input) input.click();
      });

      const input = document.getElementById("avatarFileInput");
      if (input) input.addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        setAvatarFileName(file.name || "photo");

        // Immediate preview (helps confirm selection on Android)
        const avatarImg = document.getElementById("avatar");
        try {
          if (avatarImg) avatarImg.src = URL.createObjectURL(file);
        } catch (_) {}

        try {
          await uploadAvatarSmart(file);
        } catch (err) {
          // uploadAvatarSmart already updates the UI
          console.error(err);
        }

        // Allow re-picking the same file
        try { input.value = ""; } catch (_) {}
      });

      const avatarWrap = document.querySelector(".avatar-wrap");
      if (avatarWrap) avatarWrap.addEventListener("click", () => {
        const input = document.getElementById("avatarFileInput");
        if (input) input.click();
      });

      const btnAcc = document.getElementById("btnSaveAccount");
      if (btnAcc) btnAcc.addEventListener("click", (e) => {
        e.preventDefault();
        saveAccount();
      });

      const btnAddr = document.getElementById("btnSaveAddress");
      if (btnAddr) btnAddr.addEventListener("click", (e) => {
        e.preventDefault();
        saveAddress();
      });

      const btnPass = document.getElementById("btnChangePass");
      if (btnPass) btnPass.addEventListener("click", (e) => {
        e.preventDefault();
        changePassword();
      });

      const btnLogout = document.getElementById("btnLogout");
      if (btnLogout) btnLogout.addEventListener("click", (e) => {
        e.preventDefault();
        logout();
      });
    }

    async function initPage() {
      requireTokenOrRedirect();
      if (document.getElementById("year")) document.getElementById("year").textContent = new Date().getFullYear();
      attachEvents();
      await loadProfile();
      await loadSettings();
    }

    document.addEventListener("DOMContentLoaded", initPage);
  </script>
</body>
</html>
