<!DOCTYPE html>
<html lang="en-IE">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer Dashboard - My Cart</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>

  <meta http-equiv="Cache-Control" content="no-store" />

  <style>
    :root{
      --cream:#f6f1e7;
      --cream-2:#f3e9d8;
      --text:#2b2723;
      --muted:#7c6f63;
      --card:#ffffff;

      --gold:#D4AF37;
      --gold-soft: rgba(212,175,55,.55);

      --border:#e0d5c2;
      --shadow:0 18px 42px rgba(0,0,0,.32);
      --radius:22px;

      --btn-bg: rgba(255,255,255,.88);
      --btn-text: #3b2206;

      --bronze:#cd7f32;
      --silver:#c0c0c0;
      --gold2:#D4AF37;
    }

    *{ box-sizing:border-box; }
    html{ scroll-behavior:smooth; }
    body{
      margin:0;
      font-family: Poppins, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: linear-gradient(135deg,#fdf4e3,#f1dfc2,#e3c395);
      color: var(--text);
      min-height: 100dvh;
      padding: 22px 10px 40px;
    }

    /* Fundo reativo */
    #reactiveField{ position:fixed; inset:0; z-index:0; pointer-events:none; }

    .wrap{
      position:relative; z-index:1;
      max-width: 1100px;
      margin: 0 auto;
    }

    .glass{
      background: linear-gradient(135deg,rgba(253,244,227,0.10),rgba(241,223,194,0.08),rgba(227,195,149,0.14));
      backdrop-filter: saturate(120%) blur(6px);
      -webkit-backdrop-filter: saturate(120%) blur(6px);
      border:1px solid rgba(212,175,55,.55);
      border-radius: 28px;
      box-shadow: var(--shadow), 0 0 26px rgba(212,175,55,.22);
    }

    header{
      padding: 16px 18px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .top-left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 180px;
    }
    .top-left small{
      color: var(--muted);
      font-weight: 700;
      letter-spacing:.04em;
    }

    .btn{
      appearance:none;
      border:1px solid var(--gold-soft);
      background: var(--btn-bg);
      color: var(--btn-text);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,.10);
      transition: transform .15s ease, filter .15s ease, background .15s ease, border-color .15s ease;
      text-decoration:none;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      filter: brightness(1.03);
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.95), transparent 60%),
        linear-gradient(120deg, rgba(212,175,55,.22), rgba(240,180,59,.22));
      border-color: rgba(212,175,55,.75);
    }
    .btn:active{ transform: translateY(0); filter: brightness(.99); }
    .btn.small{ padding: 8px 12px; font-weight: 900; }
    .btn.primary{
      background: linear-gradient(120deg, rgba(212,175,55,.25), rgba(240,180,59,.25));
    }
    .btn.danger{
      border-color: rgba(179,59,46,.35);
      color: #7a1f16;
    }

    .divider{
      height:2px;
      background: linear-gradient(90deg, transparent, rgba(212,175,55,.95), transparent);
      border-radius: 999px;
      box-shadow: 0 10px 22px rgba(212,175,55,.20);
      margin: 0 18px;
    }

    /* "Landing" */
    .page{
      padding: 14px;
    }

    .hero{
      padding: 16px;
      border-radius: var(--radius);
    }

    .hero-center{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
      text-align:center;
      padding: 10px 10px 6px;
    }

    .hero-title{
      margin:0;
      font-family: Orbitron, Poppins, system-ui, sans-serif;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size: 20px;
    }

    .avatar-wrap{
      width: 160px; height: 160px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.92), rgba(255,255,255,.55));
      border: 2px solid rgba(212,175,55,.92);
      box-shadow: 0 18px 40px rgba(0,0,0,.18), 0 0 20px rgba(212,175,55,.18);
      display:flex; align-items:center; justify-content:center;
      position: relative;
      overflow:hidden;
    }
    .avatar-wrap img{
      width: 144px; height: 144px;
      border-radius: 999px;
      object-fit: cover;
      display:block;
      background: linear-gradient(135deg, rgba(212,175,55,.20), rgba(240,180,59,.15));
      border: 1px solid rgba(0,0,0,.05);
    }

    .name{
      margin: 0;
      font-weight: 900;
      font-size: 18px;
    }
    .sub{
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    /* Level bar (3 tiers) */
    .level-wrap{
      width: min(520px, 94%);
      margin-top: 2px;
    }

    .level-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.76);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      font-weight: 900;
      letter-spacing:.06em;
      text-transform: uppercase;
      color: #3b2206;
    }

    .badge-dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--bronze);
      box-shadow: 0 0 0 4px rgba(205,127,50,.12);
    }

    .level-bar{
      height: 14px;
      border-radius: 999px;
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.06);
      overflow:hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.08);
      position:relative;
    }
    .level-fill{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(205,127,50,.95), rgba(205,127,50,.78));
      transition: width .35s ease, filter .35s ease;
    }
    .level-splits{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top: 8px;
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 11px;
      color: var(--muted);
    }
    .level-splits span{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .level-splits i{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.10);
      display:inline-block;
    }
    .level-splits .on{ color: var(--text); }
    .level-splits .on i{ background: var(--bronze); }
    .level-splits .on.silver i{ background: var(--silver); }
    .level-splits .on.gold i{ background: var(--gold2); }

    /* Navigation */
    .nav{
      margin: 14px auto 0;
      width: min(900px, 100%);
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:center;
    }
    .nav .btn{ font-weight: 900; }

    /* Cards */
    .grid{
      width: min(980px, 100%);
      margin: 14px auto 0;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid rgba(224,213,194,.9);
      background: rgba(255,255,255,.78);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .muted{ color: var(--muted); }

    .stat{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-height: 72px;
    }
    .stat .k{
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 900;
    }
    .stat .v{
      font-size: 22px;
      font-weight: 900;
      line-height: 1.1;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.02);
      border: 1px solid rgba(0,0,0,.06);
      color: var(--muted);
      font-weight: 800;
      font-size: 12px;
    }
    .pill strong{ color: var(--text); }

    /* Wheel (always visible) */
.wheel-area{
  width: min(980px, 100%);
  margin: 12px auto 0;
}

.wheel-stack{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 12px;
  margin-top: 10px;
  text-align:center;
}

.wheel-box{
  position:relative;
  width: min(340px, 82vw);
  aspect-ratio: 1 / 1;
  margin: 0 auto;
}

.wheel-rotate{
  width:100%;
  height:100%;
  border-radius: 999px;
  overflow:hidden;
  box-shadow: 0 22px 60px rgba(0,0,0,.16), 0 0 20px rgba(212,175,55,.12);
  border: 2px solid rgba(212,175,55,.85);
  background: rgba(255,255,255,.35);
  transform: rotate(0deg);
}

.wheel-box::after{
  content:"";
  position:absolute;
  inset: 20%;
  border-radius: 999px;
  background: rgba(255,255,255,.70);
  border: 1px solid rgba(0,0,0,.06);
  box-shadow: inset 0 4px 18px rgba(0,0,0,.10);
  pointer-events:none;
  z-index: 2;
}

#wheelCanvas{
  width:100%;
  height:100%;
  display:block;
  position:relative;
  z-index: 1;
}

.pointer{
  position:absolute;
  top: -12px;
  left: 50%;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 14px solid transparent;
  border-right: 14px solid transparent;
  border-bottom: 22px solid rgba(255,122,26,.92);
  filter: drop-shadow(0 8px 14px rgba(0,0,0,.18));
  z-index: 3;
  pointer-events:none;
}

.wheel-instructions{
  max-width: 680px;
  line-height: 1.7;
}

    /* Sections */
    section{
      width: min(980px, 100%);
      margin: 14px auto 0;
      scroll-margin-top: 90px;
    }
    .section-title{
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .04em;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin: 10px 0;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .field input, .field textarea, .field select{
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(212,175,55,.55);
      background: rgba(255,255,255,.92);
      outline:none;
      font-weight: 600;
      resize: vertical;
    }
    .field textarea{ border-radius: 18px; min-height: 88px; }

    /* Orders - barra de processo */
    .stepper{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 10px;
      align-items:center;
    }
    .step{
      text-align:center;
      font-weight: 900;
      font-size: 11px;
      letter-spacing:.08em;
      text-transform: uppercase;
      color: var(--muted);
      position:relative;
      padding-top: 18px;
    }
    .step::before{
      content:"";
      position:absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(0,0,0,.08);
    }
    .step.done{ color: var(--text); }
    .step.done::before{
      background: linear-gradient(120deg, rgba(212,175,55,.95), rgba(240,180,59,.95));
      border-color: rgba(212,175,55,.8);
      box-shadow: 0 0 0 4px rgba(212,175,55,.14);
    }
    .stepper-line{
      height: 10px;
      margin-top: 10px;
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 999px;
      overflow:hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.08);
    }
    .stepper-line span{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(212,175,55,.9), rgba(240,180,59,.9));
    }

    /* Lista simples */
    .list{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    footer{
      margin-top: 16px;
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      padding-bottom: 6px;
    }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <canvas id="reactiveField" aria-hidden="true"></canvas>

  <div class="wrap">
    <div class="glass">
      <header>
        <div class="top-left">
          <small>Vintage Wear Ireland</small>
</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <a class="btn small" href="painel.html" title="Back to dashboard home">üè† Dashboard Home</a>
          <a class="btn small" href="index.html" title="Back to store">üõçÔ∏è Store</a>
        </div>
      </header>

      <div class="divider"></div>

      <div class="page">
        <!-- HERO -->
        <div class="hero glass">
          <div class="hero-center">
            <h1 class="hero-title">Customer Dashboard</h1>

<!-- Nav buttons -->
            <div class="nav" aria-label="Shortcuts">
              <a class="btn small" href="conta.html">üë§ Account</a>
              <a class="btn small primary" href="carrinho.html">üõí My cart</a>
              <a class="btn small" href="pedidos.html">üì¶ Orders</a>
              <a class="btn small" href="cashback.html">‚≠ê Cashback</a>
            </div>


            <div class="avatar-wrap" aria-label="Profile photo (circular)">
              <img id="avatar" alt="User photo" />
            </div>

            <p class="name" id="userName">Your Name</p>
            <p class="sub" id="userEmail">email@example.com</p>

            <!-- Barra de n√≠vel -->
            <div class="level-wrap" aria-label="Customer level">
              <div class="level-head">
                <div class="badge"><span class="badge-dot" id="levelDot"></span> <span id="levelLabel">Bronze</span></div>
                <span class="pill"><strong id="levelProgressText">‚Ç¨0</strong> this month</span>
              </div>

              <div class="level-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                <div class="level-fill" id="levelFill"></div>
              </div>

              <div class="level-splits" aria-label="Bronze, Silver and Gold">
                <span id="lvlBronze" class="on"><i></i> Bronze</span>
                <span id="lvlSilver"><i></i> Silver</span>
                <span id="lvlGold"><i></i> Gold</span>
              </div>
              <div class="muted" style="margin-top:8px; font-weight:700;" id="levelHint">Fill the bar to level up.</div>
            </div>


          </div>
        </div>

        <!-- CARRINHO -->
        <section id="carrinho">
          <h2 class="section-title">My cart</h2>

          <div class="grid">
            <div class="card">
              <div class="row">
                <strong>Items</strong>
                <span class="pill" id="cartCountTag"><strong>0</strong> items</span>
              </div>
              <div class="list" id="cartList"></div>
            </div>

            <div class="card">
              <div class="row">
                <strong>Total</strong>
                <span class="pill" id="cartTotalTag"><strong>‚Ç¨0</strong></span>
              </div>

              <div class="muted" style="margin-top:10px; line-height:1.7;">
                Your cart is saved to your account and will appear here when you sign in.
              </div>
              <!-- REWARDS -->
              <div style="margin-top:14px; padding-top:12px; border-top:1px dashed rgba(212,175,55,.45);" id="rewardsBox">
                <div style="font-weight:900; letter-spacing:.04em;">Rewards</div>
                <div class="muted" style="margin-top:6px; line-height:1.6;">
                  Choose your reward(s). You can combine <strong>Free Shipping</strong> with <strong>Points</strong> or a <strong>% Discount</strong>.
                  You can‚Äôt combine <strong>Points</strong> and <strong>% Discount</strong>.
                </div>

                <div style="margin-top:10px; display:flex; flex-direction:column; gap:10px;">
                  <label style="display:flex; gap:10px; align-items:flex-start; cursor:pointer;">
                    <input type="checkbox" id="benefitPoints" />
                    <span>
                      <div style="font-weight:900;">Use points (use full balance)</div>
                      <div class="muted" style="margin-top:2px; font-weight:700;">
                        Balance: <strong><span id="pointsBalanceCart">0</span> pts</strong> (<span id="pointsCashCart">‚Ç¨ 0.00</span>)
                      </div>
                    </span>
                  </label>

                  <div id="discountOption" style="display:none;">
                    <label style="display:flex; gap:10px; align-items:flex-start; cursor:pointer;">
                      <input type="checkbox" id="benefitDiscount" />
                      <span>
                        <div style="font-weight:900;">Use % discount (valid for 24h)</div>
                        <div class="muted" style="margin-top:2px; font-weight:700;">
                          <span class="pill" id="discountPill"><strong id="discountLabel">‚Äî</strong></span>
                        </div>
                        <div class="muted" style="margin-top:6px; font-weight:700;" id="discountExpires"></div>
                      </span>
                    </label>
                  </div>

                  <div id="shippingOption" style="display:none;">
                    <label style="display:flex; gap:10px; align-items:flex-start; cursor:pointer;">
                      <input type="checkbox" id="benefitShipping" />
                      <span>
                        <div style="font-weight:900;" id="shippingLabel">Free shipping</div>
                        <div class="muted" style="margin-top:6px; font-weight:700;" id="shippingExpires"></div>
                      </span>
                    </label>
                  </div>
                </div>

                <div class="row" style="margin-top:10px; gap:8px;">
                  <button class="btn small" id="btnApplyBenefits" type="button">Apply</button>
                </div>

                <div class="muted" style="margin-top:10px; font-weight:900;" id="rewardAppliedMsg">‚Äî</div>
                <div class="muted" style="margin-top:10px; line-height:1.8;" id="totalsBreakdown"></div>
              </div>


              <div class="row" style="margin-top:12px;">
                <a class="btn primary" id="btnResumeCheckout" href="checkout.html">‚û°Ô∏è Resume checkout</a>
                <button class="btn danger" id="btnClearCart">Clear cart</button>
              </div>
            </div>
          </div>
        </section>

        <footer>¬© <span id="year"></span> Vintage Wear Ireland</footer>
      </div>
    </div>
  </div>

  <input id="avatarFileInput" type="file" accept="image/*" class="hidden" />
  <script src="auth-guard.js"></script>


  <script>
    // ====== Estado (demo) ======
    const state = {
      me: null,
      spentMonth: 0,
      spentTotal: 0,
      points: 0,
      spinsPerDay: 1,
      spinsLeftToday: 1,
      cart: [],
      orders: [],
      cashbackHistory: [],
      addresses: [],
      avatarFile: null,
      activeDiscount: null, // {id, percent, expiresAt}
      activeShipping: null, // {id, expiresAt?}
      appliedValueReward: null,  // {id, type:'points'|'discount', amountEUR, pointsUsed, percent}
      appliedShippingReward: null, // {id, type:'shipping'}
    };

    // ====== Access token (accepts multiple keys to match the Store) ======
    const TOKEN_KEYS = ["vw_token","token","authToken","auth_token","access_token"];

    function getToken(){
      for (const k of TOKEN_KEYS){
        try{
          const t = localStorage.getItem(k);
          if (t) return t;
        }catch(_){ }
      }
      return null;
    }

    // ====== Local cart (shared with store/menu pages) ======
    const USER_ID_KEY = "vw_user_id";
    const CART_GUEST_KEY = "vw_cart";

    function getUserId(){
      try{
        return (
          (state?.me && (state.me.id ?? state.me.user_id ?? state.me.uid ?? state.me.userId)) ||
          localStorage.getItem(USER_ID_KEY) ||
          localStorage.getItem('user_id') ||
          localStorage.getItem('uid') ||
          localStorage.getItem('userId') ||
          ''
        );
      }catch(_){
        return '';
      }
    }

    function readCartByKey(key){
      try{
        const raw = localStorage.getItem(key);
        if (!raw) return [];
        const v = JSON.parse(raw);
        return Array.isArray(v) ? v : [];
      }catch(_){
        return [];
      }
    }

    function listUserCartKeys(){
      const out = [];
      try{
        for (let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if (k && String(k).startsWith('vw_cart_u_')) out.push(String(k));
        }
      }catch(_){ }
      return out;
    }

    function chooseActiveCartKey(){
      const guest = readCartByKey(CART_GUEST_KEY);
      const tok = getToken();
      const uidRaw = getUserId();
      const uid = uidRaw ? String(uidRaw) : '';
      const candidate = (uid && tok) ? `vw_cart_u_${uid}` : null;
      const candCart = candidate ? readCartByKey(candidate) : [];

      // 1) If a user cart exists with items, use it.
      if (candidate && candCart.length) return candidate;

      // 2) If guest cart has items, keep using it (so Store + Dashboard stay aligned).
      // Also mirror into the user cart (without deleting the guest cart) when possible.
      if (guest.length){
        if (candidate && !candCart.length){
          try{ localStorage.setItem(candidate, JSON.stringify(guest)); }catch(_){ }
        }
        return CART_GUEST_KEY;
      }

      // 3) If logged in but uid differs, pick any existing vw_cart_u_* with items.
      if (tok){
        for (const k of listUserCartKeys()){
          const c = readCartByKey(k);
          if (c.length) return k;
        }
      }

      // 4) Fall back.
      return candidate || CART_GUEST_KEY;
    }

    function loadLocalCart(){
      const key = chooseActiveCartKey();
      const arr = readCartByKey(key);

      // Normalize, but keep ALL original fields (stock, category, etc.) so the Store doesn't break.
      state.cart = (Array.isArray(arr) ? arr : []).map((it) => {
        const obj = (it && typeof it === 'object') ? { ...it } : {};
        const title = obj.title || obj.name || obj.product || 'Product';
        const image = obj.image || obj.img || obj.photo || obj.photo_url || obj.photoUrl || null;
        const qty = Number(obj.qty ?? obj.quantity ?? 1);
        const price = Number(obj.price ?? 0);
        return {
          ...obj,
          id: obj.id ?? obj.product_id ?? obj.productId ?? title,
          title,
          image,
          qty: (Number.isFinite(qty) && qty > 0) ? qty : 1,
          price: Number.isFinite(price) ? price : 0,
        };
      });
    }

    function saveLocalCart(){
      const key = chooseActiveCartKey();
      const normalized = (Array.isArray(state.cart) ? state.cart : []).map((it) => {
        const obj = (it && typeof it === 'object') ? { ...it } : {};
        obj.title = obj.title || obj.name || obj.product || 'Product';
        obj.image = obj.image || obj.img || obj.photo || obj.photo_url || obj.photoUrl || null;
        obj.qty = Number(obj.qty ?? obj.quantity ?? 1);
        if (!Number.isFinite(obj.qty) || obj.qty <= 0) obj.qty = 1;
        obj.price = Number(obj.price ?? 0);
        if (!Number.isFinite(obj.price)) obj.price = 0;
        return obj;
      });

      try{ localStorage.setItem(key, JSON.stringify(normalized)); }catch(_){ }

      // Mirror to guest cart too so Store and Dashboard never diverge during this phase.
      if (key !== CART_GUEST_KEY){
        try{ localStorage.setItem(CART_GUEST_KEY, JSON.stringify(normalized)); }catch(_){ }
      }
    }

    window.addEventListener('storage', (e) => {
      // Keep the cart synced if it changes in another tab/page.
      try{
        if (!e || !e.key) return;
        const changed = String(e.key);
        if (changed === CART_GUEST_KEY || changed.startsWith('vw_cart')){
          loadLocalCart();
          renderCart();
        }
      }catch(_){
        // ignore
      }
    });

    // If the token is missing (not logged in), send to login.
    // (We accept multiple keys so this matches the Store login behavior.)
    try{
      if(!getToken()){
        window.location.href = 'cliente-login-2.html';
      }
    }catch(_){ }
    const fmtEUR = (n) => {
      const v = Number(n);
      if (Number.isNaN(v)) return '‚Ç¨ ' + (n ?? '');
      return '‚Ç¨ ' + v.toFixed(2);
    };

    const pointsToCash = (points) => Number(points || 0) * 0.5; // 10 pts = ‚Ç¨5
    const calcPointsEarned = (totalSpent) => Math.floor((Number(totalSpent) || 0) / 55) * 10;

    function determineLevel(spentMonth){
      const v = Number(spentMonth) || 0;
      if (v >= 800) return { key:'GOLD', label:'Gold', dot:'var(--gold2)', fill:['rgba(212,175,55,.95)','rgba(240,180,59,.95)'], spinsPerDay: 5, hint:"You're at the top of the leaderboard." };
      if (v >= 300) return { key:'SILVER', label:'Silver', dot:'var(--silver)', fill:['rgba(192,192,192,.95)','rgba(192,192,192,.75)'], spinsPerDay: 3, hint:'Fill the bar to reach Gold.' };
      return { key:'BRONZE', label:'Bronze', dot:'var(--bronze)', fill:['rgba(205,127,50,.95)','rgba(205,127,50,.78)'], spinsPerDay: 2, hint:'Fill the bar to reach Silver.' };
    }

    function levelProgress(spentMonth){
      const v = Number(spentMonth) || 0;
      // Bronze: 0-300, Silver: 300-800, Gold: >=800
      if (v < 300) return { pct: (v/300)*100, text: `‚Ç¨${v.toFixed(0)} this month` };
      if (v < 800) return { pct: ((v-300)/(800-300))*100, text: `‚Ç¨${v.toFixed(0)} this month` };
      return { pct: 100, text: `‚Ç¨${v.toFixed(0)} this month` };
    }

    function $(id){ return document.getElementById(id); }

    function setText(id, t){ const el=$(id); if(el) el.textContent = t; }
    function setHTML(id, t){ const el=$(id); if(el) el.innerHTML = t; }


    // Basic HTML escaping to avoid breaking the layout when product titles contain special chars
    function escHtml(v){
      return String(v ?? '').replace(/[&<>"']/g, (c) => ({
        '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
      }[c]));
    }
    function escAttr(v){
      return escHtml(v).replace(/`/g, '&#96;');
    }

    function defaultAvatarDataUri(){
      const svg = encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="240" height="240" viewBox="0 0 240 240">
          <defs>
            <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
              <stop stop-color="#D4AF37" stop-opacity="0.35"/>
              <stop stop-color="#f0b43b" stop-opacity="0.18" offset="1"/>
            </linearGradient>
          </defs>
          <rect width="240" height="240" rx="120" fill="url(#g)"/>
          <circle cx="120" cy="92" r="44" fill="rgba(43,39,35,0.16)"/>
          <path d="M48 212c14-46 50-68 72-68s58 22 72 68" fill="rgba(43,39,35,0.14)"/>
        </svg>
      `);
      return `data:image/svg+xml;charset=utf-8,${svg}`;
    }

    // ====== Render ======
    function renderHero(){
      const me = state.me || {};
      setText('userName', me.name || 'Your Name');
      setText('userEmail', me.email || 'email@example.com');

      // avatar
      const img = $('avatar');
      if (img){
        img.src = me.avatar || defaultAvatarDataUri();
      }

      // points + cash
      setText('pointsNow', String(state.points || 0));
      setText('cashValue', `= ${fmtEUR(pointsToCash(state.points || 0))}`);

      // level
      const lvl = determineLevel(state.spentMonth);
      const prog = levelProgress(state.spentMonth);

      setText('levelLabel', lvl.label);
      const dot = $('levelDot');
      if (dot){
        dot.style.background = lvl.dot;
        dot.style.boxShadow = `0 0 0 4px rgba(0,0,0,.08)`;
      }

      const fill = $('levelFill');
      if (fill){
        fill.style.width = Math.max(0, Math.min(100, prog.pct)) + '%';
        fill.style.background = `linear-gradient(90deg, ${lvl.fill[0]}, ${lvl.fill[1]})`;
      }

      setText('levelProgressText', prog.text);
      setText('levelHint', lvl.hint);

      // highlight splits
      $('lvlBronze')?.classList.add('on');
      $('lvlSilver')?.classList.remove('on','silver');
      $('lvlGold')?.classList.remove('on','gold');

      if (lvl.key === 'SILVER'){
        $('lvlSilver')?.classList.add('on','silver');
        $('lvlBronze')?.classList.add('on');
      } else if (lvl.key === 'GOLD'){
        $('lvlSilver')?.classList.add('on','silver');
        $('lvlGold')?.classList.add('on','gold');
      } else {
        // bronze only
        $('lvlBronze')?.classList.add('on');
      }

      // spins
      state.spinsPerDay = lvl.spinsPerDay;
      setText('spinsPerDay', String(state.spinsPerDay));
      setText('spinsLeft', `left today: ${state.spinsLeftToday}`);
      setText('spinStatus', `${state.spinsLeftToday}/${state.spinsPerDay}`);
    }

    function renderAccount(){
  const nameEl = $('accName');
  const emailEl = $('accEmail');
  const phoneEl = $('accPhone');
  if (!nameEl || !emailEl || !phoneEl) return;

  const me = state.me || {};
  nameEl.value = me.name || '';
  emailEl.value = me.email || '';
  phoneEl.value = me.phone || '';
}

    function renderAddresses(){
      const list = state.addresses || [];
      const wrap = $('addrList');
      if (!wrap) return;

      if (!list.length){
        wrap.innerHTML = `<div class="muted" style="font-weight:700;">No address saved yet.</div>`;
        return;
      }

      wrap.innerHTML = list.map(a => `
        <div class="card" style="padding:12px; margin:0;">
          <div class="row">
            <div>
              <div style="font-weight:900">${a.name || 'Address'}</div>
              <div class="muted" style="margin-top:6px; line-height:1.6">${a.line1 || ''}<br/>${a.line2 || ''}<br/>${a.country || ''}</div>
            </div>
            <div class="row" style="gap:8px;">
              <button class="btn small" onclick="editAddress('${a.id}')">Edit</button>
              <button class="btn small danger" onclick="deleteAddress('${a.id}')">Delete</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderCart(){
      const cart = Array.isArray(state.cart) ? state.cart : [];
      const totalItems = cart.reduce((s, it) => s + Number(it.qty || 1), 0);
      const subtotal = cart.reduce((s, it) => s + (Number(it.price||0) * Number(it.qty||1)), 0);

      // apply value benefit (points OR % discount)
      const ar = state.appliedValueReward;
      let discountAmount = 0;
      let pointsAmount = 0;
      if (ar && ar.type === 'discount'){
        const pct = Number(ar.percent || 0);
        discountAmount = subtotal * (pct/100);
      } else if (ar && ar.type === 'points'){
        pointsAmount = Number(ar.amountEUR || 0);
      }

      const total = Math.max(0, subtotal - discountAmount - pointsAmount);

      setHTML('cartCountTag', `<strong>${totalItems}</strong> items`);
      setHTML('cartTotalTag', `<strong>${fmtEUR(total)}</strong>`);

      // breakdown
      const bd = $('totalsBreakdown');
      if (bd){
        let html = `<div>Subtotal: <strong>${fmtEUR(subtotal)}</strong></div>`;
        if (discountAmount > 0){
          html += `<div>Discount: <strong>- ${fmtEUR(discountAmount)}</strong> (${Number(ar?.percent||0)}%)</div>`;
        }
        if (pointsAmount > 0){
          html += `<div>Points: <strong>- ${fmtEUR(pointsAmount)}</strong> (${Number(ar?.pointsUsed||0)} pts)</div>`;
        }

        const ship = state.appliedShippingReward;
        if (ship && ship.id){
          html += `<div>Shipping: <strong>FREE ‚úÖ</strong></div>`;
        } else {
          html += `<div>Shipping: <strong>calculated at checkout</strong></div>`;
        }

        html += `<div style="margin-top:6px;">Total: <strong>${fmtEUR(total)}</strong></div>`;
        bd.innerHTML = html;
      }

      renderRewardsBox && renderRewardsBox();

      const wrap = $('cartList');
      if (!wrap) return;

      if (!cart.length){
        wrap.innerHTML = `<div class="muted" style="font-weight:700;">Your cart is empty.</div>`;
        return;
      }

      wrap.innerHTML = cart.map(it => {
        const title = it.title || 'Item';
        const qty = Number(it.qty || 1);
        const price = Number(it.price || 0);
        const lineTotal = price * qty;
        const letter = String(title).slice(0,1).toUpperCase() || '‚Ä¢';
        const img = it.image ? String(it.image) : '';

        const thumb = img
          ? `<img src="${escAttr(img)}" alt="${escAttr(title)}" style="width:100%;height:100%;object-fit:cover;display:block;" />`
          : `<div style="font-weight:900;color:#3b2206;">${escHtml(letter)}</div>`;

        return `
          <div class="card" style="padding:12px; margin:0;">
            <div class="row" style="flex-wrap:nowrap; align-items:center;">
              <div style="display:flex; gap:12px; align-items:center; min-width:0; flex:1;">
                <div style="width:54px;height:54px;border-radius:16px;overflow:hidden;background:rgba(0,0,0,.04);border:1px solid rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center;flex:0 0 auto;">
                  ${thumb}
                </div>
                <div style="min-width:0;">
                  <div style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escHtml(title)}</div>
                  <div class="muted">${fmtEUR(price)} ‚Ä¢ qty: <strong>${qty}</strong> ‚Ä¢ <strong>${fmtEUR(lineTotal)}</strong></div>
                </div>
              </div>
              <button class="btn small danger" onclick="removeCartItem('${String(it.id)}')">Remove</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function fmtDateTime(dt){
      if (!dt) return '';
      try{
        const d = new Date(dt);
        if (Number.isNaN(d.getTime())) return String(dt);
        return d.toLocaleString('en-IE', { dateStyle:'short', timeStyle:'short' });
      } catch(_){
        return String(dt);
      }
    }

    function renderRewardsBox(){
      // Points (always available)
      const pts = Number(state.points || 0);
      const elPts = $('pointsBalanceCart');
      if (elPts) elPts.textContent = String(pts);
      const elPtsCash = $('pointsCashCart');
      if (elPtsCash) elPtsCash.textContent = fmtEUR(pointsToCash(pts));

      // Active % discount (only visible if available)
      const d = state.activeDiscount;
      const discountWrap = $('discountOption');
      const lbl = $('discountLabel');
      const exp = $('discountExpires');
      const chkDis = $('benefitDiscount');

      let hasDiscount = false;
      let discountPct = 0;
      if (d && Number(d.percent || 0) > 0 && d.expiresAt){
        const expMs = new Date(d.expiresAt).getTime();
        hasDiscount = !Number.isNaN(expMs) && expMs > Date.now();
        discountPct = Number(d.percent || 0);
      }

      if (discountWrap){
        discountWrap.style.display = hasDiscount ? '' : 'none';
      }
      if (lbl) lbl.textContent = hasDiscount ? `${discountPct}% OFF` : '‚Äî';
      if (exp) exp.textContent = hasDiscount ? `Valid until: ${fmtDateTime(d.expiresAt)}` : '';
      if (chkDis && !hasDiscount){
        chkDis.checked = false;
      }

      // Active free shipping (only visible if available)
      const s = state.activeShipping;
      const shipWrap = $('shippingOption');
      const shipLbl = $('shippingLabel');
      const shipExp = $('shippingExpires');
      const chkShip = $('benefitShipping');

      let hasShipping = false;
      if (s){
        if (s.expiresAt){
          const expMs = new Date(s.expiresAt).getTime();
          hasShipping = !Number.isNaN(expMs) && expMs > Date.now();
        } else {
          hasShipping = true;
        }
      }

      if (shipWrap){
        shipWrap.style.display = hasShipping ? '' : 'none';
      }
      if (shipLbl) shipLbl.textContent = hasShipping ? 'Free shipping' : 'Free shipping';
      if (shipExp) shipExp.textContent = hasShipping && s?.expiresAt ? `Valid until: ${fmtDateTime(s.expiresAt)}` : '';
      if (chkShip && !hasShipping){
        chkShip.checked = false;
      }

      // Applied state
      const main = state.appliedValueReward;   // points OR discount
      const ship = state.appliedShippingReward; // free shipping
      const mainLocked = !!(main && main.id);
      const shipLocked = !!(ship && ship.id);

      const chkPts = $('benefitPoints');

      // Disable rules
      if (chkPts) chkPts.disabled = mainLocked || pts <= 0;
      if (chkDis) chkDis.disabled = mainLocked || !hasDiscount;
      if (chkShip) chkShip.disabled = shipLocked || !hasShipping;

      // Sync checks with applied
      if (mainLocked){
        if (chkPts) chkPts.checked = main.type === 'points';
        if (chkDis) chkDis.checked = main.type === 'discount';
      }
      if (shipLocked && chkShip){
        chkShip.checked = true;
      }

      // Mutual exclusion: points vs discount (but shipping is independent)
      if (chkPts && !mainLocked){
        chkPts.onchange = () => {
          if (chkPts.checked && chkDis) chkDis.checked = false;
          renderRewardsBox();
        };
      }
      if (chkDis && !mainLocked){
        chkDis.onchange = () => {
          if (chkDis.checked && chkPts) chkPts.checked = false;
          renderRewardsBox();
        };
      }

      // Message
      const msg = $('rewardAppliedMsg');
      if (msg){
        const parts = [];
        if (mainLocked){
          if (main.type === 'points'){
            parts.push(`‚úÖ Points applied (${Number(main.pointsUsed||0)} pts = ${fmtEUR(Number(main.amountEUR||0))}).`);
          } else if (main.type === 'discount'){
            parts.push(`‚úÖ Discount applied (${Number(main.percent||0)}%).`);
          }
        }
        if (shipLocked){
          parts.push('‚úÖ Free shipping applied.');
        }
        msg.textContent = parts.length ? parts.join(' ') : '‚Äî';
      }

      // Checkout URL carries cart + totals + applied IDs
      const ck = $('btnResumeCheckout');
      if (ck){
        const qs = [];

        // 1) Send cart items to the old checkout (it already supports ?cart=...)
        const cartArr = Array.isArray(state.cart) ? state.cart : [];
        if (cartArr.length){
          const compact = cartArr.map(it => ({
            id: String(it.id),
            title: it.title || 'Product',
            price: Number(it.price || 0),
            qty: Number(it.qty || 1)
          }));
          qs.push(`cart=${encodeURIComponent(JSON.stringify(compact))}`);
        }

        // 2) Send who is buying (so WebRock can map payment -> user)
        const uid = (
          state.me && (state.me.id ?? state.me.user_id ?? state.me.uid ?? state.me.userId)
        ) || localStorage.getItem('vw_user_id') || '';
        if (uid) qs.push(`user_id=${encodeURIComponent(String(uid))}`);

        // 3) Send subtotal AFTER rewards (discount/points). Shipping is handled in checkout.
        const subtotalRaw = cartArr.reduce((s, it) => s + (Number(it.price||0) * Number(it.qty||1)), 0);
        let discountAmount = 0;
        let pointsAmount = 0;
        if (mainLocked && main && main.type === 'discount'){
          discountAmount = subtotalRaw * (Number(main.percent || 0) / 100);
        } else if (mainLocked && main && main.type === 'points'){
          pointsAmount = Number(main.amountEUR || 0);
        }
        const paySubtotal = Math.max(0, subtotalRaw - discountAmount - pointsAmount);
        qs.push(`pay_subtotal=${encodeURIComponent(paySubtotal.toFixed(2))}`);

        // 4) Free shipping reward (if applied)
        if (shipLocked) qs.push('free_shipping=1');

        // Keep IDs (optional; useful later)
        if (mainLocked) qs.push(`reward=${encodeURIComponent(String(main.id))}`);
        if (shipLocked) qs.push(`ship=${encodeURIComponent(String(ship.id))}`);

        ck.href = qs.length ? `checkout.html?${qs.join('&')}` : 'checkout.html';
      }


      // Apply button
      const btn = $('btnApplyBenefits');
      if (btn){
        const wantMain = !mainLocked && ((chkPts && chkPts.checked) || (chkDis && chkDis.checked));
        const wantShip = !shipLocked && (chkShip && chkShip.checked);
        btn.disabled = !(wantMain || wantShip);
      }
    }

async function applySelectedBenefits(){
      const api = window.VW_API;
      const msg = $('rewardAppliedMsg');
      if (!api || !api.apiJson){
        if (msg) msg.textContent = '‚ö†Ô∏è API is not available.';
        return;
      }

      const chkPts = $('benefitPoints');
      const chkDis = $('benefitDiscount');
      const chkShip = $('benefitShipping');

      const usePoints = !!(chkPts && chkPts.checked);
      const useDiscount = !!(chkDis && chkDis.checked);
      const useShipping = !!(chkShip && chkShip.checked);

      if (usePoints && useDiscount){
        if (msg) msg.textContent = '‚ö†Ô∏è Choose either Points or % Discount (not both).';
        return;
      }

      // Apply main (points OR discount)
      try{
        if (!(state.appliedValueReward && state.appliedValueReward.id)){
          if (usePoints){
            const beforePts = Number(state.points || 0);
            if (beforePts <= 0){
              if (msg) msg.textContent = '‚ö†Ô∏è You have no points to use.';
            } else {
              const res = await api.apiJson('/rewards/apply-points', { method:'POST', body: { points: beforePts } });
              if (res && typeof res.points === 'number') state.points = res.points;

              const red = res.redemption || res.appliedReward || res.applied_reward || res;
              state.appliedValueReward = {
                id: red.id || red.redemption_id || red.redemptionId,
                type: 'points',
                amountEUR: Number(red.amountEUR || red.amount_eur || red.amount || 0),
                pointsUsed: Number(red.pointsUsed || red.points_used || beforePts || 0),
                percent: 0,
              };
            }
          } else if (useDiscount){
            const res = await api.apiJson('/rewards/apply-discount', { method:'POST', body: {} });
            const red = res.redemption || res.appliedReward || res.applied_reward || res;
            const pct = Number(red.percent || red.value || (state.activeDiscount && state.activeDiscount.percent) || 0);
            state.appliedValueReward = {
              id: red.id || red.redemption_id || red.redemptionId,
              type: 'discount',
              amountEUR: 0,
              pointsUsed: 0,
              percent: pct,
            };
            // discount consumed
            state.activeDiscount = null;
          }
        }
      } catch(err){
        if (msg) msg.textContent = `‚ö†Ô∏è Could not apply selection: ${err.message || err}`;
      }

      // Apply free shipping (can be combined)
      try{
        if (useShipping && !(state.appliedShippingReward && state.appliedShippingReward.id)){
          const res = await api.apiJson('/rewards/apply-shipping', { method:'POST', body: {} });
          const red = res.redemption || res.appliedShipping || res.applied_shipping || res;
          state.appliedShippingReward = {
            id: red.id || red.redemption_id || red.redemptionId || red.shipping_id || red.shippingId,
            type: 'shipping',
          };
          // shipping consumed
          state.activeShipping = null;
        }
      } catch(err){
        if (msg) msg.textContent = `‚ö†Ô∏è Could not apply free shipping: ${err.message || err}`;
      }

      renderCart();
      if (typeof renderHero === 'function') renderHero();
    }

function statusToStepIndex(status){
      const s = String(status || '').toLowerCase();
      if (s.includes('deliv')) return 4;
      if (s.includes('on the way') || s.includes('shipping') || s.includes('shipped')) return 3;
      if (s.includes('prepar') || s.includes('process')) return 2;
      return 1; // confirmed
    }

    function renderOrders(){
      const orders = Array.isArray(state.orders) ? state.orders : [];
      const wrap = $('ordersList');
      if (!wrap) return;

      if (!orders.length){
        wrap.innerHTML = `<div class="muted" style="font-weight:700;">No orders found.</div>`;
        return;
      }

      wrap.innerHTML = orders.map(o => {
        const step = statusToStepIndex(o.status);
        const pct = ((step-1)/3)*100;

        return `
          <div class="card" style="margin:0;">
            <div class="row">
              <div>
                <div style="font-weight:900">${o.id || '#‚Äî'}</div>
                <div class="muted" style="margin-top:4px">${o.date || ''} ‚Ä¢ ${fmtEUR(o.total || 0)}</div>
              </div>
              <span class="pill"><strong>${o.status || 'Confirmed'}</strong></span>
            </div>

            <div class="stepper-line"><span style="width:${pct}%;"></span></div>

            <div class="stepper" aria-label="Order progress">
              <div class="step ${step>=1?'done':''}">Confirmed</div>
              <div class="step ${step>=2?'done':''}">Processing</div>
              <div class="step ${step>=3?'done':''}">On the way</div>
              <div class="step ${step>=4?'done':''}">Delivered</div>
            </div>

            <div class="muted" style="margin-top:10px; font-weight:700;">
              Tracking: <strong>${o.tracking || '‚Äî'}</strong>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderCashback(){
      setText('cashBalance', fmtEUR(pointsToCash(state.points || 0)));
      setText('pointsBalance', String(state.points || 0));

      const list = Array.isArray(state.cashbackHistory) ? state.cashbackHistory : [];
      const wrap = $('cashHistory');
      if (!wrap) return;

      if (!list.length){
        wrap.innerHTML = `<div class="muted" style="font-weight:700;">No activity yet.</div>`;
        return;
      }

      wrap.innerHTML = list.map(h => {
        const delta = Number(h.delta || 0);
        const sign = delta >= 0 ? '+' : '';
        const color = delta >= 0 ? '#2e3a12' : '#6b1710';
        return `
          <div class="card" style="margin:0;">
            <div class="row">
              <div>
                <div style="font-weight:900">${h.title || 'Activity'}</div>
                <div class="muted" style="margin-top:4px">${h.date || ''} ‚Ä¢ ${h.detail || ''}</div>
              </div>
              <span class="pill" style="border-color:rgba(0,0,0,.06)">
                <strong style="color:${color}">${sign}${delta} pts</strong>
              </span>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderAll(){
      renderHero();
      renderAccount();
      renderAddresses();
      renderCart();
      renderOrders();
      renderCashback();
      setText('year', new Date().getFullYear());
    }

    // ====== A√ß√µes ======
    window.editAddress = function(id){
      const a = (state.addresses||[]).find(x => x.id === id);
      if (!a) return;
      const line1 = prompt('Street / Line 1:', a.line1 || '');
      if (line1 === null) return;
      const line2 = prompt('City / Line 2:', a.line2 || '');
      if (line2 === null) return;
      const country = prompt('Country:', a.country || '');
      if (country === null) return;
      a.line1 = line1; a.line2 = line2; a.country = country;
      setText('addrMsg', '‚úÖ Address updated.');
      renderAddresses();
    };

    window.deleteAddress = function(id){
      if (!confirm('Delete this address?')) return;
      state.addresses = (state.addresses||[]).filter(a => a.id !== id);
      setText('addrMsg', '‚úÖ Address deleted.');
      renderAddresses();
    };

    window.removeCartItem = function(id){
      state.cart = (state.cart||[]).filter(it => String(it.id) !== String(id));
      saveLocalCart();
      renderCart();
    };

    function clearCart(){
      if (!confirm('Clear the cart?')) return;
      // Clear the SAME cart used by the Store (so they stay in sync).
      state.cart = [];
      try{ localStorage.setItem(chooseActiveCartKey(), JSON.stringify([])); }catch(_){ }
      try{ localStorage.setItem(CART_GUEST_KEY, JSON.stringify([])); }catch(_){ }
      renderCart();
    }

    // Avatar picker (somente na Account)
    function setAvatarFileName(name){
      $('avatarFileName').innerHTML = `<strong>${name || '‚Äî'}</strong>`;
    }

    function openAvatarPicker(){
      const input = $('avatarFileInput');
      input.value = '';
      input.click();
    }

    async function setAvatar(file){
      if (!file) return;
      state.avatarFile = file;
      setAvatarFileName(file.name);
      // preview imediato
      const url = URL.createObjectURL(file);
      state.me.avatar = url;
      renderHero();
      setText('accountMsg', '‚úÖ Photo updated.');
    }

    // Salvar conta (demo)
    function saveAccount(){
      const name = $('accName').value.trim();
      const email = $('accEmail').value.trim();
      const phone = $('accPhone').value.trim();
      state.me.name = name || state.me.name;
      state.me.email = email || state.me.email;
      state.me.phone = phone || state.me.phone;
      setText('accountMsg', '‚úÖ Changes saved.');
      renderHero();
    }

    // Senha (demo)
    function changePassword(){
      const n1 = $('passNew').value.trim();
      const n2 = $('passConfirm').value.trim();

      if (!n1 || n1.length < 6){
        setText('passMsg', 'Use at least 6 characters.');
        return;
      }
      if (n1 !== n2){
        setText('passMsg', "Confirmation doesn't match.");
        return;
      }
      $('passCurrent').value = '';
      $('passNew').value = '';
      $('passConfirm').value = '';
      setText('passMsg', '‚úÖ Password updated.');
    }

    // Wheel (demo)
    let spinning = false;
    const PRIZES = [
      { label:'‚Ç¨20',         type:'cash',       value:20 },
      { label:'5% OFF',      type:'discount',   value:5  },
      { label:'10% OFF',     type:'discount',   value:10 },
      { label:'10 POINTS',   type:'points',     value:10 },
      { label:'FREE SHIPPING', type:'shipping', value:1  },
      { label:'EXTRA SPIN',  type:'extra_spin', value:1  },
    ];

    function animateWheel(){
      return new Promise((resolve) => {
        const el = $('wheelVisual');
        if (!el) return resolve();
        const turns = 5 + Math.random() * 3;
        el.style.transition = 'transform 2.2s cubic-bezier(.2,.9,.2,1)';
        el.style.transform = `rotate(${turns * 360}deg)`;
        setTimeout(() => {
          el.style.transition = '';
          resolve();
        }, 2300);
      });
    }

    async function spin(){
      if (spinning) return;
      if (state.spinsLeftToday <= 0){
        setText('spinResultMsg', "You've already used today's spins.");
        return;
      }

      spinning = true;
      setText('spinResultMsg', 'Spinning‚Ä¶');
      try{
        await animateWheel();

        const prize = PRIZES[Math.floor(Math.random()*PRIZES.length)];

        state.spinsLeftToday -= 1;
        if (prize.type === 'points'){
          state.points = Number(state.points||0) + Number(prize.value||0);
          state.cashbackHistory.unshift({ date: new Date().toISOString().slice(0,10), title:'Credit', delta:+Number(prize.value||0), detail:'Wheel' });
        } else if (prize.type === 'cash'){
          const pts = Math.round((Number(prize.value||0) / 0.5)); // ‚Ç¨20 => 40 pts
          state.points = Number(state.points||0) + pts;
          state.cashbackHistory.unshift({ date: new Date().toISOString().slice(0,10), title:'Credit', delta:+pts, detail:'Wheel (+‚Ç¨20)' });
        } else if (prize.type === 'extra_spin'){
          state.spinsLeftToday += 1;
        }

        renderAll();
        setText('spinResultMsg', `üéÅ ${prize.label}`);
      } finally {
        spinning = false;
      }
    }

    function addAddress(){
      const name = prompt('Address name (e.g., Home):', 'Home');
      if (name === null) return;
      const line1 = prompt('Street / Line 1:', '');
      if (line1 === null) return;
      const line2 = prompt('City / Line 2:', '');
      if (line2 === null) return;
      const country = prompt('Country:', 'Ireland');
      if (country === null) return;

      state.addresses.unshift({ id: 'a' + Math.random().toString(16).slice(2), name, line1, line2, country });
      setText('addrMsg', '‚úÖ Address added.');
      renderAddresses();
    }

    function logout(){
  if(window.VintageAuth && typeof window.VintageAuth.logout==='function'){
    window.VintageAuth.logout();
    return;
  }
  localStorage.removeItem('vw_token');
  window.location.href = 'cliente-login-2.html';
}

    // ====== Dados demo ======
    function loadDemo(){
      // Clean defaults (demo)
      state.me = {
        name: '',
        email: '',
        phone: '',
        avatar: defaultAvatarDataUri(),
      };

      state.spentTotal = 0;
      state.spentMonth = 0;
      state.points = 0;

      state.spinsLeftToday = 1;

      // Cart comes from the Store localStorage (it must transit between pages).
      loadLocalCart();
      state.orders = [];
      state.cashbackHistory = [];
      state.addresses = [];

      setText('accountMsg', '‚Äî');
      setText('addrMsg', '‚Äî');
      setText('passMsg', '‚Äî');
      setText('spinResultMsg', '‚Äî');

      renderAll();
    }

    // ====== Eventos ======
    document.addEventListener('DOMContentLoaded', () => {
      loadDemo();

      $('btnPickAvatar')?.addEventListener('click', openAvatarPicker);
      $('avatarFileInput')?.addEventListener('change', (e) => {
        const file = e.target.files ? e.target.files[0] : null;
        if (file) setAvatar(file);
      });

      $('btnSaveAccount')?.addEventListener('click', saveAccount);
      $('btnChangePass')?.addEventListener('click', changePassword);
      $('btnAddAddress')?.addEventListener('click', addAddress);
      $('btnClearCart')?.addEventListener('click', clearCart);

      $('btnApplyBenefits')?.addEventListener('click', applySelectedBenefits);
      $('btnLogout')?.addEventListener('click', logout);

      $('btnSpin')?.addEventListener('click', spin);
});

    // ======= Campo reativo dourado =======
    (() => {
      const MAX_PARTICLES_BASE = 120;
      const LINK_DIST = 170;
      const SAFETY_MARGIN = 22;
      const MOUSE_REPEL_RADIUS = 120 + SAFETY_MARGIN;
      const MOUSE_FORCE = 0.14;
      const SPEED = 0.55;
      const FRICTION = 0.965;

      const canvas = document.getElementById('reactiveField');
      if (!canvas) return;
      const ctx = canvas.getContext('2d', { alpha: true });
      let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      let W = 0, H = 0;

      function resize(){
        W = canvas.clientWidth = window.innerWidth;
        H = canvas.clientHeight = window.innerHeight;
        canvas.width = Math.floor(W * DPR);
        canvas.height = Math.floor(H * DPR);
        ctx.setTransform(DPR,0,0,DPR,0,0);
      }
      resize();

      window.addEventListener('resize', () => {
        DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        resize();
        init();
      });

      const pts = [];
      function rand(min,max){ return Math.random()*(max-min)+min; }

      function init(){
        pts.length = 0;
        const area = W * H;
        const max = Math.max(70, Math.min(MAX_PARTICLES_BASE, Math.floor(area / 14000)));
        for (let i=0;i<max;i++){
          pts.push({
            x: rand(0,W),
            y: rand(0,H),
            vx: rand(-SPEED, SPEED),
            vy: rand(-SPEED, SPEED),
            r: rand(1.2, 2.2),
          });
        }
      }
      init();

      const mouse = { x: -9999, y: -9999, active: false };
      window.addEventListener('mousemove', (e) => { mouse.x = e.clientX; mouse.y = e.clientY; mouse.active = true; });
      window.addEventListener('mouseleave', () => { mouse.active = false; mouse.x = -9999; mouse.y = -9999; });

      function draw(){
        ctx.clearRect(0,0,W,H);

        for (const p of pts){
          if (mouse.active){
            const dx = p.x - mouse.x;
            const dy = p.y - mouse.y;
            const d2 = dx*dx + dy*dy;
            if (d2 < MOUSE_REPEL_RADIUS*MOUSE_REPEL_RADIUS){
              const d = Math.sqrt(d2) || 1;
              const f = (1 - d / MOUSE_REPEL_RADIUS) * MOUSE_FORCE;
              p.vx += (dx / d) * f;
              p.vy += (dy / d) * f;
            }
          }

          p.vx *= FRICTION;
          p.vy *= FRICTION;

          p.x += p.vx;
          p.y += p.vy;

          if (p.x < -20) p.x = W + 20;
          if (p.x > W + 20) p.x = -20;
          if (p.y < -20) p.y = H + 20;
          if (p.y > H + 20) p.y = -20;
        }

        for (let i=0;i<pts.length;i++){
          for (let j=i+1;j<pts.length;j++){
            const a = pts[i], b = pts[j];
            const dx = a.x - b.x;
            const dy = a.y - b.y;
            const d = Math.sqrt(dx*dx + dy*dy);
            if (d < LINK_DIST){
              const alpha = (1 - d/LINK_DIST) * 0.22;
              ctx.strokeStyle = `rgba(212,175,55,${alpha})`;
              ctx.lineWidth = 1;
              ctx.beginPath();
              ctx.moveTo(a.x,a.y);
              ctx.lineTo(b.x,b.y);
              ctx.stroke();
            }
          }
        }

        for (const p of pts){
          ctx.fillStyle = 'rgba(212,175,55,0.35)';
          ctx.beginPath();
          ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
          ctx.fill();
        }

        requestAnimationFrame(draw);
      }
      draw();
    })();
  </script>
<script>
(function(){
  const API_ROOT = "https://clientes-0r5d.onrender.com";
  const TOKEN_KEYS = ["vw_token","token","authToken","auth_token","access_token"];

  function getToken(){
    for (const k of TOKEN_KEYS){
      try {
        const t = localStorage.getItem(k);
        if (t) return t;
      } catch (_) {}
    }
    return null;
  }

  function requireTokenOrRedirect(){
    const t = getToken();
    if (!t) {
      window.location.href = "cliente-login-2.html";
    }
    return t;
  }

  function authHeaders(){
    const t = getToken();
    return t ? { Authorization: "Bearer " + t } : {};
  }



  async function apiJson(path, opts = {}){
    const url = API_ROOT + path;
    const init = {
      method: opts.method || 'GET',
      headers: {
        'Content-Type': 'application/json',
        ...(opts.headers || {}),
        ...authHeaders(),
      },
    };
    if (opts.body !== undefined) init.body = (typeof opts.body === 'string') ? opts.body : JSON.stringify(opts.body);

    const res = await fetch(url, init);
    if (res.status === 401 || res.status === 403){
      requireTokenOrRedirect();
      throw new Error('unauthorized');
    }

    const text = await res.text();
    let data = null;
    try{ data = text ? JSON.parse(text) : null; } catch(_){ data = text; }

    if (!res.ok){
      const msg = (data && (data.error || data.message)) || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  function syncPointsUI(points){
    const p = document.getElementById('pointsNow');
    if (p) p.textContent = String(points ?? 0);
    const cash = document.getElementById('cashValue');
    if (cash){
      const eur = (Number(points||0) * 0.5);
      cash.textContent = '= ‚Ç¨ ' + eur.toFixed(2);
    }
  }

  async function loadRewardsStatus(){
    try{
      const data = await apiJson('/rewards/status', { method:'GET' });

      const points = Number(data?.points ?? data?.user?.points ?? 0);
      if (typeof state !== 'undefined') state.points = points;

      const ad = data?.activeDiscount || data?.active_discount || null;
      if (typeof state !== 'undefined'){
        state.activeDiscount = ad ? {
          id: ad.id ?? ad.discount_id ?? ad.discountId ?? null,
          percent: Number(ad.percent ?? ad.value ?? 0),
          expiresAt: ad.expiresAt || ad.expires_at || ad.expires || null,
        } : null;
      }

      const sh = data?.activeShipping || data?.active_shipping || null;
      if (typeof state !== 'undefined'){
        state.activeShipping = sh ? {
          id: sh.id ?? sh.shipping_id ?? sh.shippingId ?? null,
          expiresAt: sh.expiresAt || sh.expires_at || sh.expires || null,
        } : null;
      }

      // aplicados (opcional; depende do teu backend)
      let main = data?.appliedValueReward || data?.appliedReward || data?.applied_redemption || data?.redemption || null;
      let shipRed = data?.appliedShipping || data?.applied_shipping || data?.shippingRedemption || data?.shipping_redemption || null;

      const arr = data?.appliedRewards || data?.applied_rewards || data?.redemptions || null;
      if (Array.isArray(arr)){
        for (const r of arr){
          const t = String(r?.type || '');
          if (!main && (t === 'points' || t === 'discount')) main = r;
          if (!shipRed && (t === 'shipping' || t === 'free_shipping')) shipRed = r;
        }
      }

      if (typeof state !== 'undefined'){
        state.appliedValueReward = null;
        if (main && (main.type === 'points' || main.type === 'discount')){
          state.appliedValueReward = {
            id: main.id ?? main.redemption_id ?? main.redemptionId ?? null,
            type: main.type || null,
            amountEUR: Number(main.amountEUR ?? main.amount_eur ?? 0),
            pointsUsed: Number(main.pointsUsed ?? main.points_used ?? 0),
            percent: Number(main.percent ?? main.discount_percent ?? 0),
          };
        }

        state.appliedShippingReward = null;
        if (shipRed){
          state.appliedShippingReward = {
            id: shipRed.id ?? shipRed.redemption_id ?? shipRed.redemptionId ?? shipRed.shipping_id ?? shipRed.shippingId ?? null,
            type: 'shipping',
          };
        }
      }

      syncPointsUI(points);
      if (typeof renderAll === 'function') renderAll();
      if (typeof renderCart === 'function') renderCart();

      return data;
    } catch(err){
      console.warn('Rewards status not loaded:', err?.message || err);
      return null;
    }
  }

  window.VW_API = window.VW_API || {};
  window.VW_API.root = API_ROOT;
  window.VW_API.apiJson = apiJson;
  window.VW_API.loadRewardsStatus = loadRewardsStatus;
  window.VW_API.applyPoints = (points) => apiJson('/rewards/apply-points', { method:'POST', body:{ points } });
  window.VW_API.applyDiscount = () => apiJson('/rewards/apply-discount', { method:'POST', body:{} });
  window.VW_API.applyShipping = () => apiJson('/rewards/apply-shipping', { method:'POST', body:{} });
  window.VW_API.grantDiscount = (percent) => apiJson('/rewards/grant-discount', { method:'POST', body:{ percent } });
  window.VW_API.creditPoints = (points, source='wheel') => apiJson('/rewards/credit-points', { method:'POST', body:{ points, source } });
  window.VW_API.checkoutCreate = (payload) => apiJson('/checkout/create', { method:'POST', body: payload || {} });

  function defaultAvatarDataUri(){
    const svg = encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="240" height="240" viewBox="0 0 240 240">
        <defs>
          <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
            <stop stop-color="#D4AF37" stop-opacity="0.35"/>
            <stop stop-color="#f0b43b" stop-opacity="0.18" offset="1"/>
          </linearGradient>
        </defs>
        <rect width="240" height="240" rx="120" fill="url(#g)"/>
        <circle cx="120" cy="92" r="44" fill="rgba(43,39,35,0.16)"/>
        <path d="M48 212c14-46 50-68 72-68s58 22 72 68" fill="rgba(43,39,35,0.14)"/>
      </svg>
    `);
    return `data:image/svg+xml;charset=utf-8,${svg}`;
  }

  function applyAvatar(user){
    const img = document.getElementById("avatar");
    if (!img) return;

    const raw = (user && (user.avatar_url || user.avatar || user.avatarUrl || user.photo_url || user.photoUrl)) || "";

    if (!raw) {
      img.src = defaultAvatarDataUri();
      return;
    }

    let url = String(raw);
    if (!/^https?:\/\//i.test(url)) {
      if (!url.startsWith("/")) url = "/" + url;
      url = API_ROOT + url;
    }

    // cache-bust so the new photo appears immediately
    url += (url.includes("?") ? "&" : "?") + "v=" + Date.now();
    img.src = url;
  }

  async function loadProfile(){
    requireTokenOrRedirect();

    try {
      const res = await fetch(API_ROOT + "/user/me", { headers: authHeaders() });

      if (res.status === 401 || res.status === 403) {
        requireTokenOrRedirect();
        return;
      }

      if (!res.ok) {
        console.warn("Failed to load /user/me:", res.status);
        return;
      }

      const user = await res.json();

      try{ state.me = user; }catch(_){ }
      try{ if (user && (user.id ?? user.user_id ?? user.userId)) localStorage.setItem('vw_user_id', String(user.id ?? user.user_id ?? user.userId)); }catch(_){ }
      // Re-load cart using the logged-in user id (so it maps to vw_cart_u_<id>)
      loadLocalCart();
      renderCart();

      const nameEl = document.getElementById("userName");
      const emailEl = document.getElementById("userEmail");

      if (nameEl) nameEl.textContent = user.name || "Your Name";
      if (emailEl) emailEl.textContent = user.email || "email@example.com";

      applyAvatar(user);
      // Load rewards (points + discount + free shipping) from the backend
      loadRewardsStatus();
    } catch (err) {
      console.error("Error loading /user/me", err);
    }
  }

  document.addEventListener("DOMContentLoaded", loadProfile);
})();
</script>

</body>
</html>