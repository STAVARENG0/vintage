<!DOCTYPE html>
<html lang="en-IE">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer Dashboard - My Cart</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>

  <meta http-equiv="Cache-Control" content="no-store" />

  <style>
    :root{
      --cream:#f6f1e7;
      --cream-2:#f3e9d8;
      --text:#2b2723;
      --muted:#7c6f63;
      --card:#ffffff;

      --gold:#D4AF37;
      --gold-soft: rgba(212,175,55,.55);

      --border:#e0d5c2;
      --shadow:0 18px 42px rgba(0,0,0,.32);
      --radius:22px;

      --btn-bg: rgba(255,255,255,.88);
      --btn-text: #3b2206;

      --bronze:#cd7f32;
      --silver:#c0c0c0;
      --gold2:#D4AF37;
    }

    *{ box-sizing:border-box; }
    html{ scroll-behavior:smooth; }
    body{
      margin:0;
      font-family: Poppins, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: linear-gradient(135deg,#fdf4e3,#f1dfc2,#e3c395);
      color: var(--text);
      min-height: 100dvh;
      padding: 22px 10px 40px;
    }

    /* Fundo reativo */
    #reactiveField{ position:fixed; inset:0; z-index:0; pointer-events:none; }

    .wrap{
      position:relative; z-index:1;
      max-width: 1100px;
      margin: 0 auto;
    }

    .glass{
      background: linear-gradient(135deg,rgba(253,244,227,0.10),rgba(241,223,194,0.08),rgba(227,195,149,0.14));
      backdrop-filter: saturate(120%) blur(6px);
      -webkit-backdrop-filter: saturate(120%) blur(6px);
      border:1px solid rgba(212,175,55,.55);
      border-radius: 28px;
      box-shadow: var(--shadow), 0 0 26px rgba(212,175,55,.22);
    }

    header{
      padding: 16px 18px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .top-left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 180px;
    }
    .top-left small{
      color: var(--muted);
      font-weight: 700;
      letter-spacing:.04em;
    }

    .btn{
      appearance:none;
      border:1px solid var(--gold-soft);
      background: var(--btn-bg);
      color: var(--btn-text);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,.10);
      transition: transform .15s ease, filter .15s ease, background .15s ease, border-color .15s ease;
      text-decoration:none;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      filter: brightness(1.03);
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.95), transparent 60%),
        linear-gradient(120deg, rgba(212,175,55,.22), rgba(240,180,59,.22));
      border-color: rgba(212,175,55,.75);
    }
    .btn:active{ transform: translateY(0); filter: brightness(.99); }
    .btn.small{ padding: 8px 12px; font-weight: 900; }
    .btn.primary{
      background: linear-gradient(120deg, rgba(212,175,55,.25), rgba(240,180,59,.25));
    }
    .btn.danger{
      border-color: rgba(179,59,46,.35);
      color: #7a1f16;
    }

    .divider{
      height:2px;
      background: linear-gradient(90deg, transparent, rgba(212,175,55,.95), transparent);
      border-radius: 999px;
      box-shadow: 0 10px 22px rgba(212,175,55,.20);
      margin: 0 18px;
    }

    /* "Landing" */
    .page{
      padding: 14px;
    }

    .hero{
      padding: 16px;
      border-radius: var(--radius);
    }

    .hero-center{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
      text-align:center;
      padding: 10px 10px 6px;
    }

    .hero-title{
      margin:0;
      font-family: Orbitron, Poppins, system-ui, sans-serif;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size: 20px;
    }

    .avatar-wrap{
      width: 160px; height: 160px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.92), rgba(255,255,255,.55));
      border: 2px solid rgba(212,175,55,.92);
      box-shadow: 0 18px 40px rgba(0,0,0,.18), 0 0 20px rgba(212,175,55,.18);
      display:flex; align-items:center; justify-content:center;
      position: relative;
      overflow:hidden;
    }
    .avatar-wrap img{
      width: 144px; height: 144px;
      border-radius: 999px;
      object-fit: cover;
      display:block;
      background: linear-gradient(135deg, rgba(212,175,55,.20), rgba(240,180,59,.15));
      border: 1px solid rgba(0,0,0,.05);
    }

    .name{
      margin: 0;
      font-weight: 900;
      font-size: 18px;
    }
    .sub{
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    /* Level bar (3 tiers) */
    .level-wrap{
      width: min(520px, 94%);
      margin-top: 2px;
    }

    .level-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.76);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      font-weight: 900;
      letter-spacing:.06em;
      text-transform: uppercase;
      color: #3b2206;
    }

    .badge-dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--bronze);
      box-shadow: 0 0 0 4px rgba(205,127,50,.12);
    }

    .level-bar{
      height: 14px;
      border-radius: 999px;
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.06);
      overflow:hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.08);
      position:relative;
    }
    .level-fill{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(205,127,50,.95), rgba(205,127,50,.78));
      transition: width .35s ease, filter .35s ease;
    }
    .level-splits{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top: 8px;
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 11px;
      color: var(--muted);
    }
    .level-splits span{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .level-splits i{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.10);
      display:inline-block;
    }
    .level-splits .on{ color: var(--text); }
    .level-splits .on i{ background: var(--bronze); }
    .level-splits .on.silver i{ background: var(--silver); }
    .level-splits .on.gold i{ background: var(--gold2); }

    /* Navigation */
    .nav{
      margin: 14px auto 0;
      width: min(900px, 100%);
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:center;
    }
    .nav .btn{ font-weight: 900; }

    /* Cards */
    .grid{
      width: min(980px, 100%);
      margin: 14px auto 0;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid rgba(224,213,194,.9);
      background: rgba(255,255,255,.78);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .muted{ color: var(--muted); }

    .stat{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-height: 72px;
    }
    .stat .k{
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 900;
    }
    .stat .v{
      font-size: 22px;
      font-weight: 900;
      line-height: 1.1;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.02);
      border: 1px solid rgba(0,0,0,.06);
      color: var(--muted);
      font-weight: 800;
      font-size: 12px;
    }
    .pill strong{ color: var(--text); }

    /* Wheel (always visible) */
.wheel-area{
  width: min(980px, 100%);
  margin: 12px auto 0;
}

.wheel-stack{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 12px;
  margin-top: 10px;
  text-align:center;
}

.wheel-box{
  position:relative;
  width: min(340px, 82vw);
  aspect-ratio: 1 / 1;
  margin: 0 auto;
}

.wheel-rotate{
  width:100%;
  height:100%;
  border-radius: 999px;
  overflow:hidden;
  box-shadow: 0 22px 60px rgba(0,0,0,.16), 0 0 20px rgba(212,175,55,.12);
  border: 2px solid rgba(212,175,55,.85);
  background: rgba(255,255,255,.35);
  transform: rotate(0deg);
}

.wheel-box::after{
  content:"";
  position:absolute;
  inset: 20%;
  border-radius: 999px;
  background: rgba(255,255,255,.70);
  border: 1px solid rgba(0,0,0,.06);
  box-shadow: inset 0 4px 18px rgba(0,0,0,.10);
  pointer-events:none;
  z-index: 2;
}

#wheelCanvas{
  width:100%;
  height:100%;
  display:block;
  position:relative;
  z-index: 1;
}

.pointer{
  position:absolute;
  top: -12px;
  left: 50%;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 14px solid transparent;
  border-right: 14px solid transparent;
  border-bottom: 22px solid rgba(255,122,26,.92);
  filter: drop-shadow(0 8px 14px rgba(0,0,0,.18));
  z-index: 3;
  pointer-events:none;
}

.wheel-instructions{
  max-width: 680px;
  line-height: 1.7;
}

    /* Sections */
    section{
      width: min(980px, 100%);
      margin: 14px auto 0;
      scroll-margin-top: 90px;
    }
    .section-title{
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .04em;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin: 10px 0;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .field input, .field textarea, .field select{
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(212,175,55,.55);
      background: rgba(255,255,255,.92);
      outline:none;
      font-weight: 600;
      resize: vertical;
    }
    .field textarea{ border-radius: 18px; min-height: 88px; }

    /* Orders - barra de processo */
    .stepper{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 10px;
      align-items:center;
    }
    .step{
      text-align:center;
      font-weight: 900;
      font-size: 11px;
      letter-spacing:.08em;
      text-transform: uppercase;
      color: var(--muted);
      position:relative;
      padding-top: 18px;
    }
    .step::before{
      content:"";
      position:absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(0,0,0,.08);
    }
    .step.done{ color: var(--text); }
    .step.done::before{
      background: linear-gradient(120deg, rgba(212,175,55,.95), rgba(240,180,59,.95));
      border-color: rgba(212,175,55,.8);
      box-shadow: 0 0 0 4px rgba(212,175,55,.14);
    }
    .stepper-line{
      height: 10px;
      margin-top: 10px;
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 999px;
      overflow:hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.08);
    }
    .stepper-line span{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(212,175,55,.9), rgba(240,180,59,.9));
    }

    /* Lista simples */
    .list{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    footer{
      margin-top: 16px;
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      padding-bottom: 6px;
    }

    .hidden{ display:none !important; }

    /* Rewards selectors: show as a 'bolinha' (radio-like) */
    #rewardsBox input[type="checkbox"]{
      -webkit-appearance:none;
      appearance:none;
      width:18px;
      height:18px;
      border:2px solid rgba(212,175,55,.78);
      border-radius:999px;
      margin-top:3px;
      background:rgba(255,255,255,.70);
      box-shadow: inset 0 0 0 3px rgba(255,255,255,.92);
      flex:0 0 auto;
    }
    #rewardsBox input[type="checkbox"]:checked{
      background: rgba(212,175,55,1);
      box-shadow: inset 0 0 0 4px rgba(255,255,255,.96);
    }
    #rewardsBox input[type="checkbox"]:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    #rewardsBox label[aria-disabled="true"]{
      opacity:.55;
      cursor:not-allowed;
    }

  </style>
</head>

<body>
  <canvas id="reactiveField" aria-hidden="true"></canvas>

  <div class="wrap">
    <div class="glass">
      <header>
        <div class="top-left">
          <small>Vintage Wear Ireland</small>
</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <a class="btn small" href="painel.html" title="Back to dashboard home">üè† Dashboard Home</a>
          <a class="btn small" href="index.html" title="Back to store">üõçÔ∏è Store</a>
        </div>
      </header>

      <div class="divider"></div>

      <div class="page">
        <!-- HERO -->
        <div class="hero glass">
          <div class="hero-center">
            <h1 class="hero-title">Customer Dashboard</h1>

<!-- Nav buttons -->
            <div class="nav" aria-label="Shortcuts">
              <a class="btn small" href="conta.html">üë§ Account</a>
              <a class="btn small primary" href="carrinho.html">üõí My cart</a>
              <a class="btn small" href="pedidos.html">üì¶ Orders</a>
            </div>


            <div class="avatar-wrap" aria-label="Profile photo (circular)">
              <img id="avatar" alt="User photo" />
            </div>

            <p class="name" id="userName">Your Name</p>
            <p class="sub" id="userEmail">email@example.com</p>

            <!-- Barra de n√≠vel -->
            <div class="level-wrap" aria-label="Customer level">
              <div class="level-head">
                <div class="badge"><span class="badge-dot" id="levelDot"></span> <span id="levelLabel">Bronze</span></div>
                <span class="pill"><strong id="levelProgressText">‚Ç¨0</strong> this month</span>
              </div>

              <div class="level-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                <div class="level-fill" id="levelFill"></div>
              </div>

              <div class="level-splits" aria-label="Bronze, Silver and Gold">
                <span id="lvlBronze" class="on"><i></i> Bronze</span>
                <span id="lvlSilver"><i></i> Silver</span>
                <span id="lvlGold"><i></i> Gold</span>
              </div>
              <div class="muted" style="margin-top:8px; font-weight:700;" id="levelHint">Fill the bar to level up.</div>
            </div>


          </div>
        </div>

        <!-- CARRINHO -->
        <section id="carrinho">
          <h2 class="section-title">My cart</h2>

          <div class="grid">
            <div class="card">
              <div class="row">
                <strong>Items</strong>
                <span class="pill" id="cartCountTag"><strong>0</strong> items</span>
              </div>
              <div class="list" id="cartList"></div>
            </div>

            <div class="card">
              <div class="row">
                <strong>Total</strong>
                <span class="pill" id="cartTotalTag"><strong>‚Ç¨0</strong></span>
              </div>

              <div class="muted" style="margin-top:10px; line-height:1.7;">
                Your cart is saved to your account and will appear here when you sign in.
              </div>
              <!-- REWARDS -->
              <div style="margin-top:14px; padding-top:12px; border-top:1px dashed rgba(212,175,55,.45);" id="rewardsBox">
                <div style="font-weight:900; letter-spacing:.04em;">Rewards</div>
                <div class="muted" style="margin-top:6px; line-height:1.6;">
                  Choose your reward. You can use only <strong>one</strong>: <strong>Free Shipping</strong> OR <strong>Points</strong> OR <strong>Discount</strong>.
                </div>

                <div style="margin-top:10px; display:flex; flex-direction:column; gap:10px;">
                  <label style="display:flex; gap:10px; align-items:flex-start; cursor:pointer;">
                    <input type="checkbox" id="benefitPoints" />
                    <span>
                      <div style="font-weight:900;">Use points (use full balance)</div>
                      <div class="muted" style="margin-top:2px; font-weight:700;">
                        Balance: <strong><span id="pointsBalanceCart">0</span> pts</strong> (<span id="pointsCashCart">‚Ç¨ 0.00</span>)
                      </div>
                    </span>
                  </label>

                  <div id="discountOption">
                    <label style="display:flex; gap:10px; align-items:flex-start; cursor:pointer;">
                      <input type="checkbox" id="benefitDiscount" />
                      <span>
                        <div style="font-weight:900;">Use discount (valid for 24h)</div>
                        <div class="muted" style="margin-top:2px; font-weight:700;">
                          <span class="pill" id="discountPill"><strong id="discountLabel">‚Äî</strong></span>
                        </div>
                        <div class="muted" style="margin-top:6px; font-weight:700;" id="discountExpires"></div>
                      </span>
                    </label>
                  </div>

                  <div id="shippingOption">
                    <label style="display:flex; gap:10px; align-items:flex-start; cursor:pointer;">
                      <input type="checkbox" id="benefitShipping" />
                      <span>
                        <div style="font-weight:900;" id="shippingLabel">Free shipping</div>
                        <div class="muted" style="margin-top:6px; font-weight:700;" id="shippingExpires"></div>
                      </span>
                    </label>
                  </div>
                </div>

                <div class="row" style="margin-top:10px; gap:8px;">
                  <button class="btn small" id="btnApplyBenefits" type="button">Apply</button>
                </div>

                <div class="muted" style="margin-top:10px; font-weight:900;" id="rewardAppliedMsg">‚Äî</div>
                <div class="muted" style="margin-top:10px; line-height:1.8;" id="totalsBreakdown"></div>
              </div>


              <div class="row" style="margin-top:12px;">
                <a class="btn primary" id="btnResumeCheckout" href="checkout.html">‚û°Ô∏è Resume checkout</a>
                <button class="btn danger" id="btnClearCart">Clear cart</button>
              </div>
            </div>
          </div>
        </section>

        <footer>¬© <span id="year"></span> Vintage Wear Ireland</footer>
      </div>
    </div>
  </div>

  <input id="avatarFileInput" type="file" accept="image/*" class="hidden" />
  <script src="auth-guard.js"></script>


  <script>
    // ====== Estado (demo) ======
    const state = {
      me: null,
      spentMonth: 0,
      spentTotal: 0,
      points: 0,
      spinsPerDay: 1,
      spinsLeftToday: 1,
      cart: [],
      orders: [],
      cashbackHistory: [],
      addresses: [],
      avatarFile: null,
      activeDiscount: null, // {id, percent, expiresAt}
      activeShipping: null, // {id, expiresAt?}
      appliedValueReward: null,  // {id, type:'points'|'discount', amountEUR, pointsUsed, percent}
      appliedShippingReward: null, // {id, type:'shipping'}
    };

    // ====== Access token (accepts multiple keys to match the Store) ======
    const TOKEN_KEYS = ["vw_token","token","authToken","auth_token","access_token"];

    function getToken(){
      for (const k of TOKEN_KEYS){
        try{
          const t = localStorage.getItem(k);
          if (t) return t;
        }catch(_){ }
      }
      return null;
    }

    // ====== Local cart (shared with store/menu pages) ======
    const USER_ID_KEY = "vw_user_id";
    const CART_GUEST_KEY = "vw_cart";

    function getUserId(){
      try{
        return (
          (state?.me && (state.me.id ?? state.me.user_id ?? state.me.uid ?? state.me.userId)) ||
          localStorage.getItem(USER_ID_KEY) ||
          localStorage.getItem('user_id') ||
          localStorage.getItem('uid') ||
          localStorage.getItem('userId') ||
          ''
        );
      }catch(_){
        return '';
      }
    }

    function readCartByKey(key){
      try{
        const raw = localStorage.getItem(key);
        if (!raw) return [];
        const v = JSON.parse(raw);
        return Array.isArray(v) ? v : [];
      }catch(_){
        return [];
      }
    }

    function listUserCartKeys(){
      const out = [];
      try{
        for (let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if (k && String(k).startsWith('vw_cart_u_')) out.push(String(k));
        }
      }catch(_){ }
      return out;
    }

    function chooseActiveCartKey(){
      const guest = readCartByKey(CART_GUEST_KEY);
      const tok = getToken();
      const uidRaw = getUserId();
      const uid = uidRaw ? String(uidRaw) : '';
      const candidate = (uid && tok) ? `vw_cart_u_${uid}` : null;
      const candCart = candidate ? readCartByKey(candidate) : [];

      // 1) If a user cart exists with items, use it.
      if (candidate && candCart.length) return candidate;

      // 2) If guest cart has items, keep using it (so Store + Dashboard stay aligned).
      // Also mirror into the user cart (without deleting the guest cart) when possible.
      if (guest.length){
        if (candidate && !candCart.length){
          try{ localStorage.setItem(candidate, JSON.stringify(guest)); }catch(_){ }
        }
        return CART_GUEST_KEY;
      }

      // 3) If logged in but uid differs, pick any existing vw_cart_u_* with items.
      if (tok){
        for (const k of listUserCartKeys()){
          const c = readCartByKey(k);
          if (c.length) return k;
        }
      }

      // 4) Fall back.
      return candidate || CART_GUEST_KEY;
    }

    function loadLocalCart(){
      const key = chooseActiveCartKey();
      const arr = readCartByKey(key);

      // Normalize, but keep ALL original fields (stock, category, etc.) so the Store doesn't break.
      state.cart = (Array.isArray(arr) ? arr : []).map((it) => {
        const obj = (it && typeof it === 'object') ? { ...it } : {};
        const title = obj.title || obj.name || obj.product || 'Product';
        const image = obj.image || obj.img || obj.photo || obj.photo_url || obj.photoUrl || null;
        const qty = Number(obj.qty ?? obj.quantity ?? 1);
        const price = Number(obj.price ?? 0);
        return {
          ...obj,
          id: obj.id ?? obj.product_id ?? obj.productId ?? title,
          title,
          image,
          qty: (Number.isFinite(qty) && qty > 0) ? qty : 1,
          price: Number.isFinite(price) ? price : 0,
        };
      });
    }

    function saveLocalCart(){
      const key = chooseActiveCartKey();
      const normalized = (Array.isArray(state.cart) ? state.cart : []).map((it) => {
        const obj = (it && typeof it === 'object') ? { ...it } : {};
        obj.title = obj.title || obj.name || obj.product || 'Product';
        obj.image = obj.image || obj.img || obj.photo || obj.photo_url || obj.photoUrl || null;
        obj.qty = Number(obj.qty ?? obj.quantity ?? 1);
        if (!Number.isFinite(obj.qty) || obj.qty <= 0) obj.qty = 1;
        obj.price = Number(obj.price ?? 0);
        if (!Number.isFinite(obj.price)) obj.price = 0;
        return obj;
      });

      try{ localStorage.setItem(key, JSON.stringify(normalized)); }catch(_){ }

      // Mirror to guest cart too so Store and Dashboard never diverge during this phase.
      if (key !== CART_GUEST_KEY){
        try{ localStorage.setItem(CART_GUEST_KEY, JSON.stringify(normalized)); }catch(_){ }
      }

      // Try to sync this cart to the backend (debounced)
      try{ scheduleCartSaveToBackend(); }catch(_){ }
    }

    // --- NEW: debounce cart sync to backend (cross-device cart) ---
    let __cartSaveTimer = null;
    function scheduleCartSaveToBackend(){
      if (__cartSaveTimer) clearTimeout(__cartSaveTimer);
      __cartSaveTimer = setTimeout(async () => {
        try{
          const api = window.VW_API;
          if (!api || typeof api.saveCart !== 'function') return;
          const cartArr = Array.isArray(state.cart) ? state.cart : [];
          const compact = cartArr.map(it => ({
            id: String(it.id),
            title: it.title || it.name || 'Product',
            price: Number(it.price || 0),
            qty: Number(it.qty || it.quantity || 1),
            image: it.image || it.img || it.photo || it.photo_url || it.photoUrl || null,
          }));
          await api.saveCart(compact);
        }catch(e){
          console.warn('Cart sync failed:', e?.message || e);
        }
      }, 600);
    }

    window.addEventListener('storage', (e) => {
      // Keep the cart synced if it changes in another tab/page.
      try{
        if (!e || !e.key) return;
        const changed = String(e.key);
        if (changed === CART_GUEST_KEY || changed.startsWith('vw_cart') || changed === SHARED_REWARDS_KEY || changed === CART_REWARDS_SELECTION_KEY){
          loadLocalCart();
          renderCart();
          try{ scheduleCartSaveToBackend(); }catch(_){ }
        }
      }catch(_){
        // ignore
      }
    });

    // If the token is missing (not logged in), send to login.
    // (We accept multiple keys so this matches the Store login behavior.)
    try{
      if(!getToken()){
        window.location.href = 'cliente-login-2.html';
      }
    }catch(_){ }
    const fmtEUR = (n) => {
      const v = Number(n);
      if (Number.isNaN(v)) return '‚Ç¨ ' + (n ?? '');
      return '‚Ç¨ ' + v.toFixed(2);
    };

    const pointsToCash = (points) => Number(points || 0) * 0.5; // 10 pts = ‚Ç¨5
    const calcPointsEarned = (totalSpent) => Math.floor((Number(totalSpent) || 0) / 55) * 10;


    // ====== Shared rewards state (Wheel -> Cart -> Checkout) ======
    const SHARED_REWARDS_KEY = 'vwi_rewards_state_v1';
    const CART_REWARDS_SELECTION_KEY = 'vwi_cart_rewards_selection_v1';
    const CHECKOUT_PAYLOAD_KEY = 'vw_checkout_payload';

    function isValidReward(r){
      if (!r) return false;
      if (!r.expiresAt) return true;
      const t = new Date(r.expiresAt).getTime();
      return !Number.isNaN(t) && t > Date.now();
    }

    function cleanExpiredRewards(){
      if (state.activeDiscount && !isValidReward(state.activeDiscount)) state.activeDiscount = null;
      if (state.activeShipping && !isValidReward(state.activeShipping)) state.activeShipping = null;
    }

    function loadSharedRewards(){
      try{
        const raw = localStorage.getItem(SHARED_REWARDS_KEY);
        if (!raw) { cleanExpiredRewards(); return; }
        const data = JSON.parse(raw);
        if (typeof data.points === 'number') state.points = data.points;
        if (Array.isArray(data.cashbackHistory)) state.cashbackHistory = data.cashbackHistory;
        if (data.activeDiscount) state.activeDiscount = data.activeDiscount;
        if (data.activeShipping) state.activeShipping = data.activeShipping;
      }catch(_){ }
      cleanExpiredRewards();
    }

    function saveSharedRewards(){
      try{
        localStorage.setItem(SHARED_REWARDS_KEY, JSON.stringify({
          points: state.points,
          cashbackHistory: state.cashbackHistory,
          activeDiscount: state.activeDiscount,
          activeShipping: state.activeShipping,
        }));
      }catch(_){ }
    }

    function loadCartRewardSelection(){
      try{
        const raw = localStorage.getItem(CART_REWARDS_SELECTION_KEY);
        if (!raw) return { usePoints:false, useDiscount:false, useShipping:false };
        const s = JSON.parse(raw) || {};
        return {
          usePoints: !!s.usePoints,
          useDiscount: !!s.useDiscount,
          useShipping: !!s.useShipping,
        };
      }catch(_){
        return { usePoints:false, useDiscount:false, useShipping:false };
      }
    }

    function saveCartRewardSelection(sel){
      try{
        localStorage.setItem(CART_REWARDS_SELECTION_KEY, JSON.stringify({
          usePoints: !!sel.usePoints,
          useDiscount: !!sel.useDiscount,
          useShipping: !!sel.useShipping,
          updatedAt: new Date().toISOString(),
        }));
      }catch(_){ }
    }

    // Countdown helpers (HH:MM:SS only)
    const __countdownTimers = {};

    function formatHMS(ms){
      const total = Math.max(0, Math.floor(ms/1000));
      const h = Math.floor(total/3600);
      const m = Math.floor((total%3600)/60);
      const s = total%60;
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function startCountdown(el, expiresAt){
      if (!el) return;
      const key = el.id || ('cd_' + Math.random().toString(16).slice(2));
      if (__countdownTimers[key]) clearInterval(__countdownTimers[key]);

      const tick = () => {
        const ms = new Date(expiresAt).getTime() - Date.now();
        el.textContent = formatHMS(ms);
        if (ms <= 0){
          clearInterval(__countdownTimers[key]);
          delete __countdownTimers[key];
        }
      };

      tick();
      __countdownTimers[key] = setInterval(tick, 1000);
    }

    function stopCountdown(el){
      if (!el || !el.id) return;
      const key = el.id;
      if (__countdownTimers[key]){
        clearInterval(__countdownTimers[key]);
        delete __countdownTimers[key];
      }
    }

    function determineLevel(spentMonth){
      const v = Number(spentMonth) || 0;
      if (v >= 800) return { key:'GOLD', label:'Gold', dot:'var(--gold2)', fill:['rgba(212,175,55,.95)','rgba(240,180,59,.95)'], spinsPerDay: 5, hint:"You're at the top of the leaderboard." };
      if (v >= 300) return { key:'SILVER', label:'Silver', dot:'var(--silver)', fill:['rgba(192,192,192,.95)','rgba(192,192,192,.75)'], spinsPerDay: 3, hint:'Fill the bar to reach Gold.' };
      return { key:'BRONZE', label:'Bronze', dot:'var(--bronze)', fill:['rgba(205,127,50,.95)','rgba(205,127,50,.78)'], spinsPerDay: 2, hint:'Fill the bar to reach Silver.' };
    }

    function levelProgress(spentMonth){
      const v = Number(spentMonth) || 0;
      // Bronze: 0-300, Silver: 300-800, Gold: >=800
      if (v < 300) return { pct: (v/300)*100, text: `‚Ç¨${v.toFixed(0)} this month` };
      if (v < 800) return { pct: ((v-300)/(800-300))*100, text: `‚Ç¨${v.toFixed(0)} this month` };
      return { pct: 100, text: `‚Ç¨${v.toFixed(0)} this month` };
    }

    function $(id){ return document.getElementById(id); }

    function setText(id, t){ const el=$(id); if(el) el.textContent = t; }
    function setHTML(id, t){ const el=$(id); if(el) el.innerHTML = t; }


    // Basic HTML escaping to avoid breaking the layout when product titles contain special chars
    function escHtml(v){
      return String(v ?? '').replace(/[&<>"']/g, (c) => ({
        '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
      }[c]));
    }
    function escAttr(v){
      return escHtml(v).replace(/`/g, '&#96;');
    }

    function defaultAvatarDataUri(){
      const svg = encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="240" height="240" viewBox="0 0 240 240">
          <defs>
            <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
              <stop stop-color="#D4AF37" stop-opacity="0.35"/>
              <stop stop-color="#f0b43b" stop-opacity="0.18" offset="1"/>
            </linearGradient>
          </defs>
          <rect width="240" height="240" rx="120" fill="url(#g)"/>
          <circle cx="120" cy="92" r="44" fill="rgba(43,39,35,0.16)"/>
          <path d="M48 212c14-46 50-68 72-68s58 22 72 68" fill="rgba(43,39,35,0.14)"/>
        </svg>
      `);
      return `data:image/svg+xml;charset=utf-8,${svg}`;
    }

    // ====== Render ======
    function renderHero(){
      const me = state.me || {};
      setText('userName', me.name || 'Your Name');
      setText('userEmail', me.email || 'email@example.com');

      // avatar
      const img = $('avatar');
      if (img){
        img.src = me.avatar || defaultAvatarDataUri();
      }

      // points + cash
      setText('pointsNow', String(state.points || 0));
      setText('cashValue', `= ${fmtEUR(pointsToCash(state.points || 0))}`);

      // level
      const lvl = determineLevel(state.spentMonth);
      const prog = levelProgress(state.spentMonth);

      setText('levelLabel', lvl.label);
      const dot = $('levelDot');
      if (dot){
        dot.style.background = lvl.dot;
        dot.style.boxShadow = `0 0 0 4px rgba(0,0,0,.08)`;
      }

      const fill = $('levelFill');
      if (fill){
        fill.style.width = Math.max(0, Math.min(100, prog.pct)) + '%';
        fill.style.background = `linear-gradient(90deg, ${lvl.fill[0]}, ${lvl.fill[1]})`;
      }

      setText('levelProgressText', prog.text);
      setText('levelHint', lvl.hint);

      // highlight splits
      $('lvlBronze')?.classList.add('on');
      $('lvlSilver')?.classList.remove('on','silver');
      $('lvlGold')?.classList.remove('on','gold');

      if (lvl.key === 'SILVER'){
        $('lvlSilver')?.classList.add('on','silver');
        $('lvlBronze')?.classList.add('on');
      } else if (lvl.key === 'GOLD'){
        $('lvlSilver')?.classList.add('on','silver');
        $('lvlGold')?.classList.add('on','gold');
      } else {
        // bronze only
        $('lvlBronze')?.classList.add('on');
      }

      // spins
      state.spinsPerDay = lvl.spinsPerDay;
      setText('spinsPerDay', String(state.spinsPerDay));
      setText('spinsLeft', `left today: ${state.spinsLeftToday}`);
      setText('spinStatus', `${state.spinsLeftToday}/${state.spinsPerDay}`);
    }

    function renderAccount(){
  const nameEl = $('accName');
  const emailEl = $('accEmail');
  const phoneEl = $('accPhone');
  if (!nameEl || !emailEl || !phoneEl) return;

  const me = state.me || {};
  nameEl.value = me.name || '';
  emailEl.value = me.email || '';
  phoneEl.value = me.phone || '';
}

    function renderAddresses(){
      const list = state.addresses || [];
      const wrap = $('addrList');
      if (!wrap) return;

      if (!list.length){
        wrap.innerHTML = `<div class="muted" style="font-weight:700;">No address saved yet.</div>`;
        return;
      }

      wrap.innerHTML = list.map(a => `
        <div class="card" style="padding:12px; margin:0;">
          <div class="row">
            <div>
              <div style="font-weight:900">${a.name || 'Address'}</div>
              <div class="muted" style="margin-top:6px; line-height:1.6">${a.line1 || ''}<br/>${a.line2 || ''}<br/>${a.country || ''}</div>
            </div>
            <div class="row" style="gap:8px;">
              <button class="btn small" onclick="editAddress('${a.id}')">Edit</button>
              <button class="btn small danger" onclick="deleteAddress('${a.id}')">Delete</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function computeCartTotals(){
      const cart = Array.isArray(state.cart) ? state.cart : [];
      const subtotal = cart.reduce((s, it) => s + (Number(it.price||0) * Number(it.qty||1)), 0);

      cleanExpiredRewards();

      const chkPts = $('benefitPoints');
      const chkDis = $('benefitDiscount');
      const chkShip = $('benefitShipping');

      const selPts = !!(chkPts && chkPts.checked);
      const selDis = !!(chkDis && chkDis.checked);
      const selShip = !!(chkShip && chkShip.checked);

      // Discount (percent) ‚Äî valid only if you have an active 24h bonus
      const ad = state.activeDiscount;
      const discountPercent = Number(ad?.percent ?? ad?.value ?? 0);
      const hasDiscount = !!(isValidReward(ad) && discountPercent > 0);

      const hasShipping = isValidReward(state.activeShipping);

      // Only ONE reward is allowed (points OR discount OR free shipping)
      const pointsAmount = (selPts && Number(state.points||0) > 0) ? pointsToCash(state.points) : 0;
      const discountAmount = (selDis && hasDiscount) ? (subtotal * (discountPercent / 100)) : 0;
      const freeShipping = (selShip && hasShipping);

      const total = Math.max(0, subtotal - pointsAmount - discountAmount);

      return {
        cart,
        subtotal,
        pointsAmount,
        discountAmount,
        total,
        freeShipping,
        pointsUsed: (selPts && Number(state.points||0) > 0) ? Number(state.points||0) : 0,
        discountPercent: (selDis && hasDiscount) ? Number(discountPercent || 0) : 0,
        discountCash: 0,
        rewardChoice: selShip ? 'shipping' : (selDis ? 'discount' : (selPts ? 'points' : null)),
      };
    }

    function persistCheckoutPayload(t){
      try{
        const uid = (
          state.me && (state.me.id ?? state.me.user_id ?? state.me.uid ?? state.me.userId)
        ) || localStorage.getItem('vw_user_id') || '';

        const compact = (Array.isArray(t.cart) ? t.cart : []).map(it => ({
          id: String(it.id),
          title: it.title || 'Product',
          price: Number(it.price || 0),
          qty: Number(it.qty || 1),
        }));

        localStorage.setItem(CHECKOUT_PAYLOAD_KEY, JSON.stringify({
          user_id: uid ? String(uid) : null,
          cart: compact,
          pay_subtotal: Number(t.total || 0),
          free_shipping: !!t.freeShipping,
          points_used: Number(t.pointsUsed || 0),
          discount_percent: Number(t.discountPercent || 0),
          discount_cash: Number(t.discountCash || 0),
          reward_choice: t.rewardChoice || null,
          updatedAt: new Date().toISOString(),
        }));
      }catch(_){ }
    }

    function renderCart(){
      const cart = Array.isArray(state.cart) ? state.cart : [];
      const totalItems = cart.reduce((s, it) => s + Number(it.qty || 1), 0);

      const totals = computeCartTotals();

      setHTML('cartCountTag', `<strong>${totalItems}</strong> items`);
      setHTML('cartTotalTag', `<strong>${fmtEUR(totals.total)}</strong>`);

      // breakdown
      const bd = $('totalsBreakdown');
      if (bd){
        let html = `<div>Subtotal: <strong>${fmtEUR(totals.subtotal)}</strong></div>`;
        if (totals.discountAmount > 0){
          html += (totals.discountCash > 0)
            ? `<div>Discount: <strong>- ${fmtEUR(totals.discountAmount)}</strong></div>`
            : `<div>Discount: <strong>- ${fmtEUR(totals.discountAmount)}</strong> (${totals.discountPercent}%)</div>`;
        }
        if (totals.pointsAmount > 0){
          html += `<div>Points: <strong>- ${fmtEUR(totals.pointsAmount)}</strong> (${totals.pointsUsed} pts)</div>`;
        }

        html += totals.freeShipping
          ? `<div>Shipping: <strong>FREE ‚úÖ</strong></div>`
          : `<div>Shipping: <strong>calculated at checkout</strong></div>`;

        html += `<div style="margin-top:6px;">Total: <strong>${fmtEUR(totals.total)}</strong></div>`;
        bd.innerHTML = html;
      }

      persistCheckoutPayload(totals);

      renderRewardsBox && renderRewardsBox();

      const wrap = $('cartList');
      if (!wrap) return;

      if (!cart.length){
        wrap.innerHTML = `<div class="muted" style="font-weight:700;">Your cart is empty.</div>`;
        return;
      }

      wrap.innerHTML = cart.map(it => {
        const title = it.title || 'Item';
        const qty = Number(it.qty || 1);
        const price = Number(it.price || 0);
        const lineTotal = price * qty;
        const letter = String(title).slice(0,1).toUpperCase() || '‚Ä¢';
        const img = it.image ? String(it.image) : '';

        const thumb = img
          ? `<img src="${escAttr(img)}" alt="${escAttr(title)}" style="width:100%;height:100%;object-fit:cover;display:block;" />`
          : `<div style="font-weight:900;color:#3b2206;">${escHtml(letter)}</div>`;

        return `
          <div class="card" style="padding:12px; margin:0;">
            <div class="row" style="flex-wrap:nowrap; align-items:center;">
              <div style="display:flex; gap:12px; align-items:center; min-width:0; flex:1;">
                <div style="width:54px;height:54px;border-radius:16px;overflow:hidden;background:rgba(0,0,0,.04);border:1px solid rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center;flex:0 0 auto;">
                  ${thumb}
                </div>
                <div style="min-width:0;">
                  <div style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escHtml(title)}</div>
                  <div class="muted">${fmtEUR(price)} ‚Ä¢ qty: <strong>${qty}</strong> ‚Ä¢ <strong>${fmtEUR(lineTotal)}</strong></div>
                </div>
              </div>
              <button class="btn small danger" onclick="removeCartItem('${String(it.id)}')">Remove</button>
            </div>
          </div>
        `;
      }).join('');
    }


    function fmtDateTime(dt){
      if (!dt) return '';
      try{
        const d = new Date(dt);
        if (Number.isNaN(d.getTime())) return String(dt);
        return d.toLocaleString('en-IE', { dateStyle:'short', timeStyle:'short' });
      } catch(_){
        return String(dt);
      }
    }

    function renderRewardsBox(){
      // State is synced from the backend (see VW_API.loadRewardsStatus). Do not overwrite from rewards localStorage here.
      cleanExpiredRewards();

      // Restore saved selection (but enforce only ONE)
      const savedSel = loadCartRewardSelection();
      const sel = {
        usePoints: !!savedSel.usePoints,
        useDiscount: !!savedSel.useDiscount,
        useShipping: !!savedSel.useShipping,
      };
      if (sel.useShipping){ sel.usePoints = false; sel.useDiscount = false; }
      else if (sel.useDiscount){ sel.usePoints = false; }

      const chkPts = $('benefitPoints');
      const chkDis = $('benefitDiscount');
      const chkShip = $('benefitShipping');

      if (chkPts) chkPts.checked = !!sel.usePoints;
      if (chkDis) chkDis.checked = !!sel.useDiscount;
      if (chkShip) chkShip.checked = !!sel.useShipping;

      // Availability
      const pts = Number(state.points || 0);
      const pointsAvailable = pts > 0;

      const ad = state.activeDiscount;
      const discountPercent = Number(ad?.percent ?? ad?.value ?? 0);
      const hasDiscount = !!(isValidReward(ad) && discountPercent > 0);

      const hasShipping = isValidReward(state.activeShipping);

      // Points UI
      $('pointsBalanceCart') && ($('pointsBalanceCart').textContent = String(pts));
      $('pointsCashCart') && ($('pointsCashCart').textContent = fmtEUR(pointsToCash(pts)));
      if (chkPts){
        if (!pointsAvailable) chkPts.checked = false;
        chkPts.disabled = !pointsAvailable;
        try{ chkPts.closest('label')?.setAttribute('aria-disabled', String(!pointsAvailable)); }catch(_){ }
      }

      // Discount UI
      const lbl = $('discountLabel');
      const exp = $('discountExpires');
      if (lbl){
        if (hasDiscount){
          lbl.textContent = (String(discountPercent) + '% OFF');
        } else {
          lbl.textContent = '‚Äî';
        }
      }
      if (exp){
        stopCountdown(exp);
        if (hasDiscount && ad?.expiresAt){
          startCountdown(exp, ad.expiresAt);
        } else {
          exp.textContent = '00:00:00';
        }
      }
      if (chkDis){
        if (!hasDiscount) chkDis.checked = false;
        chkDis.disabled = !hasDiscount;
        try{ chkDis.closest('label')?.setAttribute('aria-disabled', String(!hasDiscount)); }catch(_){ }
      }

      // Shipping UI
      const shipLbl = $('shippingLabel');
      const shipExp = $('shippingExpires');
      if (shipLbl) shipLbl.textContent = 'Free shipping';
      if (shipExp){
        stopCountdown(shipExp);
        if (hasShipping && state.activeShipping?.expiresAt){
          startCountdown(shipExp, state.activeShipping.expiresAt);
        } else {
          shipExp.textContent = '00:00:00';
        }
      }
      if (chkShip){
        if (!hasShipping) chkShip.checked = false;
        chkShip.disabled = !hasShipping;
        try{ chkShip.closest('label')?.setAttribute('aria-disabled', String(!hasShipping)); }catch(_){ }
      }

      // --- Exclusive selection (only one can be checked) ---
      function saveSelFromUI(){
        saveCartRewardSelection({
          usePoints: !!(chkPts && chkPts.checked),
          useDiscount: !!(chkDis && chkDis.checked),
          useShipping: !!(chkShip && chkShip.checked),
        });
      }

      if (chkPts){
        chkPts.onchange = () => {
          if (chkPts.checked){
            if (chkDis) chkDis.checked = false;
            if (chkShip) chkShip.checked = false;
          }
          saveSelFromUI();
          renderCart();
        };
      }
      if (chkDis){
        chkDis.onchange = () => {
          if (chkDis.checked){
            if (chkPts) chkPts.checked = false;
            if (chkShip) chkShip.checked = false;
          }
          saveSelFromUI();
          renderCart();
        };
      }
      if (chkShip){
        chkShip.onchange = () => {
          if (chkShip.checked){
            if (chkPts) chkPts.checked = false;
            if (chkDis) chkDis.checked = false;
          }
          saveSelFromUI();
          renderCart();
        };
      }

      // Message (selection summary)
      const msg = $('rewardAppliedMsg');
      if (msg){
        let chosen = '‚Äî';
        if (chkPts && chkPts.checked) chosen = 'Selected: Points.';
        if (chkDis && chkDis.checked) chosen = 'Selected: Discount.';
        if (chkShip && chkShip.checked) chosen = 'Selected: Free shipping.';
        msg.textContent = chosen;
      }

      // Checkout URL (always reflects current selection)
      const ck = $('btnResumeCheckout');
      if (ck){
        const t = computeCartTotals();
        const qs = [];

        // cart
        const cartArr = Array.isArray(state.cart) ? state.cart : [];
        if (cartArr.length){
          const compact = cartArr.map(it => ({ id:String(it.id), title: it.title || 'Product', price:Number(it.price||0), qty:Number(it.qty||1) }));
          qs.push(`cart=${encodeURIComponent(JSON.stringify(compact))}`);
        }

        // user
        const uid = (state.me && (state.me.id ?? state.me.user_id ?? state.me.uid ?? state.me.userId)) || localStorage.getItem('vw_user_id') || '';
        if (uid) qs.push(`user_id=${encodeURIComponent(String(uid))}`);

        // totals
        qs.push(`pay_subtotal=${encodeURIComponent(Number(t.total||0).toFixed(2))}`);
        if (t.freeShipping) qs.push('free_shipping=1');
        if (t.pointsUsed) qs.push(`points_used=${encodeURIComponent(String(t.pointsUsed))}`);
        if (t.discountPercent) qs.push(`discount_percent=${encodeURIComponent(String(t.discountPercent))}`);
        if (t.discountCash) qs.push(`discount_cash=${encodeURIComponent(String(t.discountCash))}`);
        if (t.rewardChoice) qs.push(`reward_choice=${encodeURIComponent(String(t.rewardChoice))}`);

        ck.href = qs.length ? `checkout.html?${qs.join('&')}` : 'checkout.html';
      }

      // Apply button
      const btn = $('btnApplyBenefits');
      if (btn){
        const any = !!((chkPts && chkPts.checked) || (chkDis && chkDis.checked) || (chkShip && chkShip.checked));
        btn.disabled = !any;
      }
    }



async function applySelectedBenefits(){
      // Save the current selection + totals so checkout can read them.
      const t = computeCartTotals();
      saveCartRewardSelection({
        usePoints: t.rewardChoice === 'points',
        useDiscount: t.rewardChoice === 'discount',
        useShipping: t.rewardChoice === 'shipping',
      });
      persistCheckoutPayload(t);

      // Also try to sync the cart to the backend (so it works across devices)
      try{ scheduleCartSaveToBackend && scheduleCartSaveToBackend(); }catch(_){ }

      const msg = $('rewardAppliedMsg');
      if (msg){
        if (t.rewardChoice === 'points') msg.textContent = `Saved for checkout: Points (${t.pointsUsed} pts).`;
        else if (t.rewardChoice === 'discount'){
          const label = t.discountCash ? (fmtEUR(t.discountCash) + ' OFF') : (t.discountPercent + '% OFF');
          msg.textContent = `Saved for checkout: Discount (${label}).`;
        }
        else if (t.rewardChoice === 'shipping') msg.textContent = 'Saved for checkout: Free shipping.';
        else msg.textContent = 'Saved for checkout.';
      }

      renderCart();
      if (typeof renderHero === 'function') renderHero();
    }

function statusToStepIndex(status){
      const s = String(status || '').toLowerCase();
      if (s.includes('deliv')) return 4;
      if (s.includes('on the way') || s.includes('shipping') || s.includes('shipped')) return 3;
      if (s.includes('prepar') || s.includes('process')) return 2;
      return 1; // confirmed
    }

    function renderOrders(){
      const orders = Array.isArray(state.orders) ? state.orders : [];
      const wrap = $('ordersList');
      if (!wrap) return;

      if (!orders.length){
        wrap.innerHTML = `<div class="muted" style="font-weight:700;">No orders found.</div>`;
        return;
      }

      wrap.innerHTML = orders.map(o => {
        const step = statusToStepIndex(o.status);
        const pct = ((step-1)/3)*100;

        return `
          <div class="card" style="margin:0;">
            <div class="row">
              <div>
                <div style="font-weight:900">${o.id || '#‚Äî'}</div>
                <div class="muted" style="margin-top:4px">${o.date || ''} ‚Ä¢ ${fmtEUR(o.total || 0)}</div>
              </div>
              <span class="pill"><strong>${o.status || 'Confirmed'}</strong></span>
            </div>

            <div class="stepper-line"><span style="width:${pct}%;"></span></div>

            <div class="stepper" aria-label="Order progress">
              <div class="step ${step>=1?'done':''}">Confirmed</div>
              <div class="step ${step>=2?'done':''}">Processing</div>
              <div class="step ${step>=3?'done':''}">On the way</div>
              <div class="step ${step>=4?'done':''}">Delivered</div>
            </div>

            <div class="muted" style="margin-top:10px; font-weight:700;">
              Tracking: <strong>${o.tracking || '‚Äî'}</strong>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderCashback(){
      setText('cashBalance', fmtEUR(pointsToCash(state.points || 0)));
      setText('pointsBalance', String(state.points || 0));

      const list = Array.isArray(state.cashbackHistory) ? state.cashbackHistory : [];
      const wrap = $('cashHistory');
      if (!wrap) return;

      if (!list.length){
        wrap.innerHTML = `<div class="muted" style="font-weight:700;">No activity yet.</div>`;
        return;
      }

      wrap.innerHTML = list.map(h => {
        const delta = Number(h.delta || 0);
        const sign = delta >= 0 ? '+' : '';
        const color = delta >= 0 ? '#2e3a12' : '#6b1710';
        return `
          <div class="card" style="margin:0;">
            <div class="row">
              <div>
                <div style="font-weight:900">${h.title || 'Activity'}</div>
                <div class="muted" style="margin-top:4px">${h.date || ''} ‚Ä¢ ${h.detail || ''}</div>
              </div>
              <span class="pill" style="border-color:rgba(0,0,0,.06)">
                <strong style="color:${color}">${sign}${delta} pts</strong>
              </span>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderAll(){
      renderHero();
      renderAccount();
      renderAddresses();
      renderCart();
      renderOrders();
      renderCashback();
      setText('year', new Date().getFullYear());
    }

    // ====== A√ß√µes ======
    window.editAddress = function(id){
      const a = (state.addresses||[]).find(x => x.id === id);
      if (!a) return;
      const line1 = prompt('Street / Line 1:', a.line1 || '');
      if (line1 === null) return;
      const line2 = prompt('City / Line 2:', a.line2 || '');
      if (line2 === null) return;
      const country = prompt('Country:', a.country || '');
      if (country === null) return;
      a.line1 = line1; a.line2 = line2; a.country = country;
      setText('addrMsg', '‚úÖ Address updated.');
      renderAddresses();
    };

    window.deleteAddress = function(id){
      if (!confirm('Delete this address?')) return;
      state.addresses = (state.addresses||[]).filter(a => a.id !== id);
      setText('addrMsg', '‚úÖ Address deleted.');
      renderAddresses();
    };

    window.removeCartItem = function(id){
      state.cart = (state.cart||[]).filter(it => String(it.id) !== String(id));
      saveLocalCart();
      try{ scheduleCartSaveToBackend(); }catch(_){ }
      renderCart();
    };

    function clearCart(){
      if (!confirm('Clear the cart?')) return;
      // Clear the SAME cart used by the Store (so they stay in sync).
      state.cart = [];
      try{ localStorage.setItem(chooseActiveCartKey(), JSON.stringify([])); }catch(_){ }
      try{ localStorage.setItem(CART_GUEST_KEY, JSON.stringify([])); }catch(_){ }
      renderCart();
      try{ scheduleCartSaveToBackend(); }catch(_){ }
    }

    // Avatar picker (somente na Account)
    function setAvatarFileName(name){
      $('avatarFileName').innerHTML = `<strong>${name || '‚Äî'}</strong>`;
    }

    function openAvatarPicker(){
      const input = $('avatarFileInput');
      input.value = '';
      input.click();
    }

    async function setAvatar(file){
      if (!file) return;
      state.avatarFile = file;
      setAvatarFileName(file.name);
      // preview imediato
      const url = URL.createObjectURL(file);
      state.me.avatar = url;
      renderHero();
      setText('accountMsg', '‚úÖ Photo updated.');
    }

    // Salvar conta (demo)
    function saveAccount(){
      const name = $('accName').value.trim();
      const email = $('accEmail').value.trim();
      const phone = $('accPhone').value.trim();
      state.me.name = name || state.me.name;
      state.me.email = email || state.me.email;
      state.me.phone = phone || state.me.phone;
      setText('accountMsg', '‚úÖ Changes saved.');
      renderHero();
    }

    // Senha (demo)
    function changePassword(){
      const n1 = $('passNew').value.trim();
      const n2 = $('passConfirm').value.trim();

      if (!n1 || n1.length < 6){
        setText('passMsg', 'Use at least 6 characters.');
        return;
      }
      if (n1 !== n2){
        setText('passMsg', "Confirmation doesn't match.");
        return;
      }
      $('passCurrent').value = '';
      $('passNew').value = '';
      $('passConfirm').value = '';
      setText('passMsg', '‚úÖ Password updated.');
    }

    // Wheel (backend - saves prizes in MySQL via /bonus/spin)
    let spinning = false;

    function formatPrizeLabel(prize){
      if(!prize) return '‚Äî';
      const type = String(prize.type || '').toLowerCase();
      const val = Number(prize.value || 0);
      if(type === 'cashback' || type === 'points') return `${val} POINTS`;
      if(type === 'percent' || type === 'discount') return `${val}% OFF`;
      if(type === 'shipping') return `FREE SHIPPING`;
      if(type === 'none') return `NO PRIZE`;
      return `${type} ${val}`;
    }

    async function spin(){
      if (spinning) return;
      if (state.spinsLeftToday <= 0){
        setText('spinResultMsg', "You've already used today's spins.");
        return;
      }

      const api = window.VW_API;
      if (!api || typeof api.bonusSpin !== 'function'){
        setText('spinResultMsg', "API not ready. Refresh the page.");
        return;
      }

      spinning = true;
      setText('spinResultMsg', 'Spinning‚Ä¶');
      try{
        await animateWheel();

        const resp = await api.bonusSpin();
        const prize = resp && (resp.prize || resp.data?.prize) ? (resp.prize || resp.data.prize) : resp;

        state.spinsLeftToday -= 1;

        // Refresh rewards from backend (points + 24h discount + 24h shipping)
        try{ await api.loadRewardsStatus(); }catch(_){}

        // Small local history for points
        const type = String(prize?.type || '').toLowerCase();
        if (type === 'cashback' || type === 'points'){
          const pts = Number(prize?.value || 0);
          if (pts > 0){
            state.cashbackHistory.unshift({
              date: new Date().toISOString().slice(0,10),
              title: 'Credit',
              delta: +pts,
              detail: 'Wheel',
            });
          }
        }

        renderAll();
        setText('spinResultMsg', `üéÅ ${formatPrizeLabel(prize)}`);
      } catch (e){
        console.error('Spin error:', e);
        setText('spinResultMsg', 'Error spinning. Try again.');
      } finally {
        spinning = false;
      }
    }

    function addAddress(){
      const name = prompt('Address name (e.g., Home):', 'Home');
      if (name === null) return;
      const line1 = prompt('Street / Line 1:', '');
      if (line1 === null) return;
      const line2 = prompt('City / Line 2:', '');
      if (line2 === null) return;
      const country = prompt('Country:', 'Ireland');
      if (country === null) return;

      state.addresses.unshift({ id: 'a' + Math.random().toString(16).slice(2), name, line1, line2, country });
      setText('addrMsg', '‚úÖ Address added.');
      renderAddresses();
    }

    function logout(){
  if(window.VintageAuth && typeof window.VintageAuth.logout==='function'){
    window.VintageAuth.logout();
    return;
  }
  localStorage.removeItem('vw_token');
  window.location.href = 'cliente-login-2.html';
}

    // ====== Dados demo ======
    function loadDemo(){
      // Clean defaults (prototype)
      state.me = {
        name: '',
        email: '',
        phone: '',
        avatar: defaultAvatarDataUri(),
      };

      state.spentTotal = state.spentTotal || 0;
      state.spentMonth = state.spentMonth || 0;

      // Load shared rewards (points + wheel rewards)
      loadSharedRewards();

      // Cart comes from the Store localStorage (it must transit between pages).
      loadLocalCart();

      state.orders = state.orders || [];
      state.addresses = state.addresses || [];
      state.cashbackHistory = state.cashbackHistory || [];

      setText('accountMsg', '‚Äî');
      setText('addrMsg', '‚Äî');
      setText('passMsg', '‚Äî');
      setText('spinResultMsg', '‚Äî');

      renderAll();
    }

    // ====== Eventos ======
    document.addEventListener('DOMContentLoaded', () => {
      loadDemo();

      $('btnPickAvatar')?.addEventListener('click', openAvatarPicker);
      $('avatarFileInput')?.addEventListener('change', (e) => {
        const file = e.target.files ? e.target.files[0] : null;
        if (file) setAvatar(file);
      });

      $('btnSaveAccount')?.addEventListener('click', saveAccount);
      $('btnChangePass')?.addEventListener('click', changePassword);
      $('btnAddAddress')?.addEventListener('click', addAddress);
      $('btnClearCart')?.addEventListener('click', clearCart);

      $('btnApplyBenefits')?.addEventListener('click', applySelectedBenefits);
      $('btnLogout')?.addEventListener('click', logout);

      $('btnSpin')?.addEventListener('click', spin);
});

    // ======= Campo reativo dourado =======
    (() => {
      const MAX_PARTICLES_BASE = 120;
      const LINK_DIST = 170;
      const SAFETY_MARGIN = 22;
      const MOUSE_REPEL_RADIUS = 120 + SAFETY_MARGIN;
      const MOUSE_FORCE = 0.14;
      const SPEED = 0.55;
      const FRICTION = 0.965;

      const canvas = document.getElementById('reactiveField');
      if (!canvas) return;
      const ctx = canvas.getContext('2d', { alpha: true });
      let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      let W = 0, H = 0;

      function resize(){
        W = canvas.clientWidth = window.innerWidth;
        H = canvas.clientHeight = window.innerHeight;
        canvas.width = Math.floor(W * DPR);
        canvas.height = Math.floor(H * DPR);
        ctx.setTransform(DPR,0,0,DPR,0,0);
      }
      resize();

      window.addEventListener('resize', () => {
        DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        resize();
        init();
      });

      const pts = [];
      function rand(min,max){ return Math.random()*(max-min)+min; }

      function init(){
        pts.length = 0;
        const area = W * H;
        const max = Math.max(70, Math.min(MAX_PARTICLES_BASE, Math.floor(area / 14000)));
        for (let i=0;i<max;i++){
          pts.push({
            x: rand(0,W),
            y: rand(0,H),
            vx: rand(-SPEED, SPEED),
            vy: rand(-SPEED, SPEED),
            r: rand(1.2, 2.2),
          });
        }
      }
      init();

      const mouse = { x: -9999, y: -9999, active: false };
      window.addEventListener('mousemove', (e) => { mouse.x = e.clientX; mouse.y = e.clientY; mouse.active = true; });
      window.addEventListener('mouseleave', () => { mouse.active = false; mouse.x = -9999; mouse.y = -9999; });

      function draw(){
        ctx.clearRect(0,0,W,H);

        for (const p of pts){
          if (mouse.active){
            const dx = p.x - mouse.x;
            const dy = p.y - mouse.y;
            const d2 = dx*dx + dy*dy;
            if (d2 < MOUSE_REPEL_RADIUS*MOUSE_REPEL_RADIUS){
              const d = Math.sqrt(d2) || 1;
              const f = (1 - d / MOUSE_REPEL_RADIUS) * MOUSE_FORCE;
              p.vx += (dx / d) * f;
              p.vy += (dy / d) * f;
            }
          }

          p.vx *= FRICTION;
          p.vy *= FRICTION;

          p.x += p.vx;
          p.y += p.vy;

          if (p.x < -20) p.x = W + 20;
          if (p.x > W + 20) p.x = -20;
          if (p.y < -20) p.y = H + 20;
          if (p.y > H + 20) p.y = -20;
        }

        for (let i=0;i<pts.length;i++){
          for (let j=i+1;j<pts.length;j++){
            const a = pts[i], b = pts[j];
            const dx = a.x - b.x;
            const dy = a.y - b.y;
            const d = Math.sqrt(dx*dx + dy*dy);
            if (d < LINK_DIST){
              const alpha = (1 - d/LINK_DIST) * 0.22;
              ctx.strokeStyle = `rgba(212,175,55,${alpha})`;
              ctx.lineWidth = 1;
              ctx.beginPath();
              ctx.moveTo(a.x,a.y);
              ctx.lineTo(b.x,b.y);
              ctx.stroke();
            }
          }
        }

        for (const p of pts){
          ctx.fillStyle = 'rgba(212,175,55,0.35)';
          ctx.beginPath();
          ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
          ctx.fill();
        }

        requestAnimationFrame(draw);
      }
      draw();
    })();
  </script>
<script>
(function(){
  const API_ROOT = "https://clientes-0r5d.onrender.com";
  const TOKEN_KEYS = ["vw_token","token","authToken","auth_token","access_token"];

  function getToken(){
    for (const k of TOKEN_KEYS){
      try {
        const t = localStorage.getItem(k);
        if (t) return t;
      } catch (_) {}
    }
    return null;
  }

  function requireTokenOrRedirect(){
    const t = getToken();
    if (!t) {
      window.location.href = "cliente-login-2.html";
    }
    return t;
  }

  function authHeaders() {
  const token = localStorage.getItem("token");
  if (!token) return {};
  return {
    Authorization: "Bearer " + token
  };
}




  async function apiJson(path, opts = {}){
    const url = API_ROOT + path;
    const init = {
      method: opts.method || 'GET',
      headers: {
        'Content-Type': 'application/json',
        ...(opts.headers || {}),
        ...authHeaders(),
      },
    };
    if (opts.body !== undefined) init.body = (typeof opts.body === 'string') ? opts.body : JSON.stringify(opts.body);

    const res = await fetch(url, init);
    if (res.status === 401 || res.status === 403){
      requireTokenOrRedirect();
      throw new Error('unauthorized');
    }

    const text = await res.text();
    let data = null;
    try{ data = text ? JSON.parse(text) : null; } catch(_){ data = text; }

    if (!res.ok){
      const msg = (data && (data.error || data.message)) || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  function syncPointsUI(points){
    const p = document.getElementById('pointsNow');
    if (p) p.textContent = String(points ?? 0);
    const cash = document.getElementById('cashValue');
    if (cash){
      const eur = (Number(points||0) * 0.5);
      cash.textContent = '= ‚Ç¨ ' + eur.toFixed(2);
    }
  }

  // --- NEW: cart persistence helpers (cross-device cart) ---
  async function extractCartFromResponse(data){
    if (!data) return [];
    if (Array.isArray(data)) return data;
    const c = data.cart || data.items || (data.data && (data.data.cart || data.data.items));
    return Array.isArray(c) ? c : [];
  }

  function normalizeCart(items){
    const arr = Array.isArray(items) ? items : [];
    return arr.map((it) => {
      const obj = (it && typeof it === 'object') ? { ...it } : {};
      const title = obj.title || obj.name || obj.product || 'Product';
      const image = obj.image_url || obj.image || obj.img || obj.photo || obj.photo_url || obj.photoUrl || null;

      // Stable product identifier (shared across devices)
      const productId = String(obj.product_id ?? obj.productId ?? obj.sku ?? obj.id ?? title);

      // If this came from MySQL, obj.id is the cart_items row id and product_id exists.
      const rowId = (obj.product_id != null && obj.id != null) ? obj.id : (obj.row_id ?? obj.cart_item_id ?? null);

      const qty = Number(obj.qty ?? obj.quantity ?? 1);
      const price = Number(obj.price ?? 0);

      return {
        ...obj,
        id: productId,
        product_id: productId,
        row_id: rowId,
        title,
        image,
        qty: (Number.isFinite(qty) && qty > 0) ? qty : 1,
        price: Number.isFinite(price) ? price : 0,
      };
    });
  }

  async function loadCartRemote(){
  try {
    const data = await apiJson('/cart', { method: 'GET' });
    const items = await extractCartFromResponse(data);
    return normalizeCart(items);
  } catch (e) {
    console.error('Erro ao carregar carrinho remoto:', e);
    return [];
  }
}


  async function saveCartRemote(items){
    const cart = normalizeCart(items);

    // Payload format expected by the backend: { items: [{product_id,title,price,qty,image_url}] }
    const compact = cart.map(it => ({
      product_id: String(it.product_id ?? it.id ?? ''),
      title: it.title || it.name || 'Product',
      price: Number(it.price || 0),
      qty: Math.max(1, Number(it.qty || it.quantity || 1)),
      image_url: it.image || it.img || it.photo || it.photo_url || it.photoUrl || null,
    })).filter(it => it.product_id);

    // 1) Read current remote cart (to know which DB rows must be deleted)
    let remoteRows = [];
    try{
      const data0 = await apiJson('/cart', { method: 'GET' });
      const r0 = await extractCartFromResponse(data0);
      remoteRows = Array.isArray(r0) ? r0 : [];
    }catch(e){
      // If the endpoint doesn't exist yet, just stop silently (so UI still works locally)
      console.warn('Remote cart GET failed:', e?.message || e);
      return { ok:false, error: e?.message || String(e) };
    }

    // 2) Upsert all current items
    try{
      await apiJson('/cart/sync', { method: 'POST', body: { items: compact } });
    }catch(e){
      console.warn('Remote cart sync failed:', e?.message || e);
      return { ok:false, error: e?.message || String(e) };
    }

    // 3) Delete remote items that are NOT present locally (so it behaves like "replace")
    const keep = new Set(compact.map(x => String(x.product_id)));
    for (const r of remoteRows){
      const pid = String(r.product_id ?? r.productId ?? '');
      const rowId = r.id; // cart_items.id (DB row id)
      if (pid && rowId && !keep.has(pid)){
        try{ await apiJson(`/cart/items/${rowId}`, { method: 'DELETE' }); }catch(_){ }
      }
    }

    // 4) Return the fresh remote cart (with latest row ids)
    try{
      const data1 = await apiJson('/cart', { method: 'GET' });
      const r1 = await extractCartFromResponse(data1);
      return normalizeCart(r1);
    }catch(_){
      return cart;
    }
  }

  async function bootstrapCartSync(){
    try{
      const localCart = (typeof state !== 'undefined' && Array.isArray(state.cart)) ? state.cart : [];
      const remoteCart = await loadCartRemote();

      if (remoteCart.length && !localCart.length){
        try{ state.cart = remoteCart; }catch(_){ }
        try{ if (typeof saveLocalCart === 'function') saveLocalCart(); }catch(_){ }
        try{ if (typeof renderCart === 'function') renderCart(); }catch(_){ }
        return;
      }

      if (localCart.length && !remoteCart.length){
        await saveCartRemote(localCart);
        return;
      }

      if (localCart.length && remoteCart.length){
        const map = new Map();
        for (const it of remoteCart){ map.set(String(it.id), { ...it }); }
        for (const it of localCart){
          const k = String(it.id);
          const cur = map.get(k);
          if (!cur) map.set(k, { ...it });
          else {
            const q1 = Number(cur.qty || 1);
            const q2 = Number(it.qty || 1);
            map.set(k, { ...cur, ...it, qty: Math.max(q1, q2) });
          }
        }
        const merged = Array.from(map.values());
        try{ state.cart = merged; }catch(_){ }
        try{ if (typeof saveLocalCart === 'function') saveLocalCart(); }catch(_){ }
        await saveCartRemote(merged);
        try{ if (typeof renderCart === 'function') renderCart(); }catch(_){ }
      }
    }catch(e){
      console.warn('bootstrapCartSync failed:', e?.message || e);
    }
  }

  async function loadRewardsStatus(){
    // Source of truth: backend bonuses table (MySQL)
    try{
      const data = await apiJson('/bonus/balance', { method: 'GET' });

      const list = Array.isArray(data?.available)
        ? data.available
        : (Array.isArray(data?.bonuses) ? data.bonuses : []);

      const now = Date.now();

      const norm = (list || []).filter(b => !b.used).map((b) => {
        const type = String(b.type || b.kind || '').toLowerCase();
        const created = b.created_at || b.createdAt || b.created || null;
        let expiresAt = b.expiresAt || b.expires_at || b.expires || null;

        // Only shipping + percent discount expire after 24h
        if (!expiresAt && (type === 'percent' || type === 'discount' || type === 'shipping')){
          const base = created ? new Date(created).getTime() : now;
          expiresAt = new Date(base + 24 * 60 * 60 * 1000).toISOString();
        }

        return {
          ...b,
          type,
          value: Number(b.value || 0),
          created_at: created,
          expiresAt,
        };
      });

      // POINTS (accumulative, no expiry)
      const points = norm
        .filter(b => b.type === 'cashback' || b.type === 'points')
        .reduce((s, b) => s + (Number(b.value) || 0), 0);
      state.points = Math.max(0, Math.floor(points));

      // DISCOUNT (percent, 24h)
      const disc = norm.find(b => (b.type === 'percent' || b.type === 'discount') && (Number(b.value) || 0) > 0 && (!b.expiresAt || (new Date(b.expiresAt).getTime() > now)));
      state.activeDiscount = disc ? { id: disc.id, percent: Number(disc.value || 0), expiresAt: disc.expiresAt } : null;

      // FREE SHIPPING (24h)
      const ship = norm.find(b => b.type === 'shipping' && (!b.expiresAt || (new Date(b.expiresAt).getTime() > now)));
      state.activeShipping = ship ? { id: ship.id, expiresAt: ship.expiresAt } : null;

      // Re-render rewards + totals
      renderCart();
      renderCashback();

      return { ok:true, points: state.points, activeDiscount: state.activeDiscount, activeShipping: state.activeShipping };
    }catch(e){
      console.warn('Rewards status not loaded:', e?.message || e);
      // keep UI working even if backend is not ready
      state.activeDiscount = null;
      state.activeShipping = null;
      renderCart();
      return { ok:false, error: e?.message || String(e) };
    }
  }

  window.VW_API = window.VW_API || {};
  window.VW_API.root = API_ROOT;
  window.VW_API.apiJson = apiJson;

  // Bonuses (new backend)
  window.VW_API.loadRewardsStatus = loadRewardsStatus; // keeps the same name used elsewhere
  window.VW_API.bonusBalance = () => apiJson('/bonus/balance', { method:'GET' });
  window.VW_API.bonusSpin = () => apiJson('/bonus/spin', { method:'POST', body:{} });
  window.VW_API.bonusApply = (bonusId) => apiJson('/bonus/apply', { method:'POST', body:{ bonusId } });

  // Cart persistence (tries common endpoints; your backend may implement one of these)
  window.VW_API.loadCart = loadCartRemote;
  window.VW_API.saveCart = saveCartRemote;
  window.VW_API.bootstrapCartSync = bootstrapCartSync;

  // Checkout
  window.VW_API.checkoutCreate = (payload) => apiJson('/checkout/create', { method:'POST', body: payload || {} });

  function defaultAvatarDataUri(){
    const svg = encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="240" height="240" viewBox="0 0 240 240">
        <defs>
          <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
            <stop stop-color="#D4AF37" stop-opacity="0.35"/>
            <stop stop-color="#f0b43b" stop-opacity="0.18" offset="1"/>
          </linearGradient>
        </defs>
        <rect width="240" height="240" rx="120" fill="url(#g)"/>
        <circle cx="120" cy="92" r="44" fill="rgba(43,39,35,0.16)"/>
        <path d="M48 212c14-46 50-68 72-68s58 22 72 68" fill="rgba(43,39,35,0.14)"/>
      </svg>
    `);
    return `data:image/svg+xml;charset=utf-8,${svg}`;
  }

  function applyAvatar(user){
    const img = document.getElementById("avatar");
    if (!img) return;

    const raw = (user && (user.avatar_url || user.avatar || user.avatarUrl || user.photo_url || user.photoUrl)) || "";

    if (!raw) {
      img.src = defaultAvatarDataUri();
      return;
    }

    let url = String(raw);
    if (!/^https?:\/\//i.test(url)) {
      if (!url.startsWith("/")) url = "/" + url;
      url = API_ROOT + url;
    }

    // cache-bust so the new photo appears immediately
    url += (url.includes("?") ? "&" : "?") + "v=" + Date.now();
    img.src = url;
  }

  async function loadProfile(){
    requireTokenOrRedirect();

    try {
      const res = await fetch(API_ROOT + "/user/me", { headers: authHeaders() });

      if (res.status === 401 || res.status === 403) {
        requireTokenOrRedirect();
        return;
      }

      if (!res.ok) {
        console.warn("Failed to load /user/me:", res.status);
        return;
      }

      const user = await res.json();

      try{ state.me = user; }catch(_){ }
      try{ if (user && (user.id ?? user.user_id ?? user.userId)) localStorage.setItem('vw_user_id', String(user.id ?? user.user_id ?? user.userId)); }catch(_){ }
      // Re-load cart using the logged-in user id (so it maps to vw_cart_u_<id>)
      loadLocalCart();
      renderCart();

      const nameEl = document.getElementById("userName");
      const emailEl = document.getElementById("userEmail");

      if (nameEl) nameEl.textContent = user.name || "Your Name";
      if (emailEl) emailEl.textContent = user.email || "email@example.com";

      applyAvatar(user);
      // Sync cart with backend (cross-device)
      try{ await bootstrapCartSync(); }catch(_){ }

      // Load rewards/bonuses (points + discount + free shipping) from the backend
      loadRewardsStatus();
    } catch (err) {
      console.error("Error loading /user/me", err);
    }
  }

  document.addEventListener("DOMContentLoaded", loadProfile);
})();
</script>

</body>
</html>
