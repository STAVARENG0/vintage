<!DOCTYPE html>
<html lang="en-IE">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>

  <meta http-equiv="Cache-Control" content="no-store" />

  <style>
    :root{
      --cream:#f6f1e7;
      --cream-2:#f3e9d8;
      --text:#2b2723;
      --muted:#7c6f63;
      --card:#ffffff;

      --gold:#D4AF37;
      --gold-soft: rgba(212,175,55,.55);

      --border:#e0d5c2;
      --shadow:0 18px 42px rgba(0,0,0,.32);
      --radius:22px;

      --btn-bg: rgba(255,255,255,.88);
      --btn-text: #3b2206;

      --bronze:#cd7f32;
      --silver:#c0c0c0;
      --gold2:#D4AF37;
    }

    *{ box-sizing:border-box; }
    html{ scroll-behavior:smooth; }
    body{
      margin:0;
      font-family: Poppins, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: linear-gradient(135deg,#fdf4e3,#f1dfc2,#e3c395);
      color: var(--text);
      min-height: 100dvh;
      padding: 22px 10px 40px;
    }

    /* Fundo reativo */
    #reactiveField{ position:fixed; inset:0; z-index:0; pointer-events:none; }

    .wrap{
      position:relative; z-index:1;
      max-width: 1100px;
      margin: 0 auto;
    }

    .glass{
      background: linear-gradient(135deg,rgba(253,244,227,0.10),rgba(241,223,194,0.08),rgba(227,195,149,0.14));
      backdrop-filter: saturate(120%) blur(6px);
      -webkit-backdrop-filter: saturate(120%) blur(6px);
      border:1px solid rgba(212,175,55,.55);
      border-radius: 28px;
      box-shadow: var(--shadow), 0 0 26px rgba(212,175,55,.22);
    }

    header{
      padding: 16px 18px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .top-left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width: 180px;
    }
    .top-left small{
      color: var(--muted);
      font-weight: 700;
      letter-spacing:.04em;
    }

    .btn{
      appearance:none;
      border:1px solid var(--gold-soft);
      background: var(--btn-bg);
      color: var(--btn-text);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,.10);
      transition: transform .15s ease, filter .15s ease, background .15s ease, border-color .15s ease;
      text-decoration:none;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      filter: brightness(1.03);
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.95), transparent 60%),
        linear-gradient(120deg, rgba(212,175,55,.22), rgba(240,180,59,.22));
      border-color: rgba(212,175,55,.75);
    }
    .btn:active{ transform: translateY(0); filter: brightness(.99); }
    .btn.small{ padding: 8px 12px; font-weight: 900; }
    .btn.primary{
      background: linear-gradient(120deg, rgba(212,175,55,.25), rgba(240,180,59,.25));
    }
    .btn.danger{
      border-color: rgba(179,59,46,.35);
      color: #7a1f16;
    }

    .divider{
      height:2px;
      background: linear-gradient(90deg, transparent, rgba(212,175,55,.95), transparent);
      border-radius: 999px;
      box-shadow: 0 10px 22px rgba(212,175,55,.20);
      margin: 0 18px;
    }

    /* "Landing" */
    .page{
      padding: 14px;
    }

    .hero{
      padding: 16px;
      border-radius: var(--radius);
    }

    .hero-center{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
      text-align:center;
      padding: 10px 10px 6px;
    }

    .hero-title{
      margin:0;
      font-family: Orbitron, Poppins, system-ui, sans-serif;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size: 20px;
    }

    .avatar-wrap{
      width: 160px; height: 160px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.92), rgba(255,255,255,.55));
      border: 2px solid rgba(212,175,55,.92);
      box-shadow: 0 18px 40px rgba(0,0,0,.18), 0 0 20px rgba(212,175,55,.18);
      display:flex; align-items:center; justify-content:center;
      position: relative;
      overflow:hidden;
    }
    .avatar-wrap img{
      width: 144px; height: 144px;
      border-radius: 999px;
      object-fit: cover;
      display:block;
      background: linear-gradient(135deg, rgba(212,175,55,.20), rgba(240,180,59,.15));
      border: 1px solid rgba(0,0,0,.05);
    }

    .name{
      margin: 0;
      font-weight: 900;
      font-size: 18px;
    }
    .sub{
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    /* Barra de n√≠vel (3 n√≠veis) */
    .level-wrap{
      width: min(520px, 94%);
      margin-top: 2px;
    }

    .level-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.76);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      font-weight: 900;
      letter-spacing:.06em;
      text-transform: uppercase;
      color: #3b2206;
    }

    .badge-dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--bronze);
      box-shadow: 0 0 0 4px rgba(205,127,50,.12);
    }

    .level-bar{
      height: 14px;
      border-radius: 999px;
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.06);
      overflow:hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.08);
      position:relative;
    }
    .level-fill{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(205,127,50,.95), rgba(205,127,50,.78));
      transition: width .35s ease, filter .35s ease;
    }
    .level-splits{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top: 8px;
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 11px;
      color: var(--muted);
    }
    .level-splits span{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .level-splits i{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.10);
      display:inline-block;
    }
    .level-splits .on{ color: var(--text); }
    .level-splits .on i{ background: var(--bronze); }
    .level-splits .on.silver i{ background: var(--silver); }
    .level-splits .on.gold i{ background: var(--gold2); }

    /* Navega√ß√£o (topo abaixo do hero) */
    .nav{
      margin: 14px auto 0;
      width: min(900px, 100%);
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:center;
    }
    .nav .btn{ font-weight: 900; }

    /* Cards */
    .grid{
      width: min(980px, 100%);
      margin: 14px auto 0;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid rgba(224,213,194,.9);
      background: rgba(255,255,255,.78);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .muted{ color: var(--muted); }

    .stat{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-height: 72px;
    }
    .stat .k{
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 900;
    }
    .stat .v{
      font-size: 22px;
      font-weight: 900;
      line-height: 1.1;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.02);
      border: 1px solid rgba(0,0,0,.06);
      color: var(--muted);
      font-weight: 800;
      font-size: 12px;
    }
    .pill strong{ color: var(--text); }

    /* Roleta (sempre vis√≠vel) */
.wheel-area{
  width: min(980px, 100%);
  margin: 12px auto 0;
}

.wheel-stack{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 12px;
  margin-top: 10px;
  text-align:center;
}

.wheel-box{
  position:relative;
  width: min(340px, 82vw);
  aspect-ratio: 1 / 1;
  margin: 0 auto;
}

.wheel-rotate{
  width:100%;
  height:100%;
  border-radius: 999px;
  overflow:hidden;
  box-shadow: 0 22px 60px rgba(0,0,0,.16), 0 0 20px rgba(212,175,55,.12);
  border: 2px solid rgba(212,175,55,.85);
  background: rgba(255,255,255,.35);
  transform: rotate(0deg);
}

.wheel-box::after{
  content:"";
  position:absolute;
  inset: 20%;
  border-radius: 999px;
  background: rgba(255,255,255,.70);
  border: 1px solid rgba(0,0,0,.06);
  box-shadow: inset 0 4px 18px rgba(0,0,0,.10);
  pointer-events:none;
  z-index: 2;
}

#wheelCanvas{
  width:100%;
  height:100%;
  display:block;
  position:relative;
  z-index: 1;
}

.pointer{
  position:absolute;
  top: -12px;
  left: 50%;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 14px solid transparent;
  border-right: 14px solid transparent;
  border-bottom: 22px solid rgba(255,122,26,.92);
  filter: drop-shadow(0 8px 14px rgba(0,0,0,.18));
  z-index: 3;
  pointer-events:none;
}

.wheel-instructions{
  max-width: 680px;
  line-height: 1.7;
}

    /* Se√ß√µes */
    section{
      width: min(980px, 100%);
      margin: 14px auto 0;
      scroll-margin-top: 90px;
    }
    .section-title{
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .04em;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin: 10px 0;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .field input, .field textarea, .field select{
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(212,175,55,.55);
      background: rgba(255,255,255,.92);
      outline:none;
      font-weight: 600;
      resize: vertical;
    }
    .field textarea{ border-radius: 18px; min-height: 88px; }

    /* Pedidos - barra de processo */
    .stepper{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 10px;
      align-items:center;
    }
    .step{
      text-align:center;
      font-weight: 900;
      font-size: 11px;
      letter-spacing:.08em;
      text-transform: uppercase;
      color: var(--muted);
      position:relative;
      padding-top: 18px;
    }
    .step::before{
      content:"";
      position:absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(0,0,0,.08);
    }
    .step.done{ color: var(--text); }
    .step.done::before{
      background: linear-gradient(120deg, rgba(212,175,55,.95), rgba(240,180,59,.95));
      border-color: rgba(212,175,55,.8);
      box-shadow: 0 0 0 4px rgba(212,175,55,.14);
    }
    .stepper-line{
      height: 10px;
      margin-top: 10px;
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 999px;
      overflow:hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.08);
    }
    .stepper-line span{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(212,175,55,.9), rgba(240,180,59,.9));
    }

    /* Lista simples */
    .list{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    footer{
      margin-top: 16px;
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      padding-bottom: 6px;
    }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <canvas id="reactiveField" aria-hidden="true"></canvas>

  <div class="wrap">
    <div class="glass">
            <header>
        <div class="top-left">
          <small></small>
        </div>
      </header>


      <div class="divider"></div>

      <div class="page">
        <!-- HERO -->
        <div class="hero glass">
          <div class="hero-center">
            <h1 class="hero-title">Customer Dashboard</h1>


            <!-- Nav buttons -->
            <div class="nav" aria-label="Shortcuts">
              <a class="btn small primary" href="painel.html">üè† Dashboard</a>
              <a class="btn small" href="index.html">üõçÔ∏è Shop</a>
              <a class="btn small" href="conta.html">üë§ Account</a>
              <a class="btn small" href="carrinho.html">üõí My cart</a>
              <a class="btn small" href="pedidos.html">üì¶ Orders</a>
            </div>
            <div class="avatar-wrap" aria-label="Profile photo (circular)">
              <img id="avatar" alt="User photo" />
            </div>

            <p class="name" id="userName">Your Name</p>
            <p class="sub" id="userEmail">email@example.com</p>

            <!-- Barra de n√≠vel -->
            <div class="level-wrap" aria-label="Customer level">
              <div class="level-head">
                <div class="badge"><span class="badge-dot" id="levelDot"></span> <span id="levelLabel">Bronze</span></div>
                <span class="pill"><strong id="levelProgressText">‚Ç¨0</strong> this month</span>
              </div>

              <div class="level-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                <div class="level-fill" id="levelFill"></div>
              </div>

              <div class="level-splits" aria-label="Bronze, Silver e Gold">
                <span id="lvlBronze" class="on"><i></i> Bronze</span>
                <span id="lvlSilver"><i></i> Silver</span>
                <span id="lvlGold"><i></i> Gold</span>
              </div>
              <div class="muted" style="margin-top:8px; font-weight:700;" id="levelHint">Fill the bar to level up.</div>

              <!-- Cashback + giros (clean) -->
              <div class="row" style="margin-top:10px; justify-content:center;">
                <span class="pill">‚≠ê Cashback: <strong><span id="pointsNow">0</span> pts</strong> <span class="muted" id="cashValue">= ‚Ç¨ 0.00</span></span>
                <span class="pill">üé° Spins: <strong id="spinsNow">0</strong></span>
              </div>
              <div class="muted" style="margin-top:6px; font-weight:800;" id="resetHint">Resets at 00:00 (Ireland).</div>
            </div>


          </div>
        </div>

        <!-- ROleta sempre vis√≠vel -->
        <div class="wheel-area">
          <div class="card">
            <div class="row">
              <strong>üé° Lucky wheel</strong>
              <span class="pill"><strong id="spinStatus">‚Äî</strong></span>
            </div>

            
<div class="wheel-stack">
  <div class="wheel-box" aria-label="Prize wheel">
    <div class="pointer" aria-hidden="true"></div>
    <div class="wheel-rotate" id="wheelRotate">
      <canvas id="wheelCanvas" width="640" height="640" aria-label="Wheel"></canvas>
    </div>
  </div>
<div id="extra-spins" class="muted" style="margin-bottom:6px;font-weight:700;">Spins dispon√≠veis: 1</div>

  <button class="btn primary" id="btnSpin" type="button">Spin now</button>

  <div class="muted wheel-instructions" id="wheelInstructions">
    <strong>Instructions:</strong> click <strong>‚ÄúSpin now‚Äù</strong>. Prize positions reshuffle automatically on every spin.
    You have <strong>1 spin per day</strong> ‚Äî it resets at <strong>midnight (official Ireland time)</strong>.
    If you win <strong>EXTRA SPIN</strong>, it is added instantly.
  </div>

  <div class="muted" style="margin-top:6px; font-weight:800;" id="spinResultMsg">‚Äî</div>
</div>


            </div>
          </div>
        </div>

        <footer>¬© <span id="year"></span> Vintage Wear Ireland</footer>
      </div>
    </div>
  </div>

  <input id="avatarFileInput" type="file" accept="image/*" class="hidden" />
  <script src="vintage-auth.js"></script>
  <script src="auth-guard.js"></script>


  <script>
    // ====== Estado (demo) ======
    const state = {
  me: null,
  spentMonth: 0,
  spentTotal: 0,
  points: 0,
  spinsPerDay: 1,
  spinsLeftToday: 1,
  extraSpins: 0,      // <-- adiciona esta linha
  lastIrelandDate: null,
  cart: [],
  orders: [],
  cashbackHistory: [],
  addresses: [],
  avatarFile: null,
};


    const fmtEUR = (n) => {
      const v = Number(n);
      if (Number.isNaN(v)) return '‚Ç¨ ' + (n ?? '');
      return '‚Ç¨ ' + v.toFixed(2);
    };

    const pointsToCash = (points) => Number(points || 0) * 0.5; // 10 pts = ‚Ç¨5
    const calcPointsEarned = (totalSpent) => Math.floor((Number(totalSpent) || 0) / 55) * 10;

    function getLevelMeta(spentMonth){
      const v = Number(spentMonth) || 0;
      const progressText = `‚Ç¨${v.toFixed(0)} this month`;

      // Bronze: 0-300, Silver: 300-800, Gold: >=800
      if (v >= 800){
        return {
          key:'GOLD',
          label:'Gold',
          dot:'var(--gold2)',
          fill:['rgba(212,175,55,.95)','rgba(240,180,59,.95)'],
          pct: 100,
          progressText,
          nextLabel: null,
          remaining: 0,
          target: 800,
        };
      }
      if (v >= 300){
        return {
          key:'SILVER',
          label:'Silver',
          dot:'var(--silver)',
          fill:['rgba(192,192,192,.95)','rgba(192,192,192,.75)'],
          pct: ((v-300)/(800-300))*100,
          progressText,
          nextLabel:'Gold',
          remaining: 800 - v,
          target: 800,
        };
      }
      return {
        key:'BRONZE',
        label:'Bronze',
        dot:'var(--bronze)',
        fill:['rgba(205,127,50,.95)','rgba(205,127,50,.78)'],
        pct: (v/300)*100,
        progressText,
        nextLabel:'Silver',
        remaining: 300 - v,
        target: 300,
      };
    }

    function $(id){ return document.getElementById(id); }

    function setText(id, t){ const el=$(id); if(el) el.textContent = t; }
    function setHTML(id, t){ const el=$(id); if(el) el.innerHTML = t; }

function escAttr(v){
      return String(v ?? '')
        .replace(/&/g,'&amp;')
        .replace(/"/g,'&quot;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;');
    }

    // ====== Irlanda (reset di√°rio) + persist√™ncia (demo) ======
    const IRELAND_TZ = 'Europe/Dublin';
    const STORAGE_KEY = 'vwi_painel_v3_en';

    let resetTickInterval = null;
    let resetTimeout = null;

    function getIrelandDateKey(date = new Date()){
      const parts = new Intl.DateTimeFormat('en-CA', {
        timeZone: IRELAND_TZ,
        year:'numeric', month:'2-digit', day:'2-digit'
      }).formatToParts(date);
      const p = {};
      for (const it of parts) if (it.type !== 'literal') p[it.type] = it.value;
      return `${p.year}-${p.month}-${p.day}`;
    }

    function getIrelandHMS(date = new Date()){
      const parts = new Intl.DateTimeFormat('en-GB', {
        timeZone: IRELAND_TZ,
        hour12:false,
        hour:'2-digit', minute:'2-digit', second:'2-digit'
      }).formatToParts(date);
      const p = {};
      for (const it of parts) if (it.type !== 'literal') p[it.type] = it.value;
      return { h: Number(p.hour||0), m: Number(p.minute||0), s: Number(p.second||0) };
    }

    function msUntilIrelandMidnight(){
      const {h,m,s} = getIrelandHMS();
      const since = h*3600 + m*60 + s;
      const remaining = 24*3600 - since;
      return Math.max(0, remaining*1000);
    }

    function formatCountdown(ms){
      const total = Math.max(0, Math.floor(ms/1000));
      const h = Math.floor(total/3600);
      const m = Math.floor((total%3600)/60);
      return `${h}h ${String(m).padStart(2,'0')}m`;
    }

    function loadPersisted(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (typeof data.points === 'number') state.points = data.points;
        if (Array.isArray(data.cashbackHistory)) state.cashbackHistory = data.cashbackHistory;
      } catch(_){ /* ignore */ }
    }

    function savePersisted(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          points: state.points,
          cashbackHistory: state.cashbackHistory,
        }));
      } catch(_){ /* ignore */ }
    }

    function ensureDailyReset(){
      const todayKey = getIrelandDateKey();
      if (state.lastIrelandDate !== todayKey){
        state.lastIrelandDate = todayKey;
        // Server controls spins availability; do not overwrite it here.
      }
    }

    function updateResetHint(){
      setText('resetHint', `Resets at midnight (Ireland) ‚Äî in ${formatCountdown(msUntilIrelandMidnight())}.`);
    }

    function scheduleResetTimers(){
      if (resetTickInterval) clearInterval(resetTickInterval);
      if (resetTimeout) clearTimeout(resetTimeout);

      updateResetHint();
      resetTickInterval = setInterval(updateResetHint, 30*1000);
      resetTimeout = setTimeout(() => {
        ensureDailyReset();
        renderHero();
        scheduleResetTimers();
      }, msUntilIrelandMidnight() + 1100);
    }

    function defaultAvatarDataUri(){
      const svg = encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="240" height="240" viewBox="0 0 240 240">
          <defs>
            <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
              <stop stop-color="#D4AF37" stop-opacity="0.35"/>
              <stop stop-color="#f0b43b" stop-opacity="0.18" offset="1"/>
            </linearGradient>
          </defs>
          <rect width="240" height="240" rx="120" fill="url(#g)"/>
          <circle cx="120" cy="92" r="44" fill="rgba(43,39,35,0.16)"/>
          <path d="M48 212c14-46 50-68 72-68s58 22 72 68" fill="rgba(43,39,35,0.14)"/>
        </svg>
      `);
      return `data:image/svg+xml;charset=utf-8,${svg}`;
    }

    // ====== Render ======
    function renderHero(){
      const me = state.me || {};
      setText('userName', me.name || 'Your Name');
      setText('userEmail', me.email || 'email@example.com');

      // avatar
      const img = $('avatar');
      if (img){
        img.src = me.avatar || defaultAvatarDataUri();
      }

      // points + cash
      setText('pointsNow', String(state.points || 0));
      setText('cashValue', `= ${fmtEUR(pointsToCash(state.points || 0))}`);

      // level (progresso por gasto)
      const meta = getLevelMeta(state.spentMonth);

      setText('levelLabel', meta.label);
      const dot = $('levelDot');
      if (dot){
        dot.style.background = meta.dot;
        dot.style.boxShadow = `0 0 0 4px rgba(0,0,0,.08)`;
      }

      const fill = $('levelFill');
      if (fill){
        fill.style.width = Math.max(0, Math.min(100, meta.pct)) + '%';
        fill.style.background = `linear-gradient(90deg, ${meta.fill[0]}, ${meta.fill[1]})`;
      }

      setText('levelProgressText', meta.progressText);
      if (meta.nextLabel){
        setText('levelHint', `‚Ç¨${Math.max(0, meta.remaining).toFixed(0)} to reach ${meta.nextLabel}. Target: ‚Ç¨${Number(meta.target||0).toFixed(0)}.`);
      } else {
        setText('levelHint', 'Top level reached. Keep earning cashback.');
      }

      // highlight splits
      $('lvlBronze')?.classList.add('on');
      $('lvlSilver')?.classList.remove('on','silver');
      $('lvlGold')?.classList.remove('on','gold');

      if (meta.key === 'SILVER'){
        $('lvlSilver')?.classList.add('on','silver');
        $('lvlBronze')?.classList.add('on');
      } else if (meta.key === 'GOLD'){
        $('lvlSilver')?.classList.add('on','silver');
        $('lvlGold')?.classList.add('on','gold');
      } else {
        // bronze only
        $('lvlBronze')?.classList.add('on');
      }
      // spins (server authoritative: daily + bonus)
      const totalSpins = Math.max(0, Number(state.spinsLeftToday||0) + Number(state.extraSpins||0));
      setText('spinsNow', String(totalSpins));
      setText('spinStatus', `${totalSpins} spin(s)`);
      const exEl = $('extra-spins');
      if (exEl) exEl.textContent = `Spins dispon√≠veis: ${totalSpins}`;
      updateResetHint();
    }

    function renderConta(){
  const nameEl = $('accName');
  const emailEl = $('accEmail');
  const phoneEl = $('accPhone');
  if (!nameEl || !emailEl || !phoneEl) return;

  const me = state.me || {};
  nameEl.value = me.name || '';
  emailEl.value = me.email || '';
  phoneEl.value = me.phone || '';
}

    function renderAddresses(){
      const list = state.addresses || [];
      const wrap = $('addrList');
      if (!wrap) return;

      if (!list.length){
        wrap.innerHTML = `<div class="muted" style="font-weight:700;">No address saved yet.</div>`;
        return;
      }

      wrap.innerHTML = list.map(a => `
        <div class="card" style="padding:12px; margin:0;">
          <div class="row">
            <div>
              <div style="font-weight:900">${a.name || 'Address'}</div>
              <div class="muted" style="margin-top:6px; line-height:1.6">${a.line1 || ''}<br/>${a.line2 || ''}<br/>${a.country || ''}</div>
            </div>
            <div class="row" style="gap:8px;">
              <button class="btn small js-address-action" type="button" data-action="edit" data-address-id="${escAttr(String(a.id))}">Edit</button>
              <button class="btn small danger js-address-action" type="button" data-action="delete" data-address-id="${escAttr(String(a.id))}">Delete</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderCart(){
      const cart = Array.isArray(state.cart) ? state.cart : [];
      const totalItems = cart.reduce((s, it) => s + Number(it.qty || 1), 0);
      const total = cart.reduce((s, it) => s + (Number(it.price||0) * Number(it.qty||1)), 0);

      setHTML('cartCountTag', `<strong>${totalItems}</strong> items`);
      setHTML('cartTotalTag', `<strong>${fmtEUR(total)}</strong>`);

      const wrap = $('cartList');
      if (!wrap) return;

      if (!cart.length){
        wrap.innerHTML = `<div class="muted" style="font-weight:700;">Your cart is empty.</div>`;
        return;
      }

      wrap.innerHTML = cart.map(it => `
        <div class="card" style="padding:12px; margin:0;">
          <div class="row" style="flex-wrap:nowrap;">
            <div style="display:flex; gap:10px; align-items:center; min-width: 0;">
              <div style="width:44px;height:44px;border-radius:14px;background:rgba(0,0,0,.04);border:1px solid rgba(0,0,0,.06);display:flex;align-items:center;justify-content:center;font-weight:900;color:#3b2206;">
                ${String(it.title||'').slice(0,1).toUpperCase() || '‚Ä¢'}
              </div>
              <div style="min-width:0;">
                <div style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${it.title || 'Item'}</div>
                <div class="muted">${fmtEUR(it.price)} ‚Ä¢ qty: <strong>${it.qty || 1}</strong></div>
              </div>
            </div>
            <button class="btn small danger js-cart-action" type="button" data-action="remove" data-item-id="${escAttr(String(it.id))}">Remove</button>
          </div>
        </div>
      `).join('');
    }

    function statusToStepIndex(status){
      const s = String(status || '').toLowerCase();

      // English (and keep PT-BR fallbacks)
      if (s.includes('deliver')) return 4;
      if (s.includes('on the way') || s.includes('shipping') || s.includes('in transit')) return 3;
      if (s.includes('prepar') || s.includes('processing')) return 2;
      if (s.includes('confirm')) return 1;

      // PT-BR fallbacks
      if (s.includes('entreg')) return 4;
      if (s.includes('caminh') || s.includes('a caminho')) return 3;
      if (s.includes('prepar') || s.includes('em preparo')) return 2;
      return 1; // confirmed
    }

    function renderOrders(){
      const orders = Array.isArray(state.orders) ? state.orders : [];
      const wrap = $('ordersList');
      if (!wrap) return;

      if (!orders.length){
        wrap.innerHTML = `<div class="muted" style="font-weight:700;">No orders found.</div>`;
        return;
      }

      wrap.innerHTML = orders.map(o => {
        const step = statusToStepIndex(o.status);
        const pct = ((step-1)/3)*100;

        return `
          <div class="card" style="margin:0;">
            <div class="row">
              <div>
                <div style="font-weight:900">${o.id || '#‚Äî'}</div>
                <div class="muted" style="margin-top:4px">${o.date || ''} ‚Ä¢ ${fmtEUR(o.total || 0)}</div>
              </div>
              <span class="pill"><strong>${o.status || 'Confirmed'}</strong></span>
            </div>

            <div class="stepper-line"><span style="width:${pct}%;"></span></div>

            <div class="stepper" aria-label="Order progress">
              <div class="step ${step>=1?'done':''}">Confirmed</div>
              <div class="step ${step>=2?'done':''}">Preparing</div>
              <div class="step ${step>=3?'done':''}">On the way</div>
              <div class="step ${step>=4?'done':''}">Delivered</div>
            </div>

            <div class="muted" style="margin-top:10px; font-weight:700;">
              Tracking: <strong>${o.tracking || '‚Äî'}</strong>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderCashback(){
      setText('cashBalance', fmtEUR(pointsToCash(state.points || 0)));
      setText('pointsBalance', String(state.points || 0));

      const list = Array.isArray(state.cashbackHistory) ? state.cashbackHistory : [];
      const wrap = $('cashHistory');
      if (!wrap) return;

      if (!list.length){
        wrap.innerHTML = `<div class="muted" style="font-weight:700;">No activity yet.</div>`;
        return;
      }

      wrap.innerHTML = list.map(h => {
        const delta = Number(h.delta || 0);
        const sign = delta >= 0 ? '+' : '';
        const color = delta >= 0 ? '#2e3a12' : '#6b1710';
        return `
          <div class="card" style="margin:0;">
            <div class="row">
              <div>
                <div style="font-weight:900">${h.title || 'Activity'}</div>
                <div class="muted" style="margin-top:4px">${h.date || ''} ‚Ä¢ ${h.detail || ''}</div>
              </div>
              <span class="pill" style="border-color:rgba(0,0,0,.06)">
                <strong style="color:${color}">${sign}${delta} pts</strong>
              </span>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderAll(){
      renderHero();
      renderConta();
      renderAddresses();
      renderCart();
      renderOrders();
      renderCashback();
      setText('year', new Date().getFullYear());
    }

    // ====== A√ß√µes ======
    window.editAddress = function(id){
      const a = (state.addresses||[]).find(x => x.id === id);
      if (!a) return;
      const line1 = prompt('Street / Line 1:', a.line1 || '');
      if (line1 === null) return;
      const line2 = prompt('City / Line 2:', a.line2 || '');
      if (line2 === null) return;
      const country = prompt('Country:', a.country || '');
      if (country === null) return;
      a.line1 = line1; a.line2 = line2; a.country = country;
      setText('addrMsg', '‚úÖ Address updated.');
      renderAddresses();
    };

    window.deleteAddress = function(id){
      if (!confirm('Delete this address?')) return;
      state.addresses = (state.addresses||[]).filter(a => a.id !== id);
      setText('addrMsg', '‚úÖ Address deleted.');
      renderAddresses();
    };

    window.removeCartItem = function(id){
      state.cart = (state.cart||[]).filter(it => String(it.id) !== String(id));
      renderCart();
    };

    function clearCart(){
      if (!confirm('Clear the cart?')) return;
      state.cart = [];
      renderCart();
    }

    // Avatar picker (somente na Conta)
    function setAvatarFileName(name){
      $('avatarFileName').innerHTML = `<strong>${name || '‚Äî'}</strong>`;
    }

    function openAvatarPicker(){
      const input = $('avatarFileInput');
      input.value = '';
      input.click();
    }

    async function setAvatar(file){
      if (!file) return;
      state.avatarFile = file;
      setAvatarFileName(file.name);

      // preview imediato enquanto faz upload
      try {
        const previewUrl = URL.createObjectURL(file);
        state.me = state.me || {};
        state.me.avatar = previewUrl;
        renderHero();
      } catch (_) {}

      setText('accountMsg', 'Uploading photo‚Ä¶');

      const fd = new FormData();
      fd.append("avatar", file);

      const base = (window.VW_API && window.VW_API.root) || "https://clientes-0r5d.onrender.com";

      try{
        const headers = (window.VintageAuth && typeof window.VintageAuth.authHeaders==='function') ? window.VintageAuth.authHeaders() : {};

        const res = await fetch(base + "/user/me/avatar", {
          method: "POST",
          headers,
          body: fd
        });

        if (res.status === 401 || res.status === 403){
          setText('accountMsg', 'Please log in again.');
          window.location.href = 'cliente-login-2.html';
          return;
        }

        if (!res.ok){
          throw new Error("Error uploading");
        }

        let data = null;
        try{ data = await res.json(); } catch(_){}

        if (data && (data.avatar_url || data.avatar || data.avatarUrl)){
          let finalUrl = String(data.avatar_url || data.avatar || data.avatarUrl);
          if (!/^https?:\/\//i.test(finalUrl)){
            let path = finalUrl;
            if (!path.startsWith("/")) path = "/" + path;
            finalUrl = base + path;
          }
          finalUrl += (finalUrl.includes("?") ? "&" : "?") + "v=" + Date.now();
          state.me = state.me || {};
          state.me.avatar = finalUrl;
        }

        renderHero();
        setText('accountMsg', '‚úÖ Photo uploaded.');
      } catch(err){
        console.error(err);
        setText('accountMsg', '‚ùå Error uploading photo.');
      }
    }

    // Salvar conta (demo)
    function saveAccount(){
      const name = $('accName').value.trim();
      const email = $('accEmail').value.trim();
      const phone = $('accPhone').value.trim();
      state.me.name = name || state.me.name;
      state.me.email = email || state.me.email;
      state.me.phone = phone || state.me.phone;
      setText('accountMsg', '‚úÖ Changes saved.');
      renderHero();
    }

    // Senha (demo)
    function changePassword(){
      const n1 = $('passNew').value.trim();
      const n2 = $('passConfirm').value.trim();

      if (!n1 || n1.length < 6){
        setText('passMsg', 'Use at least 6 characters.');
        return;
      }
      if (n1 !== n2){
        setText('passMsg', "Confirmation doesn't match.");
        return;
      }
      $('passCurrent').value = '';
      $('passNew').value = '';
      $('passConfirm').value = '';
      setText('passMsg', '‚úÖ Password updated.');
    }

    // Roleta (din√¢mica com pesos + posi√ß√µes aleat√≥rias)
let spinning = false;

const BASE_PRIZES = [
  { id:'cash20', label:'‚Ç¨20',        type:'cash',       value:20, weight: 3  },
  { id:'off5',   label:'5% OFF',     type:'discount',   value: 5, weight: 18 },
  { id:'off10',  label:'10% OFF',    type:'discount',   value:10, weight: 12 },
  { id:'pts10',  label:'10 POINTS',  type:'points',     value:10, weight: 24 },
  { id:'ship',   label:'FREE SHIPPING',type:'shipping',  value: 1, weight: 14 },
  { id:'extra',  label:'EXTRA SPIN', type:'extra_spin', value: 1, weight: 10 },
];

const wheel = {
  rotateEl: null,
  canvas: null,
  ctx: null,
  dpr: 1,
  size: 0,
  currentDeg: 0,
  prizes: [],
};

function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

function shuffle(arr){
  const a = arr.slice();
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function jitterWeights(prizes){
  // D√° uma leve variada para n√£o ficar "padr√£o", mas mant√©m o maior pr√™mio com menor chance.
  return prizes.map(p => {
    let mult = 0.85 + Math.random()*0.30; // 0.85..1.15
    // Segura o ‚Ç¨20 numa faixa menor (pr√™mio maior)
    if (p.id === 'cash20'){
      mult = 0.70 + Math.random()*0.20;   // 0.70..0.90
    }
    // GIRO EXTRA: m√©dio (nem t√£o raro)
    if (p.id === 'extra'){
      mult = 0.85 + Math.random()*0.25;   // 0.85..1.10
    }
    return { ...p, w: Math.max(1, p.weight * mult) };
  });
}

function pickWeighted(prizesWithW){
  const total = prizesWithW.reduce((s,p)=>s + p.w, 0);
  let r = Math.random() * total;
  for (const p of prizesWithW){
    r -= p.w;
    if (r <= 0) return p;
  }
  return prizesWithW[prizesWithW.length-1];
}

function setupWheel(){
  wheel.rotateEl = document.getElementById('wheelRotate');
  wheel.canvas = document.getElementById('wheelCanvas');
  if (!wheel.rotateEl || !wheel.canvas) return;

  wheel.ctx = wheel.canvas.getContext('2d');
  wheel.dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

  const resize = () => {
    const box = wheel.rotateEl.getBoundingClientRect();
    const cssSize = Math.floor(Math.min(box.width, box.height));
    wheel.size = Math.max(240, cssSize);
    const px = Math.floor(wheel.size * wheel.dpr);
    wheel.canvas.width = px;
    wheel.canvas.height = px;
    wheel.ctx.setTransform(wheel.dpr,0,0,wheel.dpr,0,0);
    drawWheel(wheel.prizes.length ? wheel.prizes : shuffle(BASE_PRIZES));
  };

  window.addEventListener('resize', resize);
  resize();
}

function drawWheel(prizesOrder){
  if (!wheel.ctx) return;
  wheel.prizes = prizesOrder.slice();

  const ctx = wheel.ctx;
  const S = wheel.size;
  const cx = S/2, cy = S/2;
  const r = S/2;

  ctx.clearRect(0,0,S,S);

  const n = wheel.prizes.length;
  const seg = (Math.PI*2)/n;
  const start = -Math.PI/2; // topo

  const palette = [
    'rgba(212,175,55,.28)',
    'rgba(240,180,59,.26)',
    'rgba(255,142,127,.18)',
    'rgba(107,123,42,.16)',
  ];

  // segmentos
  for (let i=0;i<n;i++){
    const a0 = start + i*seg;
    const a1 = a0 + seg;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r-2,a0,a1);
    ctx.closePath();
    ctx.fillStyle = palette[i % palette.length];
    ctx.fill();

    // borda suave
    ctx.strokeStyle = 'rgba(212,175,55,.55)';
    ctx.lineWidth = 1;
    ctx.stroke();

    // texto
    const label = wheel.prizes[i].label || '';
    ctx.save();
    ctx.translate(cx,cy);
    const mid = a0 + seg/2;
    ctx.rotate(mid);
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = 'rgba(43,39,35,.92)';
    ctx.font = `800 ${clamp(Math.floor(S*0.045), 12, 16)}px Poppins, system-ui, sans-serif`;
    ctx.fillText(label, r*0.86, 0);
    ctx.restore();
  }

  // an√©is (acabamento)
  ctx.beginPath();
  ctx.arc(cx,cy,r-1,0,Math.PI*2);
  ctx.strokeStyle = 'rgba(212,175,55,.75)';
  ctx.lineWidth = 3;
  ctx.stroke();

  ctx.beginPath();
  ctx.arc(cx,cy,r*0.22,0,Math.PI*2);
  ctx.fillStyle = 'rgba(255,255,255,.75)';
  ctx.fill();

  ctx.beginPath();
  ctx.arc(cx,cy,r*0.22,0,Math.PI*2);
  ctx.strokeStyle = 'rgba(0,0,0,.06)';
  ctx.lineWidth = 2;
  ctx.stroke();

  // texto central
  ctx.fillStyle = '#3b2206';
  ctx.font = `900 ${clamp(Math.floor(S*0.060), 14, 20)}px Orbitron, Poppins, system-ui, sans-serif`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('SPIN', cx, cy);
}

function animateToPrize(prizeId){
  return new Promise((resolve) => {
    const n = wheel.prizes.length;
    const seg = 360 / n;

    const idx = wheel.prizes.findIndex(p => p.id === prizeId);
    const safeIdx = idx >= 0 ? idx : 0;

    // alvo: ponteiro no topo (0deg relativo), com um pequeno offset aleat√≥rio dentro do segmento
    const offset = (Math.random()*0.7 - 0.35) * seg; // -35%..+35%
    const targetDeg = -(safeIdx*seg + seg/2 + offset);

    const current = wheel.currentDeg;
    const currentMod = ((current % 360) + 360) % 360;
    const targetMod = ((targetDeg % 360) + 360) % 360;

    const extraTurns = 6 + Math.floor(Math.random()*4); // 6..9 voltas
    let delta = targetMod - currentMod;
    if (delta < 0) delta += 360;

    const finalDeg = current + extraTurns*360 + delta;
    wheel.currentDeg = finalDeg;

    wheel.rotateEl.style.transition = 'transform 2.8s cubic-bezier(.16,.88,.25,1)';
    wheel.rotateEl.style.transform = `rotate(${finalDeg}deg)`;

    const done = () => {
      wheel.rotateEl.removeEventListener('transitionend', done);
      wheel.rotateEl.style.transition = '';
      resolve();
    };
    wheel.rotateEl.addEventListener('transitionend', done);
  });
}

async function spin(){
  if (spinning) return;
  ensureDailyReset();
  if (state.spinsLeftToday <= 0){
    setText('spinResultMsg', 'You have already used your spins for today.');
    return;
  }

  const btn = document.getElementById('btnSpin');
  spinning = true;
  if (btn) btn.disabled = true;

  setText('spinResultMsg', 'Spinning‚Ä¶');

  try{
    // 1) calcula pesos com leve varia√ß√£o
    const weighted = jitterWeights(BASE_PRIZES);

    // 2) define o pr√™mio vencedor por peso (mais chance nos pr√™mios "fracos")
    const winner = pickWeighted(weighted);

    // 3) embaralha posi√ß√µes (din√¢mico) e redesenha
    const order = shuffle(BASE_PRIZES);
    drawWheel(order);

    // 4) anima at√© o pr√™mio
    await animateToPrize(winner.id);

    // 5) aplica pr√™mio
    state.spinsLeftToday = Math.max(0, Number(state.spinsLeftToday||0) - 1);
    const dateKey = getIrelandDateKey();

    if (winner.type === 'points'){
      state.points = Number(state.points||0) + Number(winner.value||0);
      state.cashbackHistory.unshift({ date: dateKey, title:'Credit', delta:+Number(winner.value||0), detail:'Wheel' });
    } else if (winner.type === 'cash'){
      const pts = Math.round((Number(winner.value||0) / 0.5)); // ‚Ç¨20 => 40 pts
      state.points = Number(state.points||0) + pts;
      state.cashbackHistory.unshift({ date: dateKey, title:'Credit', delta:+pts, detail:'Wheel (+‚Ç¨20)' });
    } else if (winner.type === 'discount'){
      state.cashbackHistory.unshift({ date: dateKey, title:'Coupon', delta:0, detail:`${winner.value}% OFF (next purchase)` });
    } else if (winner.type === 'shipping'){
      state.cashbackHistory.unshift({ date: dateKey, title:'Coupon', delta:0, detail:'Free shipping (next purchase)' });
            } else if (winner.type === 'extra_spin'){
          // registra no hist√≥rico
          state.cashbackHistory.unshift({
            date: dateKey,
            title:'Bonus',
            delta:0,
            detail:'Wheel (Extra spin)',
          });

          // avisa o backend que ganhou giro extra
          try{
            const rApi = window.VW_API;
            if (rApi && typeof rApi.grantExtraSpin === 'function'){
              await rApi.grantExtraSpin(1, 'wheel');
            }
          } catch(err){
            console.warn('Erro ao creditar extra spin no backend:', err && err.message || err);
          }
        }

       // ===== Sincroniza pr√™mios com o banco (MySQL) via API =====
    try{
      const api = window.VW_API;
      if (api && api.apiJson){
        if (winner.type === 'points'){
          const r = await api.creditPoints(Number(winner.value||0), 'wheel');
          if (r && typeof r.points === 'number') state.points = r.points;
        } else if (winner.type === 'cash'){
          const ptsAdded = Math.round((Number(winner.value||0) / 0.5));
          const r = await api.creditPoints(ptsAdded, 'wheel_cash');
          if (r && typeof r.points === 'number') state.points = r.points;
        } else if (winner.type === 'discount'){
          const r = await api.grantDiscount(Number(winner.value||0));
          const ad = r?.activeDiscount || r?.active_discount;
          if (ad){
            state.activeDiscount = {
              id: ad.id ?? ad.discount_id ?? ad.discountId ?? null,
              percent: Number(ad.percent ?? winner.value ?? 0),
              expiresAt: ad.expiresAt || ad.expires_at || ad.expires || null,
            };
          }
        } else if (winner.type === 'shipping'){
          const r = await api.grantShipping();
          const sh = r?.activeShipping || r?.active_shipping;
          if (sh){
            state.activeShipping = {
              id: sh.id ?? sh.shipping_id ?? sh.shippingId ?? null,
              expiresAt: sh.expiresAt || sh.expires_at || sh.expires || null,
            };
          }
        } else if (winner.type === 'extra_spin'){
          if (api.grantExtraSpin){
            await api.grantExtraSpin(1, 'wheel');
          }
        }
      }
    } catch(err){
      console.warn('Falha ao sincronizar pr√™mio com API:', err?.message || err);
    }

    savePersisted();

    renderAll();
    setText('spinResultMsg', `üéÅ ${winner.label}`);
  } finally {
    spinning = false;
    if (btn) btn.disabled = false;
  }
}



    function addAddress(){
      const name = prompt('Address name (e.g., Home):', 'Home');
      if (name === null) return;
      const line1 = prompt('Street / Line 1:', '');
      if (line1 === null) return;
      const line2 = prompt('City / Line 2:', '');
      if (line2 === null) return;
      const country = prompt('Country:', 'Ireland');
      if (country === null) return;

      state.addresses.unshift({ id: 'a' + Math.random().toString(16).slice(2), name, line1, line2, country });
      setText('addrMsg', '‚úÖ Address added.');
      renderAddresses();
    }

    function logout(){
  if (window.VintageAuth && typeof window.VintageAuth.logout === 'function'){
    window.VintageAuth.logout();
    return;
  }
  // Fallback
  ['vw_token','token','authToken','auth_token','access_token'].forEach((k)=>{ try{ sessionStorage.removeItem(k); }catch(_){} });
  try{ sessionStorage.removeItem('vw_token'); }catch(_){}
  try{ document.cookie = 'vw_token=; Path=/; Max-Age=0; SameSite=Lax'; }catch(_){}
  window.location.href = 'cliente-login-2.html?back=painel.html';
}


    // ====== Dados demo ======
    function loadDemo(){
      // Clean defaults (demo)
      state.me = {
        name: '',
        email: '',
        phone: '',
        avatar: defaultAvatarDataUri(),
      };

      state.spentTotal = 0;
      state.spentMonth = 0;
      state.points = 0;

      state.spinsLeftToday = 1;

      state.cart = [];
      state.orders = [];
      state.cashbackHistory = [];
      state.addresses = [];

      setText('accountMsg', '‚Äî');
      setText('addrMsg', '‚Äî');
      setText('passMsg', '‚Äî');
      setText('spinResultMsg', '‚Äî');

      renderAll();
    }

    // ====== Eventos ======
    document.addEventListener('DOMContentLoaded', () => {
      loadDemo();

      // carrega estado salvo + aplica reset di√°rio por hor√°rio oficial da Irlanda
      loadPersisted();
      ensureDailyReset();
      renderAll();
      scheduleResetTimers();

      setupWheel();

      // Load authoritative rewards/spins from backend
      try{
        if (window.VW_API && typeof window.VW_API.loadRewardsStatus === 'function') {
          window.VW_API.loadRewardsStatus();
        }
      }catch(_){ }
      $('btnPickAvatar')?.addEventListener('click', openAvatarPicker);
      $('avatarFileInput')?.addEventListener('change', (e) => {
        const file = e.target.files ? e.target.files[0] : null;
        if (file) setAvatar(file);
      });

      $('btnSaveAccount')?.addEventListener('click', saveAccount);
      $('btnChangePass')?.addEventListener('click', changePassword);
      $('btnAddAddress')?.addEventListener('click', addAddress);
      $('btnClearCart')?.addEventListener('click', clearCart);
      $('btnLogout')?.addEventListener('click', logout);

      $('btnSpin')?.addEventListener('click', (e) => {
        e.preventDefault();
        spin();
      });
 
      // Delegated events (no inline handlers)
      const cartList = $('cartList');
      if (cartList && !cartList.dataset.boundClick){
        cartList.dataset.boundClick = '1';
        cartList.addEventListener('click', (ev) => {
          const btn = ev.target && ev.target.closest ? ev.target.closest('button[data-action="remove"][data-item-id]') : null;
          if (!btn) return;
          const id = btn.getAttribute('data-item-id') || '';
          removeCartItem(id);
        });
      }

      const addrList = $('addrList');
      if (addrList && !addrList.dataset.boundClick){
        addrList.dataset.boundClick = '1';
        addrList.addEventListener('click', (ev) => {
          const btn = ev.target && ev.target.closest ? ev.target.closest('button[data-action][data-address-id]') : null;
          if (!btn) return;
          const id = btn.getAttribute('data-address-id') || '';
          const act = btn.getAttribute('data-action') || '';
          if (act === 'edit') editAddress(id);
          if (act === 'delete') deleteAddress(id);
        });
      }


      // Global delegated actions (safety net for dynamic content)
      const root = document.body;
      if (root && !root.dataset.boundGlobalClick){
        root.dataset.boundGlobalClick = '1';
        root.addEventListener('click', (ev) => {
          const t = ev && ev.target && ev.target.closest ? ev.target.closest('button[data-action]') : null;
          if (!t) return;

          // Cart actions
          const itemId = t.getAttribute('data-item-id');
          const addrId = t.getAttribute('data-address-id');
          const act = (t.getAttribute('data-action') || '').toLowerCase();

          if (itemId && act === 'remove' && typeof removeCartItem === 'function'){
            removeCartItem(itemId);
            return;
          }

          // Address actions
          if (addrId && (act === 'edit' || act === 'delete')){
            if (act === 'edit' && typeof editAddress === 'function') editAddress(addrId);
            if (act === 'delete' && typeof deleteAddress === 'function') deleteAddress(addrId);
            return;
          }
        }, { passive: true });
      }

});

    // ======= Campo reativo dourado =======
    (() => {
      const MAX_PARTICLES_BASE = 120;
      const LINK_DIST = 170;
      const SAFETY_MARGIN = 22;
      const MOUSE_REPEL_RADIUS = 120 + SAFETY_MARGIN;
      const MOUSE_FORCE = 0.14;
      const SPEED = 0.55;
      const FRICTION = 0.965;

      const canvas = document.getElementById('reactiveField');
      if (!canvas) return;
      const ctx = canvas.getContext('2d', { alpha: true });
      let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      let W = 0, H = 0;

      function resize(){
        W = canvas.clientWidth = window.innerWidth;
        H = canvas.clientHeight = window.innerHeight;
        canvas.width = Math.floor(W * DPR);
        canvas.height = Math.floor(H * DPR);
        ctx.setTransform(DPR,0,0,DPR,0,0);
      }
      resize();

      window.addEventListener('resize', () => {
        DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        resize();
        init();
      });

      const pts = [];
      function rand(min,max){ return Math.random()*(max-min)+min; }

      function init(){
        pts.length = 0;
        const area = W * H;
        const max = Math.max(70, Math.min(MAX_PARTICLES_BASE, Math.floor(area / 14000)));
        for (let i=0;i<max;i++){
          pts.push({
            x: rand(0,W),
            y: rand(0,H),
            vx: rand(-SPEED, SPEED),
            vy: rand(-SPEED, SPEED),
            r: rand(1.2, 2.2),
          });
        }
      }
      init();

      const mouse = { x: -9999, y: -9999, active: false };
      window.addEventListener('mousemove', (e) => { mouse.x = e.clientX; mouse.y = e.clientY; mouse.active = true; });
      window.addEventListener('mouseleave', () => { mouse.active = false; mouse.x = -9999; mouse.y = -9999; });

      function draw(){
        ctx.clearRect(0,0,W,H);

        for (const p of pts){
          if (mouse.active){
            const dx = p.x - mouse.x;
            const dy = p.y - mouse.y;
            const d2 = dx*dx + dy*dy;
            if (d2 < MOUSE_REPEL_RADIUS*MOUSE_REPEL_RADIUS){
              const d = Math.sqrt(d2) || 1;
              const f = (1 - d / MOUSE_REPEL_RADIUS) * MOUSE_FORCE;
              p.vx += (dx / d) * f;
              p.vy += (dy / d) * f;
            }
          }

          p.vx *= FRICTION;
          p.vy *= FRICTION;

          p.x += p.vx;
          p.y += p.vy;

          if (p.x < -20) p.x = W + 20;
          if (p.x > W + 20) p.x = -20;
          if (p.y < -20) p.y = H + 20;
          if (p.y > H + 20) p.y = -20;
        }

        for (let i=0;i<pts.length;i++){
          for (let j=i+1;j<pts.length;j++){
            const a = pts[i], b = pts[j];
            const dx = a.x - b.x;
            const dy = a.y - b.y;
            const d = Math.sqrt(dx*dx + dy*dy);
            if (d < LINK_DIST){
              const alpha = (1 - d/LINK_DIST) * 0.22;
              ctx.strokeStyle = `rgba(212,175,55,${alpha})`;
              ctx.lineWidth = 1;
              ctx.beginPath();
              ctx.moveTo(a.x,a.y);
              ctx.lineTo(b.x,b.y);
              ctx.stroke();
            }
          }
        }

        for (const p of pts){
          ctx.fillStyle = 'rgba(212,175,55,0.35)';
          ctx.beginPath();
          ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
          ctx.fill();
        }

        requestAnimationFrame(draw);
      }
      draw();
    })();
  </script>
<script>
(function(){
    const API_ROOT = "https://clientes-0r5d.onrender.com"; // backend de login/conta
    const REWARDS_ROOT = "https://vw-rewards-backend-production.up.railway.app"; // backend de pontos/b√¥nus (Railway)
  function getToken(){
      return (window.VintageAuth && typeof window.VintageAuth.getToken==='function') ? window.VintageAuth.getToken() : null;
    }
}



    async function apiJson(path, opts = {}){
    const p = String(path || '');
    const isRewards = p.startsWith('/rewards/') || p.startsWith('/checkout/');
    const base = isRewards ? REWARDS_ROOT : API_ROOT;
    const url = base + path;
    const init = {
      method: opts.method || 'GET',
      headers: {
        'Content-Type': 'application/json',
        ...(opts.headers || {}),
        ...authHeaders(),
        },
    };
    if (opts.body !== undefined) init.body = (typeof opts.body === 'string') ? opts.body : JSON.stringify(opts.body);

    const res = await fetch(url, init);
    if (res.status === 401 || res.status === 403){
      requireTokenOrRedirect();
      throw new Error('unauthorized');
    }

    const text = await res.text();
    let data = null;
    try{ data = text ? JSON.parse(text) : null; } catch(_){ data = text; }

    if (!res.ok){
      const msg = (data && (data.error || data.message)) || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  function syncPointsUI(points){
    const p = document.getElementById('pointsNow');
    if (p) p.textContent = String(points ?? 0);
    const cash = document.getElementById('cashValue');
    if (cash){
      const eur = (Number(points||0) * 0.5);
      cash.textContent = '= ‚Ç¨ ' + eur.toFixed(2);
    }
  }

  async function loadRewardsStatus(){
    try{
      const data = await apiJson('/rewards/status', { method:'GET' });

      // Bonus spins
      state.extraSpins = Number(
        data?.extraSpins ?? data?.extra_spins ?? data?.bonusSpins ?? data?.bonus_spins ?? data?.extra_spin ?? 0
      ) || 0;

      // Remaining time until next daily spin (optional fields)
      const remainingMs = Number(
        data?.remainingMs ?? data?.remaining_ms ??
        data?.nextSpinMs ?? data?.next_spin_ms ??
        data?.cooldownMs ?? data?.cooldown_ms ??
        data?.nextDailySpinMs ?? data?.next_daily_spin_ms ??
        0
      ) || 0;

      // Client-side cooldown (set right after a successful spin) using performance.now
      const clientRemainingMs = (() => {
        try{
          if (!window.__spinRemain) return 0;
          const start = Number(window.__spinRemain.startPerf || 0);
          const base = Number(window.__spinRemain.remainingMs || 0);
          const now = (window.performance && typeof window.performance.now === 'function') ? window.performance.now() : 0;
          return Math.max(0, Math.floor(base - (now - start)));
        }catch(_){ return 0; }
      })();

      // Daily spins left (preferred: explicit numeric fields)
      const numericDaily =
        (typeof data?.spinsLeftToday === 'number' ? data.spinsLeftToday : undefined) ??
        (typeof data?.spins_left_today === 'number' ? data.spins_left_today : undefined) ??
        (typeof data?.spinsLeft === 'number' ? data.spinsLeft : undefined) ??
        (typeof data?.spins_left === 'number' ? data.spins_left : undefined) ??
        (typeof data?.dailySpinsLeft === 'number' ? data.dailySpinsLeft : undefined) ??
        (typeof data?.daily_spins_left === 'number' ? data.daily_spins_left : undefined);

      if (typeof numericDaily === 'number'){
        state.spinsLeftToday = Math.max(0, Number(numericDaily) || 0);
      } else {
        // Boolean-ish fields
        const raw =
          data?.canSpin ?? data?.can_spin ??
          data?.canSpinToday ?? data?.can_spin_today ??
          data?.spinAvailable ?? data?.spin_available ??
          data?.spinsAvailable ?? data?.spins_available ??
          data?.dailySpinAvailable ?? data?.daily_spin_available ??
          data?.dailySpin ?? data?.daily_spin;

        const can = (raw === true || raw === 1 || raw === '1' || raw === 'true');

        // If server exposes remainingMs > 0 => not available
        if (remainingMs > 0){
          state.spinsLeftToday = 0;
        } else if (raw !== undefined){
          state.spinsLeftToday = can ? 1 : 0;
        } else {
          // Fallback: if we have an active server cooldown, keep locked (0); otherwise assume 1
          state.spinsLeftToday = clientRemainingMs > 0 ? 0 : 1;
        }
      }

      // Store remainingMs for countdown + auto-refresh (uses performance.now to ignore clock changes)
      try{
        if (remainingMs > 0){
          window.__spinRemain = {
            startPerf: (window.performance && typeof window.performance.now === 'function') ? window.performance.now() : 0,
            remainingMs,
          };
        } else {
          window.__spinRemain = null;
        }
      }catch(_){}

      // Update spins UI consistently
      const totalSpins = Math.max(0, Number(state.spinsLeftToday||0) + Number(state.extraSpins||0));
      const exEl = document.getElementById('extra-spins');
      if (exEl) exEl.innerText = `Spins dispon√≠veis: ${totalSpins}`;

      // Schedule a refresh right after cooldown ends (if provided)
      try{
        if (remainingMs > 0){
          if (window.__spinRefreshTimer) clearTimeout(window.__spinRefreshTimer);
          window.__spinRefreshTimer = setTimeout(() => {
            try{
              if (window.VW_API && typeof window.VW_API.loadRewardsStatus === 'function'){
                window.VW_API.loadRewardsStatus();
              }
            }catch(_){}
          }, remainingMs + 1500);
        }
      }catch(_){}

      const points = Number(data?.points ?? data?.user?.points ?? 0);
      if (typeof state !== 'undefined') state.points = points;

      const ad = data?.activeDiscount || data?.active_discount || null;
      if (typeof state !== 'undefined'){
        state.activeDiscount = ad ? {
          id: ad.id ?? ad.discount_id ?? ad.discountId ?? null,
          percent: Number(ad.percent ?? ad.value ?? 0),
          expiresAt: ad.expiresAt || ad.expires_at || ad.expires || null,
        } : null;
      }

      const ar = data?.appliedReward || data?.applied_redemption || data?.redemption || null;
      if (typeof state !== 'undefined' && ar){
        state.appliedReward = {
          id: ar.id ?? ar.redemption_id ?? ar.redemptionId ?? null,
          type: ar.type || null,
          amountEUR: Number(ar.amountEUR ?? ar.amount_eur ?? 0),
          pointsUsed: Number(ar.pointsUsed ?? ar.points_used ?? 0),
          percent: Number(ar.percent ?? 0),
        };
      }

      syncPointsUI(points);
      if (typeof renderAll === 'function') renderAll();
      if (typeof renderCart === 'function') renderCart();

      return data;
    } catch(err){
      console.warn('Rewards status not loaded:', err?.message || err);
      return null;
    }
  }

   window.VW_API = window.VW_API || {};
  window.VW_API.root = API_ROOT;
  window.VW_API.apiJson = apiJson;
  window.VW_API.loadRewardsStatus = loadRewardsStatus;

  window.VW_API.applyPoints = (points) =>
    apiJson('/rewards/apply-points', { method:'POST', body:{ points } });

  window.VW_API.applyDiscount = () =>
    apiJson('/rewards/apply-discount', { method:'POST', body:{} });

  window.VW_API.grantDiscount = (percent) =>
    apiJson('/rewards/grant-discount', { method:'POST', body:{ percent } });

  window.VW_API.grantShipping = () =>
    apiJson('/rewards/grant-shipping', { method:'POST', body:{} });

  window.VW_API.creditPoints = (points, source='wheel') =>
    apiJson('/rewards/credit-points', { method:'POST', body:{ points, source } });

  // NOVO: credita EXTRA SPIN no backend
  window.VW_API.grantExtraSpin = (count = 1, source = 'wheel') =>
    apiJson('/rewards/grant-extra-spin', { method:'POST', body:{ count, source } });

  window.VW_API.checkoutCreate = (payload) =>
    apiJson('/checkout/create', { method:'POST', body: payload || {} });


  function defaultAvatarDataUri(){
    const svg = encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="240" height="240" viewBox="0 0 240 240">
        <defs>
          <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
            <stop stop-color="#D4AF37" stop-opacity="0.35"/>
            <stop stop-color="#f0b43b" stop-opacity="0.18" offset="1"/>
          </linearGradient>
        </defs>
        <rect width="240" height="240" rx="120" fill="url(#g)"/>
        <circle cx="120" cy="92" r="44" fill="rgba(43,39,35,0.16)"/>
        <path d="M48 212c14-46 50-68 72-68s58 22 72 68" fill="rgba(43,39,35,0.14)"/>
      </svg>
    `);
    return `data:image/svg+xml;charset=utf-8,${svg}`;
  }

  function applyAvatar(user){
    const img = document.getElementById("avatar");
    if (!img) return;

    const raw = (user && (user.avatar_url || user.avatar || user.avatarUrl || user.photo_url || user.photoUrl)) || "";

    if (!raw) {
      const def = defaultAvatarDataUri();
      img.src = def;
      try{
        if (typeof state !== "undefined" && state.me){
          state.me.avatar = def;
        }
      }catch(_){}
      return;
    }

    let url = String(raw);
    if (!/^https?:\/\//i.test(url)) {
      if (!url.startsWith("/")) url = "/" + url;
      url = API_ROOT + url;
    }

    // cache-bust so the new photo appears immediately
    url += (url.includes("?") ? "&" : "?") + "v=" + Date.now();
    img.src = url;
    try{
      if (typeof state !== "undefined" && state.me){
        state.me.avatar = url;
      }
    }catch(_){}
  }

  async function loadProfile(){
    requireTokenOrRedirect();

    try {
      const res = await fetch(API_ROOT + "/user/me", { headers: authHeaders() });

      if (res.status === 401 || res.status === 403) {
        requireTokenOrRedirect();
        return;
      }

      if (!res.ok) {
        console.warn("Falha ao carregar /user/me:", res.status);
        return;
      }

      const user = await res.json();

      try{ if (typeof state !== 'undefined') state.me = user; }catch(_){ }
      try{ sessionStorage.setItem('vw_user_cache', JSON.stringify(user)); }catch(_){ }
      try{ if (user && (user.id ?? user.user_id ?? user.userId)) sessionStorage.setItem('vw_user_id', String(user.id ?? user.user_id ?? user.userId)); }catch(_){ }

      const nameEl = document.getElementById("userName");
      const emailEl = document.getElementById("userEmail");

      if (nameEl) nameEl.textContent = user.name || "Your Name";
      if (emailEl) emailEl.textContent = user.email || "email@example.com";

      applyAvatar(user);

      // carrega pontos + desconto (DB)
      loadRewardsStatus();
    } catch (err) {
      console.error("Erro carregando /user/me", err);
    }
  }

  document.addEventListener("DOMContentLoaded", loadProfile);
})();
</script>
<script>
// Override do SPIN para usar o backend e bloquear por 24h independente do hor√°rio do PC
(function(){
  // Formata o remainingMs que vem do backend em "Xh YYm"
  function formatMsToHM(ms){
    const total = Math.max(0, Math.floor(ms / 1000));
    const h = Math.floor(total / 3600);
    const m = Math.floor((total % 3600) / 60);
    return `${h}h ${String(m).padStart(2, '0')}m`;
  }

  // Sobrescreve o texto de reset para n√£o depender do rel√≥gio do computador
  window.updateResetHint = function(){
    // Uses performance.now so changing system clock doesn't fake the cooldown.
    function getRemainingMs(){
      try{
        if (!window.__spinRemain) return 0;
        const start = Number(window.__spinRemain.startPerf || 0);
        const base = Number(window.__spinRemain.remainingMs || 0);
        const now = (window.performance && typeof window.performance.now === 'function') ? window.performance.now() : 0;
        return Math.max(0, Math.floor(base - (now - start)));
      }catch(_){ return 0; }
    }

    const rem = getRemainingMs();
    const totalSpins = Math.max(0,
      Number((typeof state !== 'undefined' ? state.spinsLeftToday : 0) || 0) +
      Number((typeof state !== 'undefined' ? state.extraSpins : 0) || 0)
    );

    let msg = 'Limit: 1 spin every 24 hours (server time).';
    if (totalSpins > 0){
      msg = `You have ${totalSpins} spin(s) available.`;
    } else if (rem > 0){
      msg = `Next spin in ${formatMsToHM(rem)} (server cooldown).`;
    }

    if (typeof setText === 'function'){
      setText('resetHint', msg);
    } else {
      const el = document.getElementById('resetHint');
      if (el) el.textContent = msg;
    }
  };

  // Update the hint periodically and auto-refresh rewards right after cooldown ends (if known)
  window.scheduleResetTimers = function(){
    try{
      if (window.__spinHintInterval) clearInterval(window.__spinHintInterval);
      if (window.__spinHintTimeout) clearTimeout(window.__spinHintTimeout);
    }catch(_){}

    try{ if (typeof updateResetHint === 'function') updateResetHint(); }catch(_){}

    window.__spinHintInterval = setInterval(() => {
      try{ if (typeof updateResetHint === 'function') updateResetHint(); }catch(_){}
    }, 30*1000);

    // Safety: poll status occasionally so the UI flips back to 1 even if backend doesn't expose remainingMs
    try{
      if (window.__spinStatusPoll) clearInterval(window.__spinStatusPoll);
      window.__spinStatusPoll = setInterval(() => {
        try{
          if (window.VW_API && typeof window.VW_API.loadRewardsStatus === 'function'){
            window.VW_API.loadRewardsStatus();
          }
        }catch(_){}
      }, 10*60*1000); // every 10 minutes
    }catch(_){}

    // If we know remainingMs, refresh status when it ends
    try{
      if (window.__spinRemain){
        const start = Number(window.__spinRemain.startPerf || 0);
        const base = Number(window.__spinRemain.remainingMs || 0);
        const now = (window.performance && typeof window.performance.now === 'function') ? window.performance.now() : 0;
        const rem = Math.max(0, Math.floor(base - (now - start)));
        if (rem > 0){
          window.__spinHintTimeout = setTimeout(() => {
            try{
              if (window.VW_API && typeof window.VW_API.loadRewardsStatus === 'function'){
                window.VW_API.loadRewardsStatus();
              }
            }catch(_){}
          }, rem + 1500);
        }
      }
    }catch(_){}
  };

  // NOVA vers√£o da fun√ß√£o spin() ‚Äì sempre valida no servidor
  window.spin = async function(){
    if (typeof spinning !== 'undefined' && spinning) return;
    if (typeof spinning !== 'undefined') spinning = true;

    const btn = document.getElementById('btnSpin');
    if (btn) btn.disabled = true;

    if (typeof setText === 'function') {
      setText('spinResultMsg', 'Checking your spin‚Ä¶');
    }

    try{
      const api = window.VW_API;
      if (!api || !api.apiJson){
        if (typeof setText === 'function') {
          setText('spinResultMsg', 'Rewards service unavailable. Please try again.');
        }
        return;
      }

      let allowed = false;
      let remainingMs = 0;
      let spinRes = null;

      // *** AQUI a checagem real: /rewards/spin no backend ***
      try{
        spinRes = await api.apiJson('/rewards/spin', { method:'POST' });
        const res = spinRes;

        if (res && res.ok !== false && res.canSpin !== false){
          allowed = true;
        } else {
          remainingMs = Number(res && res.remainingMs || 0);
          const msg = res && (res.message || res.error) || '';

          if (remainingMs > 0){
            // store cooldown for countdown without relying on system clock
            try{
              window.__spinRemain = {
                startPerf: (window.performance && typeof window.performance.now === 'function') ? window.performance.now() : 0,
                remainingMs: remainingMs,
              };
            }catch(_){}
            const txt = `You already used your spin. Try again in ${formatMsToHM(remainingMs)}.`;
            if (typeof setText === 'function') setText('spinResultMsg', txt);
          } else {
            if (typeof setText === 'function') setText('spinResultMsg', msg || 'Spin not available right now.');
          }
          // Servidor bloqueou: atualiza status no backend e mant√©m UI consistente
          try{
            if (api && typeof api.loadRewardsStatus === 'function') await api.loadRewardsStatus();
          }catch(_){}
          try{ if (typeof scheduleResetTimers === 'function') scheduleResetTimers(); }catch(_){}
          if (typeof renderAll === 'function') renderAll();
          return;
        }
      } catch(err){
        console.warn('Error calling /rewards/spin:', err && err.message || err);
        if (typeof setText === 'function') {
          setText('spinResultMsg', 'Could not validate your spin. Please try again.');
        }
        return;
      }

      if (!allowed) return;

      // Consome 1 spin no estado local (para feedback imediato)
      try{
        if (typeof state !== 'undefined'){
          const hadDaily = Number(state.spinsLeftToday || 0) > 0;
          const hadExtra = Number(state.extraSpins || 0) > 0;

          if (hadDaily){
            state.spinsLeftToday = Math.max(0, Number(state.spinsLeftToday||0) - 1);
          } else if (hadExtra){
            state.extraSpins = Math.max(0, Number(state.extraSpins||0) - 1);
          }

          // Keep the counter at 0 until backend cooldown finishes
          const totalAfter = Math.max(0, Number(state.spinsLeftToday||0) + Number(state.extraSpins||0));
          const cooldownAfterMs = Number(
            spinRes?.remainingMsAfter ?? spinRes?.remaining_ms_after ??
            spinRes?.cooldownMs ?? spinRes?.cooldown_ms ??
            spinRes?.nextSpinMs ?? spinRes?.next_spin_ms ??
            spinRes?.nextDailySpinMs ?? spinRes?.next_daily_spin_ms ??
            spinRes?.remainingMs ?? spinRes?.remaining_ms ??
            0
          ) || 0;

          // Only lock when there are no spins left (daily/extra)
          if (totalAfter <= 0 && (hadDaily || cooldownAfterMs > 0)){
            const ms = cooldownAfterMs > 0 ? cooldownAfterMs : 24*60*60*1000;
            try{
              window.__spinRemain = {
                startPerf: (window.performance && typeof window.performance.now === 'function') ? window.performance.now() : 0,
                remainingMs: ms,
              };
            }catch(_){ }
          }
        }

        try{ if (typeof scheduleResetTimers === 'function') scheduleResetTimers(); }catch(_){ }
        if (typeof renderAll === 'function') renderAll();
      }catch(_){}

      // A partir daqui √© o mesmo fluxo antigo da roleta: anima, sorteia e aplica pr√™mio
      if (typeof setText === 'function') {
        setText('spinResultMsg', 'Spinning‚Ä¶');
      }

      const weighted = jitterWeights(BASE_PRIZES);
      const winner = pickWeighted(weighted);
      const order = shuffle(BASE_PRIZES);
      drawWheel(order);
      await animateToPrize(winner.id);

      const dateKey = (typeof getIrelandDateKey === 'function')
        ? getIrelandDateKey()
        : (new Date()).toISOString().slice(0,10);

      // ===== Atualiza hist√≥rico/points em mem√≥ria (como antes) =====
      if (typeof state !== 'undefined'){
        if (winner.type === 'points'){
          state.points = Number(state.points||0) + Number(winner.value||0);
          state.cashbackHistory.unshift({ date: dateKey, title:'Credit', delta:+Number(winner.value||0), detail:'Wheel' });
        } else if (winner.type === 'cash'){
          const pts = Math.round((Number(winner.value||0) / 0.5)); // ‚Ç¨20 => 40 pts
          state.points = Number(state.points||0) + pts;
          state.cashbackHistory.unshift({ date: dateKey, title:'Credit', delta:+pts, detail:'Wheel (+‚Ç¨20)' });
        } else if (winner.type === 'discount'){
          state.cashbackHistory.unshift({ date: dateKey, title:'Coupon', delta:0, detail:`${winner.value}% OFF (next purchase)` });
        } else if (winner.type === 'shipping'){
          state.cashbackHistory.unshift({ date: dateKey, title:'Coupon', delta:0, detail:'Free shipping (next purchase)' });
        } else if (winner.type === 'extra_spin'){
          // Extra spin fica s√≥ como informa√ß√£o visual por enquanto
          state.cashbackHistory.unshift({ date: dateKey, title:'Bonus', delta:0, detail:'Wheel (Extra spin)' });
        }
      }

           // ===== Sincroniza pr√™mio com o backend de rewards (j√° existia) =====
      try{
        const rApi = window.VW_API;
        if (rApi && rApi.apiJson && typeof state !== 'undefined'){
          if (winner.type === 'points'){
            const r = await rApi.creditPoints(Number(winner.value||0), 'wheel');
            if (r && typeof r.points === 'number') state.points = r.points;
          } else if (winner.type === 'cash'){
            const ptsAdded = Math.round((Number(winner.value||0) / 0.5));
            const r = await rApi.creditPoints(ptsAdded, 'wheel_cash');
            if (r && typeof r.points === 'number') state.points = r.points;
          } else if (winner.type === 'discount'){
            const r = await rApi.grantDiscount(Number(winner.value||0));
            const ad = r && (r.activeDiscount || r.active_discount);
            if (ad){
              state.activeDiscount = {
                id: ad.id ?? ad.discount_id ?? ad.discountId ?? null,
                percent: Number(ad.percent ?? winner.value ?? 0),
                expiresAt: ad.expiresAt || ad.expires_at || ad.expires || null,
              };
            }
          } else if (winner.type === 'shipping'){
            const r = await rApi.grantShipping();
            const sh = r && (r.activeShipping || r.active_shipping);
            if (sh){
              state.activeShipping = {
                id: sh.id ?? sh.shipping_id ?? sh.shippingId ?? null,
                expiresAt: sh.expiresAt || sh.expires_at || sh.expires || null,
              };
            }
          } else if (winner.type === 'extra_spin'){
            if (typeof rApi.grantExtraSpin === 'function'){
              await rApi.grantExtraSpin(1, 'wheel');
            }
          }
        }
      } catch(err){
        console.warn('Failed to sync prize with API:', err && err.message || err);
      }
      // Refresh spins/points from backend (authoritative), then render
      try{
        const rApi = window.VW_API;
        if (rApi && typeof rApi.loadRewardsStatus === 'function') await rApi.loadRewardsStatus();
      }catch(_){}
      try{ if (typeof scheduleResetTimers === 'function') scheduleResetTimers(); }catch(_){}
      if (typeof renderAll === 'function') renderAll();
      if (typeof setText === 'function') setText('spinResultMsg', `üéÅ ${winner.label}`);
    } finally {
      if (typeof spinning !== 'undefined') spinning = false;
      if (btn) btn.disabled = false;
    }
  };
})();
</script>

</body>
</html>
