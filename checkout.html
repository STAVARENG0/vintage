<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout</title>
<link rel="icon" href="data:,">
<link rel="shortcut icon" href="data:,">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* ===== VintageShop palette to match index.html ===== */
:root{
  --cream:#f6f1e7;
  --cream-2:#f3e9d8;
  --text:#2a2a2a;
  --muted:#6f6f6f;
  --olive:#6b7b2a;
  --mustard:#f1b332;
  --coral:#ff8e7f;
  --terracotta:#b33b2e;
  --card:#ffffff;
}

*{ box-sizing:border-box; margin:0; padding:0; font-family:'Poppins',system-ui,Arial,sans-serif; }
body{
  background: linear-gradient(180deg, var(--cream), var(--cream-2));
  color:var(--text);
  display:flex; justify-content:center; align-items:center;
  min-height:100vh; padding:24px;
}

/* Card container with vintage accents */
.checkout-card{
  background:var(--card);
  border:1px solid rgba(0,0,0,.06);
  border-radius:18px;
  box-shadow:0 10px 28px rgba(0,0,0,.08);
  max-width:760px; width:100%;
  padding:28px 24px;
}
.header{
  display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:12px;
}
.brand-mark{
  display:flex; align-items:center; gap:12px;
}
.brand-badge{
  width:46px; height:46px; border-radius:12px; background: #fff;
  border:2px solid var(--mustard);
  box-shadow:0 6px 14px rgba(0,0,0,.08);
  display:flex; align-items:center; justify-content:center;
  font-weight:900; color:var(--olive);
}
.header h1{
  font-size:22px; letter-spacing:.08em; text-transform:uppercase;
  font-weight:900; color:var(--terracotta);
}
.header small{ color:var(--muted); }

.divider{
  height:2px; background:linear-gradient(90deg,transparent,var(--olive),transparent); margin:12px 0 16px;
}

.content{
  display:grid; grid-template-columns: 1.2fr .8fr; gap:20px;
}
@media (max-width:900px){ .content{ grid-template-columns:1fr; } }

/* Items list */
.items{
  background:#fff;
  border:1px dashed rgba(0,0,0,.08);
  border-radius:14px;
  padding:14px;
}
.item{
  display:grid; grid-template-columns: 1fr auto; gap:12px;
  padding:10px 0;
  border-bottom:1px dashed rgba(0,0,0,.06);
}
.item:last-child{ border-bottom:none; }
.item-title{ font-size:14px; font-weight:600; color:#2a2a2a; }
.item-sub{ font-weight:800; color:var(--terracotta); }

.empty{
  color:var(--muted); text-align:center; padding:20px 8px;
}

/* Summary + Pay area */
.summary{
  background:#fff;
  border:1px solid rgba(0,0,0,.06);
  border-radius:14px;
  box-shadow:0 8px 18px rgba(0,0,0,.06);
  padding:16px;
}
.row{ display:flex; justify-content:space-between; align-items:center; margin:8px 0; font-size:14px; }
.row.total{ font-size:20px; font-weight:900; color:var(--olive); margin-top:8px; }
.badge{
  display:inline-block; padding:4px 10px; border-radius:9999px;
  background: linear-gradient(90deg, var(--mustard), var(--coral));
  color:#fff; font-weight:800; font-size:12px;
}

/* PayPal section */
#paypal-section{ margin-top:14px; }
#paypal-button-paypal, #paypal-button-card{ margin-bottom:10px; }
.helper{ margin-top:8px; font-size:13px; color:var(--muted); text-align:center; }

footer{ margin-top:16px; color:var(--muted); font-size:12px; text-align:center; }
.hidden{ display:none !important; }
</style>
</head>
<body>

<div class="checkout-card">
  <div class="header">
    <div class="brand-mark">
      <div class="brand-badge">VS</div>
      <div>
        <h1>Checkout</h1>
        <small class="muted">Review your order and pay securely</small>
      </div>
    </div>
    <span class="badge">VintageShop</span>
  </div>

  <div class="divider"></div>

  <div class="content">
    <section>
      <div class="items" id="cartList"></div>
    </section>

    <aside>
      <div class="summary">
        <div class="row"><span class="label">Products Subtotal</span><span class="value" id="subtotalValue">€ 0.00</span></div>
        <div class="row"><span class="label" id="shippingLabel">Shipping</span><span class="value" id="shippingValue">€ 0.00</span></div>
        <div class="row total">Total: € <span id="totalAmount">0.00</span></div>

        <div id="paypal-section">
          <div id="paypal-button-paypal"></div>
          <div id="paypal-button-card"></div>
          <div id="helperMsg" class="helper hidden">Add products to your cart to enable payment.</div>
        </div>
      </div>
    </aside>
  </div>

  <footer>© <span id="year"></span> VintageShop</footer>
</div>

<!-- PayPal SDK with the user's API key -->
<script src="https://www.paypal.com/sdk/js?client-id=AfTde7kvXeDpijvvMVxUcfb7b-XIQgWMnQ8W2rcUd8PX5wyHAddc-Xf0_VG_wLUVl0dNw_9HXAzpo6dt&currency=EUR&intent=capture&commit=true&locale=en_IE&components=buttons,funding-eligibility&enable-funding=card"></script>

<script>
const CART_KEY='hs_cart';
const SHIP_KEY='hs_shipping';

document.getElementById('year').textContent = new Date().getFullYear();
function fmtEUR(n){ return '€ ' + Number(n).toFixed(2); }

function getShipping(){
  let data=null;
  try{ data = JSON.parse(localStorage.getItem(SHIP_KEY) || 'null'); }catch(e){ data=null; }
  if(data && typeof data.amount === 'number'){ return data; }
  const q = new URLSearchParams(location.search).get('shipping');
  const qNum = q !== null ? Number(q) : NaN;
  if(!Number.isNaN(qNum)){
    return { amount: qNum, label: qNum === 10 ? 'Tracked (€10)' : (qNum === 7 ? 'No tracked (€7)' : 'Shipping'), ts: Date.now() };
  }
  return { amount: 0, label: 'Shipping', ts: Date.now() };
}

let cart=[]; try{ cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]'); }catch(e){ cart=[]; }

function renderSummary(){
  const list = document.getElementById('cartList');
  let subtotal = 0;
  if(!cart.length){
    list.innerHTML = '<p class="empty">Your cart is empty.</p>';
  }else{
    list.innerHTML = cart.map(item=>{
      const qty = Number(item.qty)||0;
      const price = Number(item.price)||0;
      const sub = qty*price; subtotal += sub;
      return `<div class="item">
                <div class="item-title">${qty}× ${item.title}</div>
                <div class="item-sub">${fmtEUR(sub)}</div>
              </div>`;
    }).join('');
  }
  const ship = getShipping();
  document.getElementById('subtotalValue').textContent = fmtEUR(subtotal);
  document.getElementById('shippingLabel').textContent = ship.label || 'Shipping';
  document.getElementById('shippingValue').textContent = fmtEUR(ship.amount || 0);

  // Regra: não permitir pagar apenas frete. Se subtotal = 0, esconder botões e mostrar helper.
  let effectiveTotal = 0;
  const helper = document.getElementById('helperMsg');
  const btnPP = document.getElementById('paypal-button-paypal');
  const btnCard = document.getElementById('paypal-button-card');

  if(subtotal > 0){
    effectiveTotal = subtotal + Number(ship.amount||0);
    helper.classList.add('hidden');
    btnPP.classList.remove('hidden');
    btnCard.classList.remove('hidden');
  }else{
    effectiveTotal = 0;
    helper.classList.remove('hidden');
    btnPP.classList.add('hidden');
    btnCard.classList.add('hidden');
  }
  document.getElementById('totalAmount').textContent = effectiveTotal.toFixed(2);
  return { subtotal, shipping: Number(ship.amount||0), total: effectiveTotal };
}

const state = renderSummary();

function commonConfig(){
  return {
    onClick: function(data, actions){
      const { subtotal } = renderSummary();
      if(subtotal <= 0){
        alert('Please add products before paying.');
        return actions.reject();
      }
      return actions.resolve();
    },
    createOrder: function(data, actions){
      const { subtotal, shipping, total } = renderSummary();
      if(subtotal <= 0){ throw new Error('Empty subtotal'); }
      return actions.order.create({
        purchase_units:[{ amount:{ value: total.toFixed(2), currency_code:'EUR' }, description:'VintageShop Order' }]
      });
    },
    onApprove: function(data, actions){
      return actions.order.capture().then(function(details){
        alert('✅ Payment completed by ' + (details?.payer?.name?.given_name || 'customer') + '!');
        localStorage.removeItem(CART_KEY);
        document.getElementById('cartList').innerHTML = '<p style="color:var(--olive);text-align:center;">Payment Approved!</p>';
        document.getElementById('subtotalValue').textContent = fmtEUR(0);
        document.getElementById('shippingValue').textContent = fmtEUR(0);
        document.getElementById('totalAmount').textContent = '0.00';
        document.getElementById('paypal-button-paypal').classList.add('hidden');
        document.getElementById('paypal-button-card').classList.add('hidden');
      });
    },
    onError: function(err){ console.error('PayPal error:', err); alert('❌ There was an issue with PayPal Checkout. Please try again.'); }
  };
}

if(typeof paypal !== 'undefined' && state.subtotal > 0){
  const btnPayPal = paypal.Buttons(Object.assign({}, commonConfig(), {
    fundingSource: paypal.FUNDING.PAYPAL,
    style:{ layout:'vertical', color:'gold', shape:'pill', label:'paypal', height:45 }
  }));
  if(btnPayPal.isEligible()) btnPayPal.render('#paypal-button-paypal');

  const btnCard = paypal.Buttons(Object.assign({}, commonConfig(), {
    fundingSource: paypal.FUNDING.CARD,
    style:{ layout:'vertical', color:'black', shape:'pill', label:'pay', height:45 }
  }));
  if(btnCard.isEligible()) btnCard.render('#paypal-button-card');
}
</script>

</body>
</html>
