<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout</title>
<link rel="icon" href="data:,">
<link rel="shortcut icon" href="data:,">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --cream:#f6f1e7;
  --cream-2:#f3e9d8;
  --text:#2a2a2a;
  --muted:#6f6f6f;
  --olive:#6b7b2a;
  --mustard:#f1b332;
  --coral:#ff8e7f;
  --terracotta:#b33b2e;
  --card:#ffffff;
}
*{ box-sizing:border-box; margin:0; padding:0; font-family:'Poppins',sans-serif; }
body{
  background: linear-gradient(180deg, var(--cream), var(--cream-2));
  color:var(--text);
  display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px;
}
.checkout-card{
  background:var(--card);
  border:1px solid rgba(0,0,0,.06);
  border-radius:18px;
  box-shadow:0 10px 28px rgba(0,0,0,.08);
  max-width:660px; width:100%; padding:28px 22px; text-align:center;
}
.logo{
  width:220px; border-radius:16px; border:2px solid var(--mustard);
  box-shadow:0 10px 24px rgba(0,0,0,.10);
  margin:0 auto 14px;
  display:block;
}
h1{ color:var(--terracotta); font-size:22px; margin-bottom:12px; text-transform:uppercase; letter-spacing:.06em; }
.summary{ margin:18px 0; }
.row{ display:flex; justify-content:space-between; align-items:center; margin:8px 0; font-size:14px; }
.row.total{ font-size:20px; font-weight:900; color:var(--olive); margin-top:12px; }
.items{ text-align:left; margin:10px 0 6px; }
.item{ display:flex; justify-content:space-between; gap:12px; margin:6px 0; }
.item-title{ font-size:14px; font-weight:600; color:#2a2a2a; }
.item-sub{ font-weight:800; color:var(--terracotta); }
#paypal-section{ margin-top:16px; }
#paypal-button-paypal, #paypal-button-card{ margin-bottom:12px; }
.helper{ margin-top:12px; font-size:13px; color:var(--muted); }
footer{ margin-top:16px; color:var(--muted); font-size:12px; }
.hidden{ display:none !important; }

.discount-note{
  margin:6px 0 0;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.06);
  background: #fff9f4;
  font-size:13px;
  color:var(--text);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.discount-note .left{ font-weight:700; }
.discount-note .right{ font-weight:900; color:var(--terracotta); white-space:nowrap; }
.discount-note .meta{ font-weight:600; color:var(--muted); font-size:12px; margin-left:8px; }

</style>
</head>
<body>

<div class="checkout-card">
<img src="LOGO.png" alt="Checkout" class="logo">
  <h1>Checkout</h1>
  <a class="policy-btn" href="return-refund-policy.html" aria-label="Return & Refund Policy" style="display:inline-block;margin:6px 0 16px;background: var(--terracotta);color:#fff;padding:8px 12px;border-radius:999px;font-weight:700;font-size:13px;text-decoration:none;box-shadow: 0 6px 16px rgba(0,0,0,.12);">Return Policy</a>

  <div class="items" id="cartList"></div>
  <div id="discountBox"></div>

  <div class="summary">
    <div class="row"><span class="label">Products Subtotal</span><span class="value" id="subtotalValue">€ 0.00</span></div>
    <div class="row"><span class="label" id="shippingLabel">Shipping</span><span class="value" id="shippingValue">€ 0.00</span></div>
    <div class="row total">Total: € <span id="totalAmount">0.00</span></div>
  </div>

  <div id="paypal-section">
    <div id="paypal-button-paypal"></div>
    <div id="paypal-button-card"></div>
    <div id="helperMsg" class="helper hidden">Add products to your cart to enable payment.</div>
  </div>

  <footer>© <span id="year"></span> Checkout</footer>
</div>

<script src="https://www.paypal.com/sdk/js?client-id=AfTde7kvXeDpijvvMVxUcfb7b-XIQgWMnQ8W2rcUd8PX5wyHAddc-Xf0_VG_wLUVl0dNw_9HXAzpo6dt&currency=EUR&intent=capture&commit=true&locale=en_IE&components=buttons,funding-eligibility&enable-funding=card"></script>
<script>
// ===== Keys used by the site =====
const CART_KEYS_ORDER = ['vw_cart','hs_cart','cart','v_cart','cartItems','cart_items','cartData'];
const BASE_SHIPPING_EUR = 9;
const CHECKOUT_PAYLOAD_KEY = 'vw_checkout_payload';

// Rewards: dados enviados pelo carrinho (localStorage + URL)
function readCheckoutPayload(){
  try{
    const raw = localStorage.getItem(CHECKOUT_PAYLOAD_KEY);
    if(!raw) return null;
    const parsed = JSON.parse(raw);
    if(!parsed || typeof parsed !== 'object') return null;
    return parsed;
  }catch(e){
    return null;
  }
}

function readRewardsFromUrl(){
  const params = new URLSearchParams(window.location.search);
  const free = params.get('free_shipping') === '1' || params.get('free_shipping') === 'true';
  const points = Number(params.get('points_used') || 0) || 0;
  const discount = Number(params.get('discount_percent') || 0) || 0;
  return { freeShippingFlag: free, pointsFromUrl: points, discountFromUrl: discount };
}

function getEffectiveRewards(){
  const payload = readCheckoutPayload();
  const urlR = readRewardsFromUrl();

  const paySubtotal = Number(payload && payload.pay_subtotal != null ? payload.pay_subtotal : 0) || 0;
  const freeShipping = (payload && payload.free_shipping === true) || urlR.freeShippingFlag;
  const pointsUsed = Number(
    (payload && payload.points_used != null ? payload.points_used : urlR.pointsFromUrl) || 0
  ) || 0;
  const discountPercent = Number(
    (payload && payload.discount_percent != null ? payload.discount_percent : urlR.discountFromUrl) || 0
  ) || 0;

  return { paySubtotal, freeShipping, pointsUsed, discountPercent };
}

// Year
document.getElementById('year').textContent = new Date().getFullYear();

function fmtEUR(n){ return '€ ' + Number(n).toFixed(2); }
function readJSON(key){ try{ return JSON.parse(localStorage.getItem(key)); }catch(e){ return null; } }

// Cart: accepts ?cart=... (from index redirect) OR localStorage (first key with non-empty array)
function readCart(){
  // 1) URL param (?cart=...) has priority (index.html uses this)
  try{
    const params = new URLSearchParams(window.location.search);
    const cartParam = params.get('cart');
    if(cartParam){
      const decoded = decodeURIComponent(cartParam);
      const parsed = JSON.parse(decoded);
      if(Array.isArray(parsed) && parsed.length){
        // Persist to vw_cart for consistency across pages
        try{ localStorage.setItem('vw_cart', JSON.stringify(parsed)); }catch(_){}
        return parsed;
      }
    }
  }catch(e){ /* ignore */ }

  // 2) localStorage: first key that contains a non-empty array
  for(const k of CART_KEYS_ORDER){
    const v = readJSON(k);
    if(Array.isArray(v) && v.length) return v;
  }
  return [];
}

// Shipping: fixed (Delivery only)
function computeShipping(){
  return { amount: BASE_SHIPPING_EUR, label: `Shipping (€${BASE_SHIPPING_EUR})` };
}

// Normalize cart items and PRESERVE the product id so PayPal/webhook can remove the correct product
function normalizeCart(arr){
  return (Array.isArray(arr) ? arr : []).map(item=>{
    const id = item?.id ?? item?.product?.id ?? item?.sku ?? item?.custom_id ?? null;
    const qty = Number(item?.qty ?? item?.quantity ?? 1) || 0;
    const price = Number(item?.price ?? item?.unitPrice ?? 0) || 0;
    const title = item?.title ?? item?.name ?? item?.product?.title ?? 'Product';
    return { id: id != null ? String(id) : null, qty, price, title };
  }).filter(x => x.id && x.qty > 0 && x.price >= 0);
}

let cart = normalizeCart(readCart());

function renderSummary(){
  const list = document.getElementById('cartList');
  const discountBox = document.getElementById('discountBox');
  let baseSubtotal = 0;
  if(!cart.length){
    list.innerHTML = '<p style="color:#6f6f6f;text-align:center;">Your cart is empty.</p>';
  }else{
    list.innerHTML = cart.map(item=>{
      const sub = item.qty * item.price; baseSubtotal += sub;
      return `<div class="item">
                <div class="item-title">${item.qty}× ${item.title}</div>
                <div class="item-sub">${fmtEUR(sub)}</div>
              </div>`;
    }).join('');
  }

  const rewards = getEffectiveRewards();

  let subtotal = baseSubtotal;
  if (rewards && rewards.paySubtotal > 0 && rewards.paySubtotal <= baseSubtotal){
    subtotal = rewards.paySubtotal;
  }

  const shipInfo = computeShipping();
  const baseShippingAmount = Number(shipInfo.amount || 0);
  let shippingAmount = baseShippingAmount;
  if (rewards && rewards.freeShipping){
    shippingAmount = 0;
  }

  // Discount amount (items discount + free shipping) for UI
  const discountAmount = Math.max(0, (baseSubtotal + baseShippingAmount) - (subtotal + shippingAmount));
  if(discountBox){
    if(discountAmount > 0){
      const parts = [];
      if(rewards && rewards.discountPercent > 0) parts.push(`${rewards.discountPercent}% off`);
      if(rewards && rewards.pointsUsed > 0) parts.push(`${rewards.pointsUsed} points`);
      if(rewards && rewards.freeShipping) parts.push(`free shipping`);
      const meta = parts.length ? `<span class="meta">(${parts.join(' + ')})</span>` : '';
      discountBox.innerHTML = `<div class="discount-note">
        <div class="left">Discount applied ${meta}</div>
        <div class="right">- ${fmtEUR(discountAmount).replace('€ ','€ ')}</div>
      </div>`;
    }else{
      discountBox.innerHTML = '';
    }
  }

  document.getElementById('subtotalValue').textContent = fmtEUR(subtotal);
  document.getElementById('shippingLabel').textContent = shipInfo.label || 'Shipping';
  document.getElementById('shippingValue').textContent = fmtEUR(shippingAmount);

  let effectiveTotal = 0;
  const helper = document.getElementById('helperMsg');
  const payBtn = document.getElementById('paypal-button-paypal');
  const cardBtn = document.getElementById('paypal-button-card');

  if(subtotal > 0){
    effectiveTotal = subtotal + shippingAmount;
    helper.classList.add('hidden');
    payBtn.classList.remove('hidden');
    cardBtn.classList.remove('hidden');
  }else{
    effectiveTotal = 0;
    helper.classList.remove('hidden');
    payBtn.classList.add('hidden');
    cardBtn.classList.add('hidden');
  }

  document.getElementById('totalAmount').textContent = effectiveTotal.toFixed(2);
  return { baseSubtotal, baseShippingAmount, subtotal, shipping: shippingAmount, total: effectiveTotal, rewards };
}

const state = renderSummary();

function commonConfig(){
  return {
    onClick: function(data, actions){
      const { subtotal } = renderSummary();
      if(subtotal <= 0){
        alert('Please add products before paying.');
        return actions.reject();
      }
      return actions.resolve();
    },
    createOrder: async function(data, actions){
      const { subtotal, shipping, total } = renderSummary();
      if(subtotal <= 0){ throw new Error('Empty subtotal'); }

      // Safety: ensure every cart item has an id
      const missingId = cart.find(i => !i.id);
      if(missingId){ throw new Error('Cart item missing id'); }
      const shippingPref = 'GET_FROM_FILE';

      // 1) Read vw_checkout_payload from localStorage
      let payload = null;
      try{
        const raw = localStorage.getItem('vw_checkout_payload');
        payload = raw ? JSON.parse(raw) : null;
      }catch(e){
        payload = null;
      }

      // 2) Identify buyer for rewards (logged-in -> user id, guest -> email if available)
      let userRefId = 'guest:' + Date.now();

      try{
        const r = await fetch('https://clientes.vintage-clothes.ie/rewards/status', { credentials: 'include' });
        if(r.ok){
          const me = await r.json();
          if(me && me.user && me.user.id){
            userRefId = 'user:' + String(me.user.id);
          }else if(me && me.user && me.user.email){
            userRefId = 'email:' + String(me.user.email).trim().toLowerCase();
          }
        }
      }catch(e){}

      // fallback pro payload
      if(userRefId.startsWith('guest:') && payload){
        if(payload.user_id) userRefId = 'user:' + String(payload.user_id);
        else if(payload.email) userRefId = 'email:' + String(payload.email).trim().toLowerCase();
        else if(payload.user_email) userRefId = 'email:' + String(payload.user_email).trim().toLowerCase();
        else if(payload.customer_email) userRefId = 'email:' + String(payload.customer_email).trim().toLowerCase();
      }

// 3) Build items[] with sku = product id
      const toCents = (v) => Math.round(Number(v || 0) * 100);
      const items = cart.map(i => {
        const qty = parseInt(i.qty, 10) || 1;
        const unitCents = toCents(i.price);
        return {
          sku: String(i.id),
          name: String(i.title || 'Product'),
          unit_amount: { currency_code: 'EUR', value: (unitCents / 100).toFixed(2) },
          quantity: String(qty)
        };
      });

      
// 4) Build a PayPal breakdown that EXPLICITLY carries discounts
// item_total must equal sum(unit_amount * quantity)
const itemsTotalCents = items.reduce((sum, it) => {
  return sum + (toCents(it.unit_amount.value) * (parseInt(it.quantity, 10) || 0));
}, 0);

// Base shipping (Delivery only) BEFORE free-shipping reward
const baseShippingCents = toCents(computeShipping().amount || 0);

// Applied amounts (after rewards)
const subtotalCents = toCents(subtotal);
const shippingAppliedCents = toCents(shipping);
const totalCents = toCents(total);

// Discounts
let discountCents = Math.max(0, itemsTotalCents - subtotalCents);
const shippingDiscountCents = Math.max(0, baseShippingCents - shippingAppliedCents);

// Ensure amount.value matches breakdown math (handle rounding edge-cases)
let calcTotalCents = itemsTotalCents + baseShippingCents - shippingDiscountCents - discountCents;
const diffCents = totalCents - calcTotalCents;
if(diffCents > 0){
  // add a small handling to reconcile
  // (keeps discount fields as intended)
}else if(diffCents < 0){
  // increase discount to reconcile
  discountCents += Math.abs(diffCents);
}

const breakdown = {
  item_total: { currency_code: 'EUR', value: (itemsTotalCents / 100).toFixed(2) },
  shipping:   { currency_code: 'EUR', value: (baseShippingCents / 100).toFixed(2) }
};
if(shippingDiscountCents > 0){
  breakdown.shipping_discount = { currency_code: 'EUR', value: (shippingDiscountCents / 100).toFixed(2) };
}
if(discountCents > 0){
  breakdown.discount = { currency_code: 'EUR', value: (discountCents / 100).toFixed(2) };
}
if(diffCents > 0){
  breakdown.handling = { currency_code: 'EUR', value: (diffCents / 100).toFixed(2) };
}

// Compact metadata for webhook/painel (PayPal stores purchase_units.custom_id)
const totalDiscountCents = discountCents + shippingDiscountCents;
const meta = [
  'vw',
  `d=${(totalDiscountCents/100).toFixed(2)}`,
  `dp=${(rewards && rewards.discountPercent) ? Number(rewards.discountPercent).toFixed(2) : '0'}`,
  `pts=${(rewards && rewards.pointsUsed) ? parseInt(rewards.pointsUsed,10) : 0}`,
  `fs=${(rewards && rewards.freeShipping) ? 1 : 0}`
].join('|').slice(0,127);
return actions.order.create({
        intent: 'CAPTURE',
        application_context: {
          shipping_preference: shippingPref,
          user_action: 'PAY_NOW',
          locale: 'en-IE'
        },
        purchase_units: [{
          reference_id: userRefId,
          custom_id: meta,
          description: cart[0].title,
          amount: {
            currency_code: 'EUR',
            value: (totalCents / 100).toFixed(2),
            breakdown: breakdown
          },
          items: items
        }]
      });
    },
    onApprove: function(data, actions){
      return actions.order.capture().then(function(details){
        alert('✅ Payment completed by ' + (details?.payer?.name?.given_name || 'customer') + '!');
        // clear cart
        CART_KEYS_ORDER.forEach(k=>localStorage.removeItem(k));
        document.getElementById('cartList').innerHTML = '<p style="color:var(--olive);text-align:center;">Payment Approved!</p>';
        document.getElementById('subtotalValue').textContent = fmtEUR(0);
        document.getElementById('shippingValue').textContent = fmtEUR(0);
        document.getElementById('totalAmount').textContent = '0.00';
        document.getElementById('paypal-button-paypal').classList.add('hidden');
        document.getElementById('paypal-button-card').classList.add('hidden');
      });
    },
    onError: function(err){ console.error('PayPal error:', err); alert('❌ There was an issue with PayPal Checkout. Please try again.'); }
  };
}

// Render PayPal buttons when subtotal > 0
if(typeof paypal !== 'undefined' && state.subtotal > 0){
  const btnPayPal = paypal.Buttons(Object.assign({}, commonConfig(), {
    fundingSource: paypal.FUNDING.PAYPAL,
    style:{ layout:'vertical', color:'gold', shape:'pill', label:'paypal', height:45 }
  }));
  if(btnPayPal.isEligible()) btnPayPal.render('#paypal-button-paypal');

  const btnCard = paypal.Buttons(Object.assign({}, commonConfig(), {
    fundingSource: paypal.FUNDING.CARD,
    style:{ layout:'vertical', color:'black', shape:'pill', label:'pay', height:45 }
  }));
  if(btnCard.isEligible()) btnCard.render('#paypal-button-card');
}
</script>

</body>
</html>
