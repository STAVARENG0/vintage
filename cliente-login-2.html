<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vintage • Customer Login</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --cream:#f6f1e7;
      --cream-2:#f3e9d8;

      --text:#2b2723;
      --muted:#7c6f63;

      --mustard:#f1b332;
      --coral:#ff8e7f;
      --terracotta:#b33b2e;

      --card:#ffffff;
      --radius: 22px;

      --gold:#D4AF37;
      --gold-soft: rgba(212,175,55,.55);

      --btn-bg: rgba(255,255,255,.88);
      --btn-text: #3b2206;

      --shadow: 0 18px 42px rgba(0,0,0,.28);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(135deg,#fdf4e3,#f1dfc2,#e3c395);
      min-height:100vh;
      padding: 22px 10px 60px;
    }

    .page{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 16px;
    }

    /* Top logo */
    .brandLogo{
      width: min(860px, 92vw);
      height: auto;
      display:block;
      margin: 0 auto;
      border-radius: 22px;
      filter:
        drop-shadow(0 0 2px rgba(255,255,255,0.95))
        drop-shadow(0 0 12px rgba(255,255,255,0.65))
        drop-shadow(0 14px 34px rgba(0,0,0,.24));
    }

    /* Card */
    .card{
      width: min(560px, 100%);
      padding: 22px 18px 18px;
      border-radius: 28px;

      background: linear-gradient(135deg,rgba(253,244,227,0.10),rgba(241,223,194,0.08),rgba(227,195,149,0.14));
      backdrop-filter: saturate(120%) blur(6px);
      -webkit-backdrop-filter: saturate(120%) blur(6px);

      border: 1px solid rgba(212,175,55,.55);
      box-shadow: var(--shadow), 0 0 26px rgba(212,175,55,.18);
    }

    .cardTitle{
      margin: 2px 0 8px;
      text-align:center;
      font-size: 20px;
      font-weight: 800;
      letter-spacing: .06em;
      text-transform: uppercase;
    }

    label{
      display:block;
      margin-top:14px;
      margin-bottom:7px;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.35px;
    }

    input{
      width:100%;
      padding: 12px 13px;
      border-radius: 14px;
      border:1px solid var(--gold-soft);
      background: rgba(255,255,255,.90);
      color: var(--text);
      outline:none;
      box-shadow: 0 10px 26px rgba(0,0,0,.08);
      transition: border-color .15s ease, box-shadow .15s ease, filter .15s ease;
    }
    input:focus{
      border-color: rgba(212,175,55,.85);
      box-shadow: 0 0 0 4px rgba(212,175,55,.22), 0 10px 26px rgba(0,0,0,.08);
      filter: brightness(1.01);
    }

    .btn{
      width:100%;
      padding: 12px 14px;
      border-radius: 999px;

      background: var(--btn-bg);
      color: var(--btn-text);
      border: 1px solid var(--gold-soft);
      box-shadow: 0 10px 26px rgba(0,0,0,.10);

      font-weight: 800;
      letter-spacing: .35px;
      cursor:pointer;
      margin-top: 14px;
      transition: transform .08s ease, filter .12s ease, background .15s ease, border-color .15s ease;
    }
    .btn:hover{
      filter: brightness(1.03);
      transform: translateY(-1px);
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.95), transparent 60%),
        linear-gradient(120deg, rgba(212,175,55,.22), rgba(240,180,59,.22));
      border-color: rgba(212,175,55,.75);
    }
    .btn:active{ transform: translateY(0); filter: brightness(.99); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; filter:none; transform:none; }

    .btn.secondary{
      background: rgba(255,255,255,.78);
      font-weight:700;
    }

    .btn.google{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
    }
    .gBadge{
      width: 22px;
      height: 22px;
      border-radius: 7px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.10);
      color: #111;
      line-height: 1;
      flex: 0 0 auto;
    }

    .msg{
      display:none;
      margin-top: 12px;
      font-size: 12px;
      line-height: 1.35;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.55);
      color: var(--text);
    }
    .msg.ok{border-color: rgba(68,163,111,.35); background: rgba(68,163,111,.10)}
    .msg.bad{border-color: rgba(185,48,48,.35); background: rgba(185,48,48,.10)}

    /* Modal (Create account) */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modal.show{display:flex}

    .modalCard{
      width: min(920px, 100%);
      border-radius: 22px;
      background: #ffffff; /* solid */
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 22px 60px rgba(0,0,0,.50);
      overflow:hidden;
    }

    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.95), transparent 60%),
        linear-gradient(120deg, rgba(212,175,55,.25), rgba(240,180,59,.22));
      border-bottom: 1px solid rgba(0,0,0,.08);
    }
    .modalHeader h3{
      margin:0;
      font-size: 14px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--text);
    }
    .close{
      width:34px; height:34px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.95);
      color: var(--text);
      cursor:pointer;
      font-size: 18px;
      line-height: 1;
    }

    .modalBody{ padding: 14px 16px 18px; }

    .subtle{
      font-size:12px;
      color: var(--muted);
      margin: 0 0 12px;
      line-height: 1.45;
    }

    .step{ display:none; }
    .step.active{ display:block; }

    /* Password strength */
    .pwWrap{margin-top:10px}
    .pwMeter{
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.10);
      background: rgba(0,0,0,0.04);
      overflow:hidden;
    }
    .pwBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,92,92,0.9), rgba(240,180,59,0.9), rgba(68,163,111,0.9));
      transition: width .2s ease;
    }
    .pwLabel{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      flex-wrap: wrap;
    }
    .pwLabel b{color:var(--text)}

    .twoBtns{display:flex; gap:10px; margin-top:14px}
    .twoBtns .btn{margin-top:0}
    .twoBtns .btn.secondary{margin-top:0}

    .smallNote{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }


.linkBtn{
  background: none;
  border: none;
  padding: 0;
  margin: 0;
  font-size: 12px;
  font-weight: 800;
  color: var(--terracotta);
  cursor: pointer;
  text-decoration: underline;
}
.linkBtn:hover{ filter: brightness(1.08); }

    @media (max-width:520px){
      .twoBtns{ flex-direction:column; }
    }
  </style>
</head>
<body>

  <main class="page">
    <img class="brandLogo" src="LOGO.png" alt="Vintage Clothes shop logo" />

    <section class="card" aria-label="Login card">
      <h2 class="cardTitle">Log in</h2>

      <form id="loginForm">
        <label for="loginUser">Email or phone</label>
        <input id="loginUser" type="text" placeholder="" autocomplete="username" required />

        <label for="loginPassword">Password</label>
        <input id="loginPassword" type="password" placeholder="" autocomplete="current-password" required />

        <div class="smallNote" style="text-align:right; margin-top:10px">
          <button class="linkBtn" type="button" id="openForgot">Forgot password?</button>
        </div>

        <button class="btn" type="submit" id="loginBtn">LOG IN</button>

        <button class="btn google" type="button" id="googleLoginBtn" aria-label="Continue with Google">
          <span class="gBadge">G</span>
          Continue with Google
        </button>

        <button class="btn secondary" type="button" id="openRegister">Create account</button>

        <div class="msg" id="loginMsg"></div>
      </form>
    </section>
  </main>

  <!-- Create account modal -->
  <div class="modal" id="registerModal" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-label="Create account dialog">
      <div class="modalHeader">
        <h3>Create account</h3>
        <button class="close" id="closeRegister" aria-label="Close">×</button>
      </div>

      <div class="modalBody">
        <div class="subtle">
          Enter your details, choose a password, and confirm with a verification code (email or SMS).
        </div>

        <!-- STEP 1 -->
        <div class="step active" id="regStep1">
          <form id="registerForm">
            <label for="regName">Full name</label>
            <input id="regName" type="text" placeholder="" autocomplete="name" required />

            <label for="regContact">Email or phone (with country code)</label>
            <input id="regContact" type="text" placeholder="" autocomplete="email" required />
            <div class="smallNote" id="channelHint">
              We’ll send the code by <b>email</b> if it includes “@”, otherwise by <b>SMS</b>.
            </div>

            <label for="regPassword">Password (minimum 8)</label>
            <input id="regPassword" type="password" placeholder="" autocomplete="new-password" required />

            <label for="regPassword2">Confirm password</label>
            <input id="regPassword2" type="password" placeholder="" autocomplete="new-password" required />

            <div class="pwWrap">
              <div class="pwMeter"><div class="pwBar" id="pwBar"></div></div>
              <div class="pwLabel">
                <span>Strength: <b id="pwText">—</b></span>
                <span id="pwReq">Minimum: 8 chars • 1 lowercase • 1 UPPERCASE • 1 number • no spaces.</span>
              </div>
            </div>

            <button class="btn" id="startRegisterBtn" type="submit" disabled>Create account</button>
            <div class="msg" id="regMsg"></div>
          </form>
        </div>

        <!-- STEP 2 -->
        <div class="step" id="regStep2">
          <form id="verifyForm">
            <label for="regCode">Verification code</label>
            <input id="regCode" type="text" inputmode="numeric" placeholder="" required autocomplete="one-time-code" />
            <div class="smallNote" id="codeSentTo">We sent a code…</div>

            <div class="twoBtns">
              <button class="btn" type="submit">Confirm code</button>
              <button class="btn secondary" id="resendBtn" type="button">Resend</button>
            </div>

            <div class="msg" id="verifyMsg"></div>
          </form>
        </div>

      </div>
    </div>
  </div>


<!-- Forgot password modal -->
<div class="modal" id="forgotModal" aria-hidden="true">
  <div class="modalCard" role="dialog" aria-modal="true" aria-label="Forgot password dialog">
    <div class="modalHeader">
      <h3>Reset password</h3>
      <button class="close" id="closeForgot" aria-label="Close">×</button>
    </div>

    <div class="modalBody">
      <div class="subtle">
        Enter your email or phone. We’ll send a verification code so you can set a new password.
      </div>

      <!-- STEP 1 -->
      <div class="step active" id="fpStep1">
        <form id="fpStartForm">
          <label for="fpContact">Email or phone (with country code)</label>
          <input id="fpContact" type="text" placeholder="" autocomplete="username" required />
          <div class="smallNote" id="fpChannelHint">
            We’ll send the code by <b>email</b> if it includes “@”, otherwise by <b>SMS</b>.
          </div>

          <button class="btn" type="submit" id="fpSendBtn">Send code</button>
          <div class="msg" id="fpMsg1"></div>
        </form>
      </div>

      <!-- STEP 2 -->
      <div class="step" id="fpStep2">
        <form id="fpFinishForm">
          <label for="fpCode">Verification code</label>
          <input id="fpCode" type="text" inputmode="numeric" placeholder="" required autocomplete="one-time-code" />
          <div class="smallNote" id="fpCodeSentTo">We sent a code…</div>

          <label for="fpNewPassword">New password</label>
          <input id="fpNewPassword" type="password" placeholder="" autocomplete="new-password" required />

          <label for="fpNewPassword2">Confirm new password</label>
          <input id="fpNewPassword2" type="password" placeholder="" autocomplete="new-password" required />

          <div class="twoBtns">
            <button class="btn" type="submit" id="fpResetBtn">Change password</button>
            <button class="btn secondary" id="fpResendBtn" type="button">Resend</button>
          </div>

          <div class="msg" id="fpMsg2"></div>
        </form>
      </div>

    </div>
  </div>
</div>

<script>
// Backend URL (kept as-is)
const API_ROOT = "https://vintage-auth-server-production.up.railway.app";
const API_BASE = API_ROOT;


// Auth is handled via HttpOnly cookie (set by the backend).
// Frontend must NOT read or store the auth token in JS.

// Redirect after login / account verification (supports ?back=...)
const DEFAULT_REDIRECT_AFTER_LOGIN = "painel.html";
  function getRedirectTarget(){
  return DEFAULT_REDIRECT_AFTER_LOGIN; // sempre vai pro painel
}
const REDIRECT_AFTER_LOGIN = getRedirectTarget();



// Password rules
const MIN_PW_LEN = 8;

// ---------- Helpers ----------
const $ = (id) => document.getElementById(id);

function showMsg(el, text, kind){
  if(!el) return;
  el.textContent = text;
  el.className = "msg" + (kind ? " "+kind : "");
  el.style.display = "block";
}
function hideMsg(el){
  if(!el) return;
  el.style.display = "none";
  el.textContent = "";
  el.className = "msg";
}

function looksLikeEmail(v){ return (v || "").includes("@"); }

function normalizePhone(v){
  const raw = (v || "").trim();
  let out = raw.replace(/[^0-9+]/g, "");
  if(out.includes("+")) out = "+" + out.replace(/\+/g, "");
  return out;
}

function maskContact(v){
  const s = (v || "").trim();
  if(looksLikeEmail(s)){
    const parts = s.split("@");
    const u = parts[0] || "";
    const d = parts[1] || "";
    if(!u || !d) return s;
    const m = u.length <= 2 ? (u[0] + "*") : (u.slice(0,2) + "***");
    return `${m}@${d}`;
  }
  const p = normalizePhone(s);
  if(p.length <= 6) return p;
  return p.slice(0,4) + "***" + p.slice(-3);
}

function pwLabel(score){
  if(score <= 1) return "Very weak";
  if(score <= 2) return "Weak";
  if(score <= 3) return "Medium";
  if(score <= 4) return "Strong";
  return "Very strong";
}

function validatePassword(pw){
  const v = (pw || "");
  const hasLower = /[a-z]/.test(v);
  const hasUpper = /[A-Z]/.test(v);
  const hasNum   = /\d/.test(v);
  const hasSpec  = /[^A-Za-z0-9]/.test(v);
  const hasSpace = /\s/.test(v);
  const lenOk    = v.length >= MIN_PW_LEN;

  let points = 0;
  if(lenOk) points++;
  if(hasLower) points++;
  if(hasUpper) points++;
  if(hasNum) points++;
  if(hasSpec) points++;
  if(hasSpace && points > 0) points--;

  const ok = lenOk && hasLower && hasUpper && hasNum && !hasSpace;

  let msg = "";
  if(hasSpace) msg = "Password cannot contain spaces.";
  else if(!lenOk) msg = `Password must be at least ${MIN_PW_LEN} characters.`;
  else if(!hasLower) msg = "Add at least 1 lowercase letter.";
  else if(!hasUpper) msg = "Add at least 1 UPPERCASE letter.";
  else if(!hasNum)   msg = "Add at least 1 number.";

  return { ok, points, msg };
}

function pwScore(pw){ return validatePassword(pw).points; }


  async function api(path, { method="GET", body } = {}) {
  const token = sessionStorage.getItem("token") || localStorage.getItem("token");
  const headers = { "Content-Type": "application/json" };
  if (token) headers.Authorization = `Bearer ${token}`;

  const opts = { method, credentials: "include", headers };
  if (body) opts.body = JSON.stringify(body);

  const r = await fetch(API_BASE + path, opts);
  let data = null;
  try { data = await r.json(); } catch(_) {}

  if (!r.ok) {
    const err = (data && (data.message || data.error)) ? (data.message || data.error) : `Error ${r.status}`;
    throw new Error(err);
  }
  return data;
}




function redirectAfterLogin(){ window.location.href = REDIRECT_AFTER_LOGIN; }
// Se já estiver logado, entra direto no painel (MAS não quando veio de logout)
document.addEventListener("DOMContentLoaded", async () => {
  console.log("LOGIN PAGE OPENED:", location.href);

  const params = new URLSearchParams(location.search);
  console.log("PARAMS:", Object.fromEntries(params.entries()));

  if (params.get("logout") === "1" || params.get("reason") === "logout") {
  console.log("SKIP AUTO-REDIRECT (logout)");
  window.location.href = "https://vintage-clothes.ie/";
  return;
}


  try {
    const r = await fetch(API_BASE + "/user/me", { credentials: "include" });
    console.log("/user/me status:", r.status);
    if (r.ok) {
      console.log("AUTO-REDIRECT TO PANEL NOW");
      redirectAfterLogin();
    }
  } catch (e) {
    console.log("ERROR /user/me:", e);
  }
});




// ---------- Login ----------
$("loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  hideMsg($("loginMsg"));

  const user = $("loginUser").value.trim();
  const password = $("loginPassword").value;

  try{
    const isEmail = looksLikeEmail(user);
    const payload = isEmail ? { email: user, password } : { phone: normalizePhone(user), password };

    const loginPath = isEmail ? "/auth/login" : "/auth/login/phone";
    const r = await fetch(API_BASE + loginPath, {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    let data = null;
    try { data = await r.json(); } catch(_) {}

    if(!r.ok){
      const err = (data && (data.message || data.error)) ? (data.message || data.error) : `Error ${r.status}`;
      throw new Error(err);
    }

    showMsg($("loginMsg"), "✅ Logged in successfully!", "ok");
    setTimeout(redirectAfterLogin, 600);
  }catch(err){
    showMsg($("loginMsg"), "❌ " + err.message, "bad");
  }
});

// ---------- Google direct ----------
const googleLoginBtn = $("googleLoginBtn");
if(googleLoginBtn){
  googleLoginBtn.addEventListener("click", () => {
    window.location.href = API_BASE + "/auth/google";
  });
}

// ---------- Modal ----------
function switchStep(n){
  $("regStep1").classList.toggle("active", n === 1);
  $("regStep2").classList.toggle("active", n === 2);
}

function openModal(){
  $("registerModal").classList.add("show");
  $("registerModal").setAttribute("aria-hidden", "false");
  switchStep(1);
  hideMsg($("regMsg"));
  hideMsg($("verifyMsg"));
}

function closeModal(){
  $("registerModal").classList.remove("show");
  $("registerModal").setAttribute("aria-hidden", "true");
}

$("openRegister").addEventListener("click", openModal);
$("closeRegister").addEventListener("click", closeModal);
$("registerModal").addEventListener("click", (e) => {
  if(e.target === $("registerModal")) closeModal();
});



// Auto-open "Create account" when coming from Sign up link (?open=register or #register)
(function(){
  try{
    const params = new URLSearchParams(window.location.search);
    const open = (params.get("open") || "").toLowerCase();
    if(open === "register" || window.location.hash === "#register"){
      // small delay to ensure DOM is ready
      setTimeout(() => { try{ openModal(); }catch(_){} }, 50);
    }
  }catch(_){}
})();

// ---------- Create account + verify ----------
let lastRegister = null; // { mode: 'email'|'phone', name, contact, password }

$("regContact").addEventListener("input", () => {
  const v = $("regContact").value.trim();
  $("channelHint").innerHTML = looksLikeEmail(v)
    ? "We’ll send the code by <b>email</b>."
    : "We’ll send the code by <b>SMS</b> (include country code, e.g., +353...).";
  validateRegisterForm();
});

function updatePwUI(){
  const p = $("regPassword").value;
  const score = pwScore(p);
  $("pwBar").style.width = (Math.min(score, 5)/5*100) + "%";
  $("pwText").textContent = pwLabel(score);
}

function validateRegisterForm(){
  const name = $("regName").value.trim();
  const contact = $("regContact").value.trim();
  const p1 = $("regPassword").value;
  const p2 = $("regPassword2").value;

  const v = validatePassword(p1);
  const ok = !!name && !!contact && v.ok && p1 === p2;
  $("startRegisterBtn").disabled = !ok;
}

$("regName").addEventListener("input", validateRegisterForm);
$("regPassword").addEventListener("input", () => { updatePwUI(); validateRegisterForm(); });
$("regPassword2").addEventListener("input", validateRegisterForm);

updatePwUI();
validateRegisterForm();

$("registerForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  hideMsg($("regMsg"));

  const name = $("regName").value.trim();
  const contactRaw = $("regContact").value.trim();
  const password = $("regPassword").value;
  const password2 = $("regPassword2").value;

  const v = validatePassword(password);
  if(!v.ok) return showMsg($("regMsg"), "❌ " + v.msg, "bad");
  if(password !== password2) return showMsg($("regMsg"), "❌ Passwords do not match.", "bad");

  try{
    const isEmail = looksLikeEmail(contactRaw);
    const mode = isEmail ? "email" : "phone";
    const body = isEmail
      ? { email: contactRaw, password, name }
      : { phone: normalizePhone(contactRaw), password, name };

    await api(isEmail ? "/auth/register/email" : "/auth/register/phone", { method:"POST", body });

    lastRegister = { mode, name, contact: (isEmail ? contactRaw : normalizePhone(contactRaw)), password };
    $("codeSentTo").innerHTML = `We sent a code to <b>${maskContact(lastRegister.contact)}</b>.`;

    switchStep(2);
    showMsg($("verifyMsg"), "✅ Code sent! Enter it to finish creating your account.", "ok");
    $("regCode").focus();
  }catch(err){
    showMsg($("regMsg"), "❌ " + err.message, "bad");
  }
});

$("verifyForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  hideMsg($("verifyMsg"));

  if(!lastRegister) return showMsg($("verifyMsg"), "❌ Please complete step 1 first.", "bad");

  const code = $("regCode").value.trim();
  if(!code) return showMsg($("verifyMsg"), "❌ Enter the code.", "bad");

  try{
    const body = lastRegister.mode === "email"
      ? { email: lastRegister.contact, code }
      : { phone: lastRegister.contact, code };

    await api(lastRegister.mode === "email" ? "/auth/verify/email" : "/auth/verify/phone", { method:"POST", body });

    showMsg($("verifyMsg"), "✅ Account created successfully!", "ok");
    setTimeout(() => { closeModal(); redirectAfterLogin(); }, 700);
  }catch(err){
    showMsg($("verifyMsg"), "❌ " + err.message, "bad");
  }
});

$("resendBtn").addEventListener("click", async () => {
  hideMsg($("verifyMsg"));
  if(!lastRegister) return showMsg($("verifyMsg"), "❌ Please complete step 1 first.", "bad");

  try{
    const body = lastRegister.mode === "email"
      ? { email: lastRegister.contact, password: lastRegister.password, name: lastRegister.name }
      : { phone: normalizePhone(lastRegister.contact), password: lastRegister.password, name: lastRegister.name };

    await api(lastRegister.mode === "email" ? "/auth/register/email" : "/auth/register/phone", { method:"POST", body });
    showMsg($("verifyMsg"), "✅ Code resent!", "ok");
  }catch(err){
    showMsg($("verifyMsg"), "❌ " + err.message, "bad");
  }
});

// Close register modal with ESC
window.addEventListener("keydown", (e) => {
  if(e.key === "Escape" && $("registerModal").classList.contains("show")) closeModal();
});

// ---------- Forgot password (reset) ----------
function fpSwitchStep(n){
  $("fpStep1").classList.toggle("active", n === 1);
  $("fpStep2").classList.toggle("active", n === 2);
}

function openForgot(){
  $("forgotModal").classList.add("show");
  $("forgotModal").setAttribute("aria-hidden", "false");
  fpSwitchStep(1);
  $("fpContact").value = "";
  $("fpCode").value = "";
  $("fpNewPassword").value = "";
  $("fpNewPassword2").value = "";
  hideMsg($("fpMsg1"));
  hideMsg($("fpMsg2"));
}

function closeForgot(){
  $("forgotModal").classList.remove("show");
  $("forgotModal").setAttribute("aria-hidden", "true");
}

let lastForgotContact = null;

$("openForgot").addEventListener("click", openForgot);
$("closeForgot").addEventListener("click", closeForgot);
$("forgotModal").addEventListener("click", (e) => {
  if(e.target === $("forgotModal")) closeForgot();
});

$("fpContact").addEventListener("input", () => {
  const v = $("fpContact").value.trim();
  $("fpChannelHint").innerHTML = looksLikeEmail(v)
    ? "We’ll send the code by <b>email</b>."
    : "We’ll send the code by <b>SMS</b> (include country code, e.g., +353...).";
});

$("fpStartForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  hideMsg($("fpMsg1"));
  hideMsg($("fpMsg2"));

  const raw = $("fpContact").value.trim();
  if(!raw) return showMsg($("fpMsg1"), "❌ Enter your email or phone.", "bad");

  try{
    await api("/auth/password/reset/start", { method:"POST", body: { contact: raw } });

    lastForgotContact = looksLikeEmail(raw) ? raw.trim() : normalizePhone(raw);
    $("fpCodeSentTo").innerHTML = `We sent a code to <b>${maskContact(lastForgotContact)}</b>.`;

    fpSwitchStep(2);
    showMsg($("fpMsg2"), "✅ Code sent! Enter it and choose a new password.", "ok");
    $("fpCode").focus();
  }catch(err){
    showMsg($("fpMsg1"), "❌ " + err.message, "bad");
  }
});

$("fpFinishForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  hideMsg($("fpMsg2"));

  if(!lastForgotContact) return showMsg($("fpMsg2"), "❌ Start the reset first.", "bad");

  const code = $("fpCode").value.trim();
  const p1 = $("fpNewPassword").value;
  const p2 = $("fpNewPassword2").value;

  if(!code) return showMsg($("fpMsg2"), "❌ Enter the code.", "bad");

  const v = validatePassword(p1);
  if(!v.ok) return showMsg($("fpMsg2"), "❌ " + v.msg, "bad");
  if(p1 !== p2) return showMsg($("fpMsg2"), "❌ Passwords do not match.", "bad");

  try{
    await api("/auth/password/reset/finish", {
      method:"POST",
      body: { contact: lastForgotContact, code, newPassword: p1 }
    });

    showMsg($("fpMsg2"), "✅ Password updated! You can log in now.", "ok");
    setTimeout(() => { closeForgot(); }, 900);
  }catch(err){
    showMsg($("fpMsg2"), "❌ " + err.message, "bad");
  }
});

$("fpResendBtn").addEventListener("click", async () => {
  hideMsg($("fpMsg2"));
  if(!lastForgotContact) return showMsg($("fpMsg2"), "❌ Start the reset first.", "bad");

  try{
    await api("/auth/password/reset/start", { method:"POST", body: { contact: lastForgotContact } });
    showMsg($("fpMsg2"), "✅ Code resent!", "ok");
  }catch(err){
    showMsg($("fpMsg2"), "❌ " + err.message, "bad");
  }
});

// ESC should also close forgot modal
window.addEventListener("keydown", (e) => {
  if(e.key === "Escape" && $("forgotModal").classList.contains("show")) closeForgot();
});
</script>


</body>
</html>
